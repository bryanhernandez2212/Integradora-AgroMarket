<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro - AgroMarket</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/auth.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    
</head>
<body>
    <div class="auth-wrapper" id="authWrapper">
        <!-- Lado Izquierdo (Info) -->
        <div class="info-side" id="infoSide">
            <div class="info-content">
                <div class="logo-auth">
                    <i class="fas fa-leaf"></i>AgroMarket
                </div>
                <h2>¬°√önete a nuestra comunidad!</h2>
                <p>Conecta con productores locales y encuentra los mejores productos frescos del campo</p>
                <a href="/login" class="btn-switch">Ya tengo cuenta</a>
            </div>
        </div>

        <!-- Lado Derecho (Formulario) -->
        <div class="form-side">
            <div class="form-container" id="registerForm">
                <h1>Crear Cuenta</h1>
                <p class="form-subtitle">√önete a nuestra comunidad de compradores y vendedores</p>

            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="flash {{ category }}">
                            <i class="fas fa-{% if category == 'success' %}check-circle{% elif category == 'error' %}exclamation-circle{% elif category == 'warning' %}exclamation-triangle{% else %}info-circle{% endif %}"></i>
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <form method="POST" id="registerForm">
                <!-- Nombre Completo -->
                <div class="input-group">
                    <label for="nombre">Nombre Completo</label>
                    <input type="text" name="nombre" id="nombre" placeholder="Juan P√©rez" required minlength="4" autocomplete="name">
                </div>

                <!-- Correo Electr√≥nico -->
                <div class="input-group">
                    <label for="email">Correo Electr√≥nico</label>
                    <input type="email" name="email" id="email" placeholder="ejemplo@correo.com" required autocomplete="email">
                </div>

                <!-- Contrase√±a -->
                <div class="input-group">
                    <label for="password">Contrase√±a</label>
                    <input type="password" name="password" id="password" placeholder="M√≠nimo 6 caracteres" required minlength="6" autocomplete="new-password">
                    <i class="fas fa-eye toggle-password" id="togglePassword"></i>
                </div>

                <!-- Indicador de fuerza de contrase√±a -->
                <div class="password-strength" id="passwordStrength" style="display: none;">
                    <div class="strength-bar">
                        <div class="strength-fill" id="strengthFill"></div>
                    </div>
                    <ul id="passwordRequirements">
                        <li id="req-length">Al menos 6 caracteres</li>
                        <li id="req-letter">Contiene letras</li>
                        <li id="req-number">Contiene n√∫meros</li>
                    </ul>
                </div>

                <!-- Rol Inicial -->
                <div class="input-group">
                    <label for="rol">¬øC√≥mo quieres empezar?</label>
                    <select name="rol" id="rol" required>
                        <option value="">Selecciona tu rol inicial</option>
                        <option value="comprador">
                            üõí Comprador - Busco productos frescos
                        </option>
                        <option value="vendedor">
                            üå± Vendedor - Ofrezco mis productos
                        </option>
                    </select>
                    <small>
                        <i class="fas fa-info-circle"></i> 
                        Podr√°s agregar otros roles m√°s tarde desde tu perfil
                    </small>
                </div>

                <!-- Campos adicionales para vendedores -->
                <div id="vendedorFields" class="vendedor-fields" style="display: none;">
                    <!-- Nombre de la tienda -->
                    <div class="input-group">
                        <label for="nombre_tienda">Nombre de tu tienda o negocio</label>
                        <input type="text" name="nombre_tienda" id="nombre_tienda" placeholder="Ej: La Granja de Juan" maxlength="100">
                        <small>
                            <i class="fas fa-store"></i> 
                            Nombre con el que aparecer√°s como vendedor
                        </small>
                    </div>

                    <!-- Ubicaci√≥n con Google Maps Autocomplete -->
                    <div class="input-group">
                        <label for="ubicacion">Ubicaci√≥n</label>
                        <input type="text" name="ubicacion" id="ubicacion" placeholder="Empieza a escribir tu direcci√≥n..." maxlength="200" autocomplete="off">
                        <small>
                            <i class="fas fa-map-marker-alt"></i> 
                            ¬øD√≥nde vendes tus productos? (Autocompletado con Google Maps)
                        </small>
                        <input type="hidden" id="ubicacion_lat" name="ubicacion_lat">
                        <input type="hidden" id="ubicacion_lng" name="ubicacion_lng">
                        <input type="hidden" id="ubicacion_formatted" name="ubicacion_formatted">
                    </div>

                    <!-- Documento de verificaci√≥n -->
                    <div class="input-group">
                        <label for="documento_verificacion">
                            <i class="fas fa-file-upload"></i> Documento de Verificaci√≥n
                        </label>
                        <input type="file" name="documento_verificacion" id="documento_verificacion" accept="image/*,.pdf" required>
                        <small>
                            <i class="fas fa-info-circle"></i> 
                            Sube una identificaci√≥n oficial, RFC o comprobante de domicilio (JPG, PNG, PDF - m√°x. 5MB)
                        </small>
                        <div id="documento-preview" style="display: none; margin-top: 10px;">
                            <img id="documento-preview-img" src="" alt="Vista previa" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 2px solid #2ba656;">
                            <p id="documento-preview-nombre" style="margin-top: 5px; font-size: 0.9rem; color: #2ba656;"></p>
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn-primary" id="submitBtn">
                    <i class="fas fa-user-plus"></i> Crear mi Cuenta
                </button>
            </form>

                <div class="links">
                    <a href="{{ url_for('general.home') }}">
                        <i class="fas fa-home"></i> Volver al Inicio
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Google Maps Places API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCCm9SIv6WBmkejLHJ4X7WaTm8xf6DBpCo&libraries=places&language=es&region=MX" async defer></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="/static/js/firebase-config.js"></script>

    <script>
        console.log('üìÑ P√°gina de registro cargada (solo vista)');
        
        // Mostrar/ocultar contrase√±a
        const togglePassword = document.getElementById('togglePassword');
        const passwordInput = document.getElementById('password');

        if (togglePassword && passwordInput) {
            togglePassword.addEventListener('click', function() {
                const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput.setAttribute('type', type);
                this.classList.toggle('fa-eye');
                this.classList.toggle('fa-eye-slash');
            });
        }

        // Validador de fuerza de contrase√±a (solo visual)
        if (passwordInput) {
            passwordInput.addEventListener('input', function() {
                const password = this.value;
                const passwordStrength = document.getElementById('passwordStrength');
                const strengthFill = document.getElementById('strengthFill');
                
                if (password.length > 0) {
                    passwordStrength.style.display = 'block';
                } else {
                    passwordStrength.style.display = 'none';
                    return;
                }

                // Verificar requisitos
                const hasLength = password.length >= 6;
                const hasLetter = /[a-zA-Z]/.test(password);
                const hasNumber = /[0-9]/.test(password);

                // Actualizar indicadores visuales
                updateRequirement('req-length', hasLength);
                updateRequirement('req-letter', hasLetter);
                updateRequirement('req-number', hasNumber);

                // Calcular fuerza
                let strength = 0;
                if (hasLength) strength++;
                if (hasLetter) strength++;
                if (hasNumber) strength++;

                // Actualizar barra
                if (strengthFill) {
                    strengthFill.className = 'strength-fill';
                    if (strength === 1) {
                        strengthFill.classList.add('weak');
                    } else if (strength === 2) {
                        strengthFill.classList.add('medium');
                    } else if (strength === 3) {
                        strengthFill.classList.add('strong');
                    }
                }
            });
        }

        function updateRequirement(id, isValid) {
            const element = document.getElementById(id);
            if (element) {
                if (isValid) {
                    element.classList.add('valid');
                } else {
                    element.classList.remove('valid');
                }
            }
        }

        // Manejo real de registro con Firebase Auth
        const registerForm = document.getElementById('registerForm');
        const submitBtn = document.getElementById('submitBtn');
        if (registerForm) {
            registerForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                try {
                    // Validaciones b√°sicas
                    const nombre = document.getElementById('nombre')?.value?.trim();
                    const email = document.getElementById('email')?.value?.trim();
                    const password = document.getElementById('password')?.value || '';
                    const rol = document.getElementById('rol')?.value;
                    const nombreTienda = document.getElementById('nombre_tienda')?.value?.trim();
                    const ubicacion = document.getElementById('ubicacion')?.value?.trim();

                    if (!nombre || !email || !password || !rol) {
                        alert('Completa todos los campos');
                        return;
                    }

                    // Validaciones adicionales para vendedores
                    const documentoVerificacion = document.getElementById('documento_verificacion')?.files[0];
                    if (rol === 'vendedor') {
                        if (!nombreTienda || nombreTienda.length < 3) {
                            alert('El nombre de la tienda es obligatorio y debe tener al menos 3 caracteres');
                            document.getElementById('nombre_tienda')?.focus();
                            return;
                        }
                        if (!ubicacion || ubicacion.length < 5) {
                            alert('La ubicaci√≥n es obligatoria y debe tener al menos 5 caracteres');
                            document.getElementById('ubicacion')?.focus();
                            return;
                        }
                        if (!documentoVerificacion) {
                            alert('Debes subir un documento de verificaci√≥n (identificaci√≥n, RFC o comprobante de domicilio)');
                            document.getElementById('documento_verificacion')?.focus();
                            return;
                        }
                        // Validar tama√±o del archivo (5MB m√°ximo)
                        if (documentoVerificacion.size > 5 * 1024 * 1024) {
                            alert('El documento no debe exceder 5MB');
                            return;
                        }
                    }

                    if (submitBtn) {
                        submitBtn.disabled = true;
                        submitBtn.textContent = 'Creando cuenta...';
                    }

                    // Inicializar Firebase si hace falta
                    if (typeof firebase === 'undefined') throw new Error('Firebase no cargado');
                    if (!window.firebaseConfig) throw new Error('Config de Firebase no disponible');
                    if (firebase.apps.length === 0) firebase.initializeApp(window.firebaseConfig);

                    const auth = firebase.auth();
                    const db = firebase.firestore();
                    const storage = firebase.storage();

                    // Crear cuenta
                    const cred = await auth.createUserWithEmailAndPassword(email, password);
                    const user = cred.user;

                    // Actualizar displayName
                    await user.updateProfile({ displayName: nombre });

                    // Si es vendedor, NO crear el usuario en 'usuarios' todav√≠a, solo guardar la solicitud
                    if (rol === 'vendedor') {
                        // Verificar si ya existe una solicitud previa por correo (evita duplicados al eliminar/crear cuentas)
                        try {
                            const existentesSnap = await db.collection('solicitudes_vendedores')
                                .where('email', '==', email)
                                .limit(3)
                                .get();
                            if (!existentesSnap.empty) {
                                let existePendienteOAprobada = false;
                                let docAntiguoId = null;
                                existentesSnap.forEach(d => {
                                    const est = (d.data().estado || 'pendiente').toLowerCase();
                                    if (est === 'pendiente' || est === 'aprobada') {
                                        existePendienteOAprobada = true;
                                    }
                                    docAntiguoId = d.id; // mant√©n el √∫ltimo para limpieza
                                });
                                if (existePendienteOAprobada) {
                                    alert('Ya existe una solicitud asociada a este correo. Si fue rechazada, intenta con otro correo o contacta al administrador.');
                                    try { await auth.signOut(); } catch(e) {}
                                    window.location.href = '/auth/login';
                                    return;
                                } else if (docAntiguoId) {
                                    // Si existe pero est√° rechazada u obsoleta, eliminar para reintentar limpio
                                    try { await db.collection('solicitudes_vendedores').doc(docAntiguoId).delete(); } catch(e) { console.warn('No se pudo limpiar solicitud antigua:', e); }
                                }
                            }
                        } catch (consultaError) {
                            console.warn('No se pudo validar solicitudes existentes por email:', consultaError);
                        }

                        // Subir documento de verificaci√≥n primero
                        let documentoUrl = null;
                        if (documentoVerificacion) {
                            if (submitBtn) {
                                submitBtn.textContent = 'Subiendo documento...';
                            }
                            try {
                                const nombreArchivo = `verificaciones_vendedores/${user.uid}/documento_${Date.now()}_${documentoVerificacion.name.replace(/\s+/g, '_')}`;
                                const storageRef = storage.ref(nombreArchivo);
                                const metadata = {
                                    contentType: documentoVerificacion.type,
                                    customMetadata: {
                                        userId: user.uid,
                                        tipo: 'verificacion_vendedor',
                                        uploadedAt: new Date().toISOString()
                                    }
                                };

                                const snapshot = await storageRef.put(documentoVerificacion, metadata);
                                documentoUrl = await snapshot.ref.getDownloadURL();
                                console.log('‚úÖ Documento de verificaci√≥n subido:', documentoUrl);
                            } catch (error) {
                                console.error('‚ùå Error subiendo documento:', error);
                                throw new Error('Error al subir el documento de verificaci√≥n. Por favor, intenta de nuevo.');
                            }
                        }

                        // Agregar coordenadas si est√°n disponibles
                        const ubicacionLat = document.getElementById('ubicacion_lat')?.value;
                        const ubicacionLng = document.getElementById('ubicacion_lng')?.value;
                        const ubicacionFormatted = document.getElementById('ubicacion_formatted')?.value;

                        // Crear solicitud en colecci√≥n separada (NO crear usuario todav√≠a)
                        const solicitudData = {
                            user_id: user.uid,
                            nombre,
                            email,
                            nombre_tienda: nombreTienda,
                            ubicacion: ubicacion,
                            ubicacion_formatted: ubicacionFormatted || ubicacion,
                            ubicacion_lat: ubicacionLat ? parseFloat(ubicacionLat) : null,
                            ubicacion_lng: ubicacionLng ? parseFloat(ubicacionLng) : null,
                            documento_url: documentoUrl,
                            estado: 'pendiente', // pendiente, aprobada, rechazada
                            fecha_solicitud: firebase.firestore.FieldValue.serverTimestamp(),
                            revisado_por: null,
                            fecha_revision: null,
                            motivo_rechazo: null,
                            password_hash: null // No guardamos la contrase√±a por seguridad
                        };

                        // Guardar solicitud en colecci√≥n separada
                        await db.collection('solicitudes_vendedores').doc(user.uid).set(solicitudData);
                        console.log('‚úÖ Solicitud de vendedor guardada en solicitudes_vendedores');

                        // IMPORTANTE: Cerrar sesi√≥n y regresar al login (no permitir acceso a√∫n)
                        alert('‚úÖ Tu solicitud de vendedor fue enviada. Un administrador la revisar√°. Recibir√°s una notificaci√≥n cuando sea aprobada.');
                        try { await auth.signOut(); } catch(e) { console.warn(e); }
                        window.location.href = '/auth/login';
                        return;
                    } else {
                        // Para otros roles (comprador, administrador), crear usuario normalmente
                        const roles = [rol.toLowerCase()];
                        const userData = {
                            nombre,
                            email,
                            roles,
                            rol_activo: rol.toLowerCase(),
                            fecha_registro: firebase.firestore.FieldValue.serverTimestamp(),
                            activo: true
                        };

                        await db.collection('usuarios').doc(user.uid).set(userData, { merge: true });
                    }

                    // Redirigir seg√∫n rol elegido (nota: el flujo de vendedor ya hizo signOut y retorn√≥)
                    let redirectUrl = '/comprador/panel';
                    if (rol === 'administrador') {
                        redirectUrl = '/admin/panel';
                    }
                    window.location.href = redirectUrl;

                } catch (err) {
                    console.error('‚ùå Error registrando usuario:', err);
                    let msg = 'No se pudo crear la cuenta.';
                    if (err && err.message) msg = err.message;
                    alert(msg);
                } finally {
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Crear mi Cuenta';
                    }
                }
            });
        }

        // Efecto hover en el select de rol y mostrar/ocultar campos de vendedor
        const rolSelect = document.getElementById('rol');
        const vendedorFields = document.getElementById('vendedorFields');
        const nombreTiendaInput = document.getElementById('nombre_tienda');
        const ubicacionInput = document.getElementById('ubicacion');
        
        // Inicializar Google Places Autocomplete
        let autocomplete = null;
        
        function initGooglePlaces() {
            if (typeof google !== 'undefined' && google.maps && google.maps.places) {
                const ubicacionInput = document.getElementById('ubicacion');
                if (ubicacionInput) {
                    autocomplete = new google.maps.places.Autocomplete(ubicacionInput, {
                        componentRestrictions: { country: 'mx' }, // Restringir a M√©xico
                        fields: ['formatted_address', 'geometry', 'name'],
                        types: ['establishment', 'geocode']
                    });

                    autocomplete.addListener('place_changed', function() {
                        const place = autocomplete.getPlace();
                        if (!place.geometry) {
                            console.log('No se encontr√≥ informaci√≥n del lugar');
                            return;
                        }

                        // Guardar datos del lugar
                        document.getElementById('ubicacion_formatted').value = place.formatted_address || '';
                        document.getElementById('ubicacion_lat').value = place.geometry.location.lat();
                        document.getElementById('ubicacion_lng').value = place.geometry.location.lng();
                    });
                }
            }
        }

        // Esperar a que Google Maps se cargue
        window.addEventListener('load', function() {
            if (typeof google !== 'undefined' && google.maps && google.maps.places) {
                initGooglePlaces();
            } else {
                // Reintentar despu√©s de un momento
                setTimeout(initGooglePlaces, 1000);
            }
        });

        // Preview del documento
        const documentoInput = document.getElementById('documento_verificacion');
        const documentoPreview = document.getElementById('documento-preview');
        const documentoPreviewImg = document.getElementById('documento-preview-img');
        const documentoPreviewNombre = document.getElementById('documento-preview-nombre');

        if (documentoInput) {
            documentoInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            documentoPreviewImg.src = e.target.result;
                            documentoPreviewImg.style.display = 'block';
                            documentoPreviewNombre.textContent = file.name;
                            documentoPreview.style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    } else {
                        documentoPreviewImg.style.display = 'none';
                        documentoPreviewNombre.textContent = file.name + ' (PDF)';
                        documentoPreview.style.display = 'block';
                    }
                } else {
                    documentoPreview.style.display = 'none';
                }
            });
        }

        if (rolSelect && vendedorFields) {
            rolSelect.addEventListener('change', function() {
                if (this.value) {
                    this.style.color = '#2d3748';
                }
                
                // Mostrar campos adicionales si es vendedor
                if (this.value === 'vendedor') {
                    vendedorFields.style.display = 'block';
                    // Hacer los campos requeridos
                    if (nombreTiendaInput) nombreTiendaInput.required = true;
                    if (ubicacionInput) ubicacionInput.required = true;
                    if (documentoInput) documentoInput.required = true;
                    // Reinicializar autocomplete cuando se muestren los campos
                    setTimeout(initGooglePlaces, 100);
                } else {
                    vendedorFields.style.display = 'none';
                    // Quitar requerido si no es vendedor
                    if (nombreTiendaInput) {
                        nombreTiendaInput.required = false;
                        nombreTiendaInput.value = '';
                    }
                    if (ubicacionInput) {
                        ubicacionInput.required = false;
                        ubicacionInput.value = '';
                        document.getElementById('ubicacion_lat').value = '';
                        document.getElementById('ubicacion_lng').value = '';
                        document.getElementById('ubicacion_formatted').value = '';
                    }
                    if (documentoInput) {
                        documentoInput.required = false;
                        documentoInput.value = '';
                        documentoPreview.style.display = 'none';
                    }
                }
            });
        }
    </script>
</body>
</html>