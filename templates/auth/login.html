<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iniciar Sesión - AgroMarket</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/auth.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>
    <div class="auth-wrapper" id="authWrapper">
        <!-- Lado Izquierdo (Info) -->
        <div class="info-side" id="infoSide">
            <div class="info-content">
                <div class="logo-auth">
                    <i class="fas fa-leaf"></i>AgroMarket
                </div>
                <h2>¡Bienvenido de nuevo!</h2>
                <p>Conecta con productores locales y encuentra los mejores productos frescos del campo</p>
                <a href="/register" class="btn-switch">Crear Cuenta</a>
            </div>
        </div>

        <!-- Lado Derecho (Formulario) -->
        <div class="form-side">
            <!-- Formulario de Login -->
            <div class="form-container" id="loginForm">
                <h1>Iniciar Sesión</h1>
                <p class="form-subtitle">Ingresa tus credenciales para acceder a tu cuenta</p>

                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="flash {{ category }}">
                                <i class="fas fa-{% if category == 'success' %}check-circle{% elif category == 'error' %}exclamation-circle{% elif category == 'warning' %}exclamation-triangle{% else %}info-circle{% endif %}"></i>
                                {{ message }}
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                <form method="POST" id="loginFormElement">
                    <!-- Correo Electrónico -->
                    <div class="input-group">
                        <label for="email">Correo Electrónico</label>
                        <input type="email" name="email" id="email" placeholder="ejemplo@correo.com" required autocomplete="email">
                    </div>

                    <!-- Contraseña -->
                    <div class="input-group">
                        <label for="password">Contraseña</label>
                        <input type="password" name="password" id="password" placeholder="Tu contraseña" required autocomplete="current-password">
                        <i class="fas fa-eye toggle-password" id="togglePassword"></i>
                    </div>

                    <!-- Opciones adicionales -->
                    <div class="form-options">
                        <label class="checkbox-container">
                            <input type="checkbox" name="remember">
                            <span class="checkmark"></span>
                            Recordarme
                        </label>
                        <a href="{{ url_for('auth.forgot_password') }}" class="forgot-password">¿Olvidaste tu contraseña?</a>
                    </div>

                    <button type="submit" class="btn-primary">
                        <i class="fas fa-sign-in-alt"></i> Iniciar Sesión
                    </button>
                </form>

                <div class="links">
                    <a href="{{ url_for('general.home') }}">
                        <i class="fas fa-home"></i> Volver al Inicio
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <!-- Security Validation -->
    <script src="{{ url_for('static', filename='js/security-validation.js') }}"></script>
    <!-- Firebase Ultra-Fast -->
    <script src="{{ url_for('static', filename='js/firebase-ultra-fast.js') }}"></script>

    <script>
        // Mostrar/ocultar contraseña
        const togglePassword = document.getElementById('togglePassword');
        const passwordInput = document.getElementById('password');

        togglePassword.addEventListener('click', function() {
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            this.classList.toggle('fa-eye');
            this.classList.toggle('fa-eye-slash');
        });

        // Validación del formulario de login con Firebase
        const loginFormElement = document.getElementById('loginFormElement');

        loginFormElement.addEventListener('submit', async function(e) {
            e.preventDefault(); // Prevenir envío por defecto
            
            let email = document.getElementById('email').value.trim();
            let password = document.getElementById('password').value;

            if (!email || !password) {
                alert('❌ Por favor, completa todos los campos');
                return;
            }
            
            // Validación de seguridad
            if (typeof SecurityValidation !== 'undefined') {
                // Validar email
                if (!SecurityValidation.validateEmail(email)) {
                    alert('❌ Por favor, ingresa un correo electrónico válido');
                    return;
                }
                
                // Detectar XSS
                if (SecurityValidation.detectXSS(email)) {
                    console.warn('⚠️ Intento de XSS detectado en login');
                    alert('❌ El correo electrónico contiene caracteres no permitidos');
                    return;
                }
                
                email = email.toLowerCase();
                
                // Validar contraseña
                if (password.length < 6) {
                    alert('❌ La contraseña debe tener al menos 6 caracteres');
                    return;
                }
                
                if (SecurityValidation.detectXSS(password)) {
                    console.warn('⚠️ Intento de XSS detectado en contraseña');
                    alert('❌ La contraseña contiene caracteres no permitidos');
                    return;
                }
            } else {
                // Validación básica si SecurityValidation no está disponible
                if (!email.includes('@') || email.length > 254) {
                    alert('❌ Por favor, ingresa un correo electrónico válido');
                    return;
                }
                email = email.toLowerCase();
                
                if (password.length < 6) {
                    alert('❌ La contraseña debe tener al menos 6 caracteres');
                    return;
                }
            }

            // Mostrar loading en el botón
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Iniciando sesión...';
            submitBtn.disabled = true;

            try {
                // LOGIN ULTRA-RÁPIDO - Sin consultas a Firestore
                const result = await window.loginUltraFast(email, password);
                console.log('⚡ Login ultra-rápido exitoso:', result.user.email);
                
                // Mostrar mensaje de éxito
                window.showMessageUltraFast('¡Login exitoso! Redirigiendo...', 'success');
                
                // La redirección se hace automáticamente en loginUltraFast
                
            } catch (error) {
                console.error('❌ Error en login:', error);
                window.showMessageUltraFast('Error al iniciar sesión: ' + error.message, 'error');
            } finally {
                // Restaurar botón
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        // El enlace "¿Olvidaste tu contraseña?" ahora redirige directamente a la página de recuperación
    </script>
</body>
</html>