<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Perfil | AgroMarket</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/perfil_usuario.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/navbar.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/breadcrumbs.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/navigation-header.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/estilos_vendedor.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <script src="{{ url_for('static', filename='js/mobile-menu.js') }}" defer></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>
    
    <!-- Firebase Config -->
    <script src="{{ url_for('static', filename='js/firebase-config.js') }}"></script>
    <!-- Protecci√≥n contra acceso despu√©s de logout -->
    <script src="{{ url_for('static', filename='js/auth-protection.js') }}"></script>
    
    <!-- Email Helper -->
    <script src="{{ url_for('static', filename='js/email-helper.js') }}"></script>
    
    <!-- Google Maps Places API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCCm9SIv6WBmkejLHJ4X7WaTm8xf6DBpCo&libraries=places&language=es&region=MX" async defer></script>
    
</head>

<body data-vendor-id="{{ session.get('usuario_id', '') }}" data-vendor-email="{{ session.get('email', '') }}">
    <!-- ===== Overlay para m√≥viles ===== -->
    <div class="sidebar-overlay" id="sidebar-overlay"></div>
    
    <!-- ===== Men√∫ superior ===== -->
    <nav>
        <button class="menu-toggle" id="menu-toggle" aria-label="Abrir men√∫">
            <span></span>
            <span></span>
            <span></span>
        </button>
        <div class="nav-left">
            <div class="logo">
                <h2>AgroMarket</h2>
            </div>
            <div class="saludo-usuario">Hola, <strong id="usuario-nombre">Usuario</strong></div>
        </div>
        <div class="menu">
            <a href="/auth/perfil" class="activo">
                <i class="fas fa-user"></i>
                <span>Mi Perfil</span>
            </a>
            <a href="/auth/logout">
                <i class="fas fa-sign-out-alt"></i>
                <span>Cerrar Sesi√≥n</span>
            </a>
        </div>
    </nav>
    
    <!-- ===== Sidebar para m√≥viles ===== -->
    <aside class="sidebar-menu" id="sidebar-menu">
        <!-- Header con foto de perfil y nombre -->
        <div class="sidebar-header-profile">
            <div class="sidebar-profile-avatar" id="sidebar-profile-avatar">
                <img id="sidebar-profile-avatar-img" src="" alt="Foto de perfil" style="display: none;">
                <i class="fas fa-user-circle" id="sidebar-profile-avatar-icon"></i>
            </div>
            <div class="sidebar-profile-info">
                <p class="sidebar-profile-name" id="sidebar-profile-name">Usuario</p>
                <p class="sidebar-profile-email" id="sidebar-profile-email">{{ session.get('email', '') }}</p>
            </div>
        </div>
        <div class="menu">
            <a href="/auth/perfil" class="activo">
                <span>Mi Perfil</span>
            </a>
            <a href="/auth/logout">
                <span>Cerrar Sesi√≥n</span>
            </a>
        </div>
    </aside>

    <!-- ===== Contenido principal ===== -->
    <main class="main-content">
        <!-- Navigation Header -->
        <div class="navigation-header">
            <div></div>
            <div class="breadcrumbs">
                <a href="/auth/perfil">Mi cuenta</a>
            </div>
        </div>
        <div class="container">
            <!-- ===== Panel lateral izquierdo ===== -->
            <aside class="sidebar">
                <div class="user-card">
                    <div class="user-avatar-container">
                        <div class="user-avatar" id="sidebar-avatar">
                            <img id="sidebar-avatar-img" src="" alt="Foto de perfil" style="display: none; visibility: hidden;">
                            <i class="fas fa-user-circle" id="sidebar-avatar-icon" style="display: block; visibility: visible;"></i>
                        </div>
                        <div class="avatar-actions">
                            <label for="profilePhotoInput" class="btn-avatar-action btn-edit" title="Editar foto">
                                <i class="fas fa-edit"></i>
                            </label>
                            <button type="button" class="btn-avatar-action btn-delete" id="btn-remove-photo" style="display: none;" title="Eliminar foto">
                                <i class="fas fa-trash"></i>
                            </button>
                            <input type="file" id="profilePhotoInput" accept="image/*" style="display: none;">
                        </div>
                    </div>
                    <div class="user-info">
                        <h3 id="sidebar-nombre">Usuario</h3>
                        <p id="sidebar-email">usuario@ejemplo.com</p>
                    </div>
                </div>

                <!-- Accesos r√°pidos a paneles (arriba de estad√≠sticas) -->
                <div class="quick-access" id="quick-access" style="margin-bottom: 16px;">
                    <!-- Botones de acceso se renderizan v√≠a JS -->
                </div>

                <!-- Bot√≥n Mis Pedidos (solo para compradores) -->
                <div class="mis-pedidos-section" id="mis-pedidos-section" style="display: none; margin-bottom: 16px;">
                    <a href="/comprador/mis_pedidos" class="btn-mis-pedidos">
                        <i class="fas fa-shopping-bag"></i>
                        <span>Mis Pedidos</span>
                    </a>
                </div>


            </aside>

            <!-- ===== Contenido principal ===== -->
            <div class="main-panel">

                <!-- ===== Formulario de perfil ===== -->
                <div class="form-section">
                    <div class="form-card">
                        <h2><i class="fas fa-user-edit"></i> Informaci√≥n Personal</h2>
                        <form class="perfil-form">
                            <div class="form-group">
                                <label for="nombre">
                                    <i class="fas fa-user"></i> Nombre
                                </label>
                                <input type="text" name="nombre" id="form-nombre" value="Usuario" placeholder="Ingresa tu nombre completo" required>
                            </div>

                            <div class="form-group">
                                <label for="email">
                                    <i class="fas fa-envelope"></i> Email
                                </label>
                                <input type="email" name="email" id="form-email" value="usuario@ejemplo.com" placeholder="tu@email.com" required>
                            </div>


                            <div class="form-group">
                                <label for="password">
                                    <i class="fas fa-lock"></i> Nueva Contrase√±a
                                </label>
                                <input type="password" name="password" id="password" placeholder="Dejar vac√≠o para mantener la actual">
                            </div>

                            <div class="form-group">
                                <label for="password_confirm">
                                    <i class="fas fa-lock"></i> Confirmar Contrase√±a
                                </label>
                                <input type="password" name="password_confirm" id="password_confirm" placeholder="Confirmar nueva contrase√±a">
                            </div>

                            <!-- Campos para vendedores -->
                            <div id="vendedor-perfil-fields" style="display: none;">
                                <div class="form-group">
                                    <label for="nombre_tienda_perfil">
                                        <i class="fas fa-store"></i> Nombre de tu tienda o negocio
                                    </label>
                                    <input type="text" name="nombre_tienda" id="nombre_tienda_perfil" placeholder="Ej: La Granja de Juan" maxlength="100">
                                </div>

                                <div class="form-group">
                                    <label for="ubicacion_perfil">
                                        <i class="fas fa-map-marker-alt"></i> Ubicaci√≥n
                                    </label>
                                    <input type="text" name="ubicacion" id="ubicacion_perfil" placeholder="Empieza a escribir tu direcci√≥n..." maxlength="200" autocomplete="off">
                                    <small style="display: block; margin-top: 5px; color: #6b7280; font-size: 0.85rem;">
                                        <i class="fas fa-info-circle"></i> Autocompletado con Google Maps
                                    </small>
                                    <input type="hidden" id="ubicacion_lat_perfil" name="ubicacion_lat">
                                    <input type="hidden" id="ubicacion_lng_perfil" name="ubicacion_lng">
                                    <input type="hidden" id="ubicacion_formatted_perfil" name="ubicacion_formatted">
                                </div>
                            </div>

                            <div class="form-buttons">
                                <button type="submit" class="btn btn-primary" id="btn-actualizar">
                                    <i class="fas fa-save"></i> Actualizar Perfil
                                </button>
                                <button type="button" class="btn btn-secondary" id="btn-cancelar">
                                    <i class="fas fa-times"></i> Cancelar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

            {% if 'vendedor' in (session.get('roles', []) or []) %}
            <section class="stripe-connect-card" id="stripe-connect-card">
                <div class="stripe-card-header">
                    <div>
                        <h2>Configura tus cobros</h2>
                        <p class="stripe-card-description">
                            Conecta tu cuenta de Stripe para recibir pagos y transferencias desde tu perfil.
                        </p>
                    </div>
                    <span class="stripe-status-pill" id="stripe-status-pill">Pendiente</span>
                </div>

                <div class="stripe-status-grid" id="stripe-status-grid">
                    <div class="stripe-status-item pending" data-status="charges">
                        <div class="icon">
                            <i class="fas fa-credit-card"></i>
                        </div>
                        <div class="details">
                            <h3>Cobros habilitados</h3>
                            <p>Permite recibir pagos con tarjeta en tu tienda.</p>
                        </div>
                    </div>
                    <div class="stripe-status-item pending" data-status="payouts">
                        <div class="icon">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                        <div class="details">
                            <h3>Transferencias</h3>
                            <p>Activa los dep√≥sitos autom√°ticos a tu cuenta bancaria.</p>
                        </div>
                    </div>
                    <div class="stripe-status-item pending" data-status="details">
                        <div class="icon">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <div class="details">
                            <h3>Verificaci√≥n de datos</h3>
                            <p>Completa la informaci√≥n fiscal y de identidad requerida.</p>
                        </div>
                    </div>
                </div>

                <div class="stripe-callouts" id="stripe-callouts"></div>

                <div class="stripe-card-actions">
                    <button class="btn-stripe-primary" id="stripe-onboarding-btn">
                        <i class="fas fa-play-circle"></i>
                        Completar configuraci√≥n de cobros
                    </button>
                    <button class="btn-stripe-secondary" id="stripe-refresh-btn" type="button">
                        <i class="fas fa-rotate"></i>
                        Actualizar estado
                    </button>
                </div>

                <p class="stripe-last-update" id="stripe-last-update" aria-live="polite"></p>
            </section>
            {% endif %}

                <!-- ===== Gesti√≥n de roles ===== -->
                <div class="roles-section">
                    <div class="roles-card">
                        <h2><i class="fas fa-users"></i> Gesti√≥n de Roles</h2>
                        <div class="roles-content">
                            <div id="roles-info">
                                <p>Cargando informaci√≥n de roles...</p>
                            </div>
                            <div id="roles-switches" style="display: none;">
                                <div class="roles-list">
                                    <!-- Los roles se cargar√°n din√°micamente con switches -->
                                </div>
                            </div>
                            <div id="roles-actions" style="display: none;">
                                <div class="roles-buttons">
                                    <button class="btn btn-primary" id="btn-cambiar-rol">
                                        <i class="fas fa-exchange-alt"></i> <span id="btn-cambiar-rol-text">Cambiar Rol</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                    </div>
                </div>
    </main>

    {% if 'vendedor' in (session.get('roles', []) or []) %}
    <script>
        (function () {
            const body = document.body;
            if (!body) {
                return;
            }
            const vendorId = body.dataset.vendorId || "";
            const vendorEmail = body.dataset.vendorEmail || "";

            if (vendorId) {
                try {
                    localStorage.setItem("firebase_uid", vendorId);
                    sessionStorage.setItem("firebase_uid", vendorId);
                } catch (err) {
                    console.warn("Stripe Connect: no se pudo guardar firebase_uid en storage.", err);
                }
            }

            if (vendorEmail) {
                try {
                    localStorage.setItem("firebase_email", vendorEmail);
                    sessionStorage.setItem("firebase_email", vendorEmail);
                } catch (err) {
                    console.warn("Stripe Connect: no se pudo guardar firebase_email en storage.", err);
                }
            }
        })();
    </script>
    <script src="{{ url_for('static', filename='js/stripe-connect.js') }}"></script>
    {% endif %}

    <!-- Scripts de Firebase y funcionalidad del perfil -->
    <script>
        // Variables globales
        let auth = null;
        let db = null;
        let storage = null;
        let currentUser = null;
        let userData = null;
        let selectedProfilePhoto = null;

        // Inicializar Firebase
        async function initializeFirebase() {
            try {
                console.log('üîç Verificando Firebase SDK...');
                
                // Esperar a que Firebase est√© disponible (m√°ximo 5 segundos)
                let intentos = 0;
                const maxIntentos = 20;
                while (typeof firebase === 'undefined' && intentos < maxIntentos) {
                    await new Promise(resolve => setTimeout(resolve, 250));
                    intentos++;
                }
                
                if (typeof firebase === 'undefined') {
                    throw new Error('Firebase SDK no est√° cargado. Verifica que los scripts de Firebase est√©n incluidos.');
                }
                console.log('‚úÖ Firebase SDK encontrado');

                // Verificar que los m√≥dulos necesarios est√©n disponibles
                if (typeof firebase.auth === 'undefined') {
                    throw new Error('Firebase Auth no est√° cargado. Verifica que firebase-auth-compat.js est√© incluido.');
                }
                if (typeof firebase.firestore === 'undefined') {
                    throw new Error('Firebase Firestore no est√° cargado. Verifica que firebase-firestore-compat.js est√© incluido.');
                }
                if (typeof firebase.storage === 'undefined') {
                    throw new Error('Firebase Storage no est√° cargado. Verifica que firebase-storage-compat.js est√© incluido.');
                }

                // Verificar configuraci√≥n
                if (!window.firebaseConfig) {
                    throw new Error('Configuraci√≥n de Firebase no disponible. Verifica que firebase-config.js est√© cargado.');
                }

                // Verificar si Firebase ya est√° inicializado
                let app;
                if (firebase.apps && firebase.apps.length > 0) {
                    console.log('üì± Firebase ya est√° inicializado, usando instancia existente');
                    app = firebase.apps[0];
                } else {
                    console.log('üÜï Inicializando nueva instancia de Firebase');
                    try {
                        app = firebase.initializeApp(window.firebaseConfig);
                    } catch (error) {
                        // Si falla, puede ser que ya est√© inicializado con otro nombre
                        if (error.code === 'app/duplicate-app') {
                            console.log('‚ö†Ô∏è Firebase ya estaba inicializado, usando instancia existente');
                            app = firebase.app();
                        } else {
                            throw error;
                        }
                    }
                }
                
                auth = firebase.auth();
                db = firebase.firestore();
                storage = firebase.storage();

                // Validar que Storage est√© correctamente inicializado
                if (!storage || !storage.ref) {
                    console.error('‚ùå Firebase Storage no est√° correctamente inicializado');
                    throw new Error('Firebase Storage no est√° disponible. Verifica que firebase-storage-compat.js est√© cargado.');
                }

                // Verificar que el bucket est√© configurado
                if (window.firebaseConfig && window.firebaseConfig.storageBucket) {
                    console.log('‚úÖ Storage bucket configurado:', window.firebaseConfig.storageBucket);
                } else {
                    console.warn('‚ö†Ô∏è Storage bucket no est√° configurado en firebaseConfig');
                }

                // Configurar Firestore
                if (db && db.settings) {
                    db.settings({
                        cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED,
                        ignoreUndefinedProperties: true
                    });
                }

                console.log('‚úÖ Firebase inicializado correctamente');
                return true;
            } catch (error) {
                console.error('‚ùå Error inicializando Firebase:', error);
                console.error('Stack:', error.stack);
                return false;
            }
        }

        // Cargar datos del usuario
        async function loadUserData() {
            console.log('üë§ loadUserData - Iniciando carga de datos del usuario...');
            try {
                // Verificar que auth y db est√©n inicializados
                if (!auth) {
                    console.error('‚ùå auth no est√° inicializado');
                    throw new Error('Firebase Auth no est√° inicializado. Por favor, recarga la p√°gina.');
                }
                if (!db) {
                    console.error('‚ùå db no est√° inicializado');
                    throw new Error('Firestore no est√° inicializado. Por favor, recarga la p√°gina.');
                }
                
                // Primero intentar obtener el usuario actual directamente
                currentUser = auth.currentUser;
                console.log('üë§ Usuario actual (inmediato):', currentUser ? currentUser.uid : 'null');
                
                if (!currentUser) {
                    console.log('üîÑ Usuario no disponible inmediatamente, esperando...');
                    
                    // Si no hay usuario, esperar a que Firebase Auth est√© listo con timeout
                    await new Promise((resolve, reject) => {
                        const timeout = setTimeout(() => {
                            reject(new Error('Timeout esperando autenticaci√≥n'));
                        }, 5000); // 5 segundos timeout

                        const unsubscribe = auth.onAuthStateChanged((user) => {
                            clearTimeout(timeout);
                            unsubscribe();
                            currentUser = user;
                            resolve();
                        });
                    });
                }

                if (!currentUser) {
                    console.log('‚ùå No hay usuario autenticado');
                    showMessage('Debes iniciar sesi√≥n para ver tu perfil', 'error');
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 2000);
                    return;
                }

                console.log('‚úÖ Usuario autenticado encontrado:', {
                    uid: currentUser.uid,
                    email: currentUser.email,
                    displayName: currentUser.displayName,
                    emailVerified: currentUser.emailVerified
                });
                
                // Obtener datos del usuario desde Firestore
                const userDoc = await db.collection('usuarios').doc(currentUser.uid).get();
                
                if (userDoc.exists) {
                    userData = userDoc.data();
                    console.log('‚úÖ Datos del usuario cargados:', userData);
                    
                    // FORZAR LOG INMEDIATO - Esto deber√≠a aparecer siempre
                    console.log('üñºÔ∏èüñºÔ∏èüñºÔ∏è C√ìDIGO DE FOTO DE PERFIL EJECUT√ÅNDOSE üñºÔ∏èüñºÔ∏èüñºÔ∏è');
                    
                    // Verificar expl√≠citamente el campo foto_perfil
                    const fotoPerfil = userData.foto_perfil;
                    console.log('üñºÔ∏è ===== VERIFICACI√ìN DE FOTO DE PERFIL =====');
                    console.log('üñºÔ∏è Campo foto_perfil existe?', 'foto_perfil' in userData);
                    console.log('üñºÔ∏è Valor de foto_perfil:', fotoPerfil);
                    console.log('üñºÔ∏è Tipo de foto_perfil:', typeof fotoPerfil);
                    console.log('üñºÔ∏è Foto de perfil en Firebase Auth:', currentUser.photoURL);
                    
                    // Si no hay foto en Firestore pero hay en Auth, usar la de Auth
                    if (!fotoPerfil && currentUser.photoURL) {
                        console.log('üì∏ Usando foto de Firebase Auth como fallback');
                        userData.foto_perfil = currentUser.photoURL;
                    } else if (!fotoPerfil) {
                        console.log('‚ö†Ô∏è No hay foto de perfil en Firestore ni en Firebase Auth');
                    } else {
                        console.log('‚úÖ Foto de perfil encontrada:', fotoPerfil);
                    }
                    
                    console.log('üñºÔ∏è ===== FIN VERIFICACI√ìN =====');
                    
                    updateProfileUI();
                    
                    // FORZAR actualizaci√≥n de foto inmediatamente despu√©s de updateProfileUI
                    if (fotoPerfil) {
                        console.log('üñºÔ∏è [FORZADO] Actualizando foto inmediatamente despu√©s de updateProfileUI');
                        setTimeout(() => {
                            const sidebarAvatarImg = document.getElementById('sidebar-avatar-img');
                            const sidebarAvatarIcon = document.getElementById('sidebar-avatar-icon');
                            if (sidebarAvatarImg && fotoPerfil) {
                                console.log('üñºÔ∏è [FORZADO] Configurando imagen directamente');
                                sidebarAvatarImg.src = fotoPerfil;
                                sidebarAvatarImg.style.display = 'block';
                                sidebarAvatarImg.style.visibility = 'visible';
                                sidebarAvatarImg.style.opacity = '1';
                                if (sidebarAvatarIcon) {
                                    sidebarAvatarIcon.style.display = 'none';
                                    sidebarAvatarIcon.style.visibility = 'hidden';
                                }
                                console.log('üñºÔ∏è [FORZADO] Imagen configurada:', {
                                    src: sidebarAvatarImg.src,
                                    display: sidebarAvatarImg.style.display,
                                    visibility: sidebarAvatarImg.style.visibility
                                });
                            } else {
                                console.error('üñºÔ∏è [FORZADO] sidebarAvatarImg no encontrado o fotoPerfil vac√≠o');
                            }
                        }, 200);
                    }
                    
                    updateRolesDisplay();
                    await updateNavbarVisibility(); // Actualizar navbar principal
                    // Accesos r√°pidos iniciales
                    try { updateQuickAccess(userData.roles || []); } catch(e) { console.warn(e); }
                } else {
                    console.log('‚ö†Ô∏è Usuario sin datos en Firestore, creando documento b√°sico');
                    // Crear documento b√°sico
                    userData = {
                        nombre: currentUser.displayName || currentUser.email.split('@')[0],
                        email: currentUser.email,
                        roles: ['comprador'],
                        rol_activo: 'comprador',
                        fecha_registro: firebase.firestore.FieldValue.serverTimestamp(),
                        activo: true
                    };
                    
                    await db.collection('usuarios').doc(currentUser.uid).set(userData);
                    updateProfileUI();
                    updateRolesDisplay();
                    await updateNavbarVisibility(); // Actualizar navbar principal
                    try { updateQuickAccess(userData.roles || []); } catch(e) { console.warn(e); }
                }
            } catch (error) {
                console.error('‚ùå Error cargando datos del usuario:', error);
                
                if (error.message.includes('Timeout')) {
                    showMessage('Tiempo de espera agotado. Recargando p√°gina...', 'warning');
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    showMessage('Error al cargar los datos del perfil', 'error');
                }
            }
        }

        // Actualizar foto de perfil en la UI
        function updateProfilePhoto(fotoUrl) {
            console.log('üñºÔ∏è ===== updateProfilePhoto LLAMADA =====');
            console.log('üñºÔ∏è URL recibida:', fotoUrl);
            
            const sidebarAvatarImg = document.getElementById('sidebar-avatar-img');
            const sidebarAvatarIcon = document.getElementById('sidebar-avatar-icon');
            const btnRemovePhoto = document.getElementById('btn-remove-photo');

            console.log('üñºÔ∏è Elementos encontrados:', {
                sidebarAvatarImg: !!sidebarAvatarImg,
                sidebarAvatarIcon: !!sidebarAvatarIcon,
                btnRemovePhoto: !!btnRemovePhoto
            });

            // Validar URL
            const urlValida = fotoUrl && 
                             typeof fotoUrl === 'string' && 
                             fotoUrl.trim() !== '' && 
                             fotoUrl !== 'null' && 
                             fotoUrl !== 'undefined' &&
                             fotoUrl.startsWith('http');
            
            console.log('üñºÔ∏è URL v√°lida?', urlValida);

            if (urlValida) {
                // Mostrar foto en el sidebar
                if (sidebarAvatarImg) {
                    console.log('üñºÔ∏è Configurando imagen del sidebar con URL:', fotoUrl);
                    sidebarAvatarImg.src = fotoUrl;
                    sidebarAvatarImg.style.display = 'block';
                    sidebarAvatarImg.style.visibility = 'visible';
                    sidebarAvatarImg.style.opacity = '1';
                    
                    sidebarAvatarImg.onload = () => {
                        console.log('‚úÖ Foto cargada exitosamente en sidebar');
                        if (sidebarAvatarIcon) {
                            sidebarAvatarIcon.style.display = 'none';
                            sidebarAvatarIcon.style.visibility = 'hidden';
                        }
                    };
                    
                    sidebarAvatarImg.onerror = (error) => {
                        console.error('‚ùå Error cargando foto en sidebar:', error);
                        console.error('‚ùå URL que fall√≥:', fotoUrl);
                        // Si hay error, mostrar el icono
                        if (sidebarAvatarIcon) {
                            sidebarAvatarIcon.style.display = 'block';
                            sidebarAvatarIcon.style.visibility = 'visible';
                        }
                        sidebarAvatarImg.style.display = 'none';
                        sidebarAvatarImg.style.visibility = 'hidden';
                    };
                    
                    console.log('‚úÖ Atributos de imagen configurados:', {
                        src: sidebarAvatarImg.src,
                        display: sidebarAvatarImg.style.display,
                        visibility: sidebarAvatarImg.style.visibility
                    });
                } else {
                    console.error('‚ùå sidebarAvatarImg no encontrado!');
                }
                
                if (sidebarAvatarIcon) {
                    console.log('üñºÔ∏è Ocultando icono del sidebar');
                    sidebarAvatarIcon.style.display = 'none';
                    sidebarAvatarIcon.style.visibility = 'hidden';
                }
                
                // Mostrar bot√≥n de eliminar
                if (btnRemovePhoto) {
                    btnRemovePhoto.style.display = 'flex';
                }
            } else {
                console.log('‚ö†Ô∏è No hay foto de perfil, mostrando icono por defecto');
                // Ocultar fotos y mostrar iconos
                if (sidebarAvatarImg) {
                    sidebarAvatarImg.style.display = 'none';
                    sidebarAvatarImg.style.visibility = 'hidden';
                    sidebarAvatarImg.src = '';
                }
                if (sidebarAvatarIcon) {
                    sidebarAvatarIcon.style.display = 'block';
                    sidebarAvatarIcon.style.visibility = 'visible';
                }
                
                // Ocultar bot√≥n de eliminar
                if (btnRemovePhoto) {
                    btnRemovePhoto.style.display = 'none';
                }
            }
        }

        // Configurar handlers para la foto de perfil
        function setupProfilePhotoHandlers() {
            const profilePhotoInput = document.getElementById('profilePhotoInput');
            const btnRemovePhoto = document.getElementById('btn-remove-photo');

            // Cuando se selecciona una nueva foto, subirla autom√°ticamente
            if (profilePhotoInput) {
                profilePhotoInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        // Validar tama√±o (m√°x 5MB)
                        if (file.size > 5 * 1024 * 1024) {
                            showMessage('La imagen es muy grande. M√°ximo 5MB', 'error');
                            profilePhotoInput.value = '';
                            return;
                        }

                        // Validar tipo
                        if (!file.type.startsWith('image/')) {
                            showMessage('Por favor selecciona una imagen v√°lida', 'error');
                            profilePhotoInput.value = '';
                            return;
                        }

                        try {
                            showMessage('Subiendo foto de perfil...', 'info');
                            
                            // Subir foto directamente
                            const fotoUrl = await subirFotoPerfil(file);
                            
                            // Actualizar en Firestore
                            await db.collection('usuarios').doc(currentUser.uid).update({
                                foto_perfil: fotoUrl,
                                fecha_actualizacion: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            
                            // Actualizar en Firebase Auth
                            await currentUser.updateProfile({
                                photoURL: fotoUrl
                            });
                            
                            // Actualizar userData local
                            if (userData) {
                                userData.foto_perfil = fotoUrl;
                            }
                            
                            // Actualizar UI
                            updateProfilePhoto(fotoUrl);
                            
                            // Limpiar input
                            profilePhotoInput.value = '';
                            
                            showMessage('Foto de perfil actualizada correctamente', 'success');
                        } catch (error) {
                            console.error('‚ùå Error subiendo foto de perfil:', error);
                            showMessage('Error al subir la foto de perfil', 'error');
                            profilePhotoInput.value = '';
                        }
                    }
                });
            }

            if (btnRemovePhoto) {
                btnRemovePhoto.addEventListener('click', async () => {
                    if (confirm('¬øEst√°s seguro de que quieres eliminar tu foto de perfil?')) {
                        try {
                            // Eliminar foto de Firebase Storage si existe
                            if (userData && userData.foto_perfil) {
                                try {
                                    const oldPhotoRef = storage.refFromURL(userData.foto_perfil);
                                    await oldPhotoRef.delete();
                                } catch (error) {
                                    console.warn('‚ö†Ô∏è No se pudo eliminar la foto de Storage:', error);
                                }
                            }

                            // Eliminar campo foto_perfil de Firestore
                            await db.collection('usuarios').doc(currentUser.uid).update({
                                foto_perfil: firebase.firestore.FieldValue.delete()
                            });

                            // Eliminar foto de Firebase Auth
                            await currentUser.updateProfile({
                                photoURL: null
                            });

                            // Actualizar userData local
                            if (userData) {
                                userData.foto_perfil = null;
                            }

                            // Limpiar selecci√≥n
                            selectedProfilePhoto = null;
                            if (profilePhotoInput) profilePhotoInput.value = '';

                            // Actualizar UI
                            updateProfilePhoto(null);
                            
                            showMessage('Foto de perfil eliminada', 'success');
                        } catch (error) {
                            console.error('‚ùå Error eliminando foto de perfil:', error);
                            showMessage('Error al eliminar la foto de perfil', 'error');
                        }
                    }
                });
            }
        }

        // Subir foto de perfil a Firebase Storage
        async function subirFotoPerfil(archivo) {
            if (!storage || !currentUser) {
                throw new Error('Firebase Storage no est√° disponible');
            }

            // Validar que Storage est√© correctamente inicializado
            if (!storage.ref) {
                throw new Error('Firebase Storage no est√° correctamente inicializado. Por favor, recarga la p√°gina.');
            }

            try {
                // Verificar que el usuario est√© autenticado
                if (!currentUser.uid) {
                    throw new Error('Usuario no autenticado');
                }

                // Eliminar foto anterior si existe
                if (userData && userData.foto_perfil) {
                    try {
                        const oldPhotoRef = storage.refFromURL(userData.foto_perfil);
                        await oldPhotoRef.delete();
                    } catch (error) {
                        console.warn('‚ö†Ô∏è No se pudo eliminar la foto anterior:', error);
                        // No lanzar error, continuar con la subida
                    }
                }

                // Subir nueva foto
                const nombreArchivo = `perfiles/profile_${currentUser.uid}_${Date.now()}.${archivo.name.split('.').pop()}`;
                const storageRef = storage.ref(nombreArchivo);
                const metadata = {
                    contentType: archivo.type,
                    customMetadata: {
                        userId: currentUser.uid,
                        uploadedAt: new Date().toISOString()
                    }
                };

                console.log('üì§ Subiendo foto de perfil a:', nombreArchivo);
                const snapshot = await storageRef.put(archivo, metadata);
                const downloadURL = await snapshot.ref.getDownloadURL();
                
                console.log('‚úÖ Foto de perfil subida exitosamente:', downloadURL);
                return downloadURL;
            } catch (error) {
                console.error('‚ùå Error subiendo foto de perfil:', error);
                
                // Manejo espec√≠fico del error 412
                if (error.code === 'storage/unauthorized' || error.code === 412 || 
                    (error.message && error.message.includes('412'))) {
                    const errorMsg = 'Error de permisos en Firebase Storage. ' +
                        'Por favor, verifica las reglas de Storage en Firebase Console o contacta al administrador.';
                    throw new Error(errorMsg);
                }
                
                // Manejo de otros errores comunes
                if (error.code === 'storage/unauthorized') {
                    throw new Error('No tienes permisos para subir archivos. Verifica que est√©s autenticado.');
                } else if (error.code === 'storage/quota-exceeded') {
                    throw new Error('Se ha excedido la cuota de almacenamiento.');
                } else if (error.code === 'storage/unauthenticated') {
                    throw new Error('Debes iniciar sesi√≥n para subir archivos.');
                }
                
                // Error gen√©rico
                throw new Error(error.message || 'Error al subir la foto de perfil. Por favor, intenta de nuevo.');
            }
        }

        // Actualizar la interfaz con los datos del usuario
        function updateProfileUI() {
            if (!userData) {
                console.warn('‚ö†Ô∏è updateProfileUI: userData no est√° disponible');
                return;
            }

            // Actualizar elementos de la interfaz
            const usuarioNombreEl = document.getElementById('usuario-nombre');
            const sidebarNombreEl = document.getElementById('sidebar-nombre');
            const sidebarEmailEl = document.getElementById('sidebar-email');
            
            if (usuarioNombreEl) usuarioNombreEl.textContent = userData.nombre || 'Usuario';
            if (sidebarNombreEl) sidebarNombreEl.textContent = userData.nombre || 'Usuario';
            if (sidebarEmailEl) sidebarEmailEl.textContent = userData.email || 'usuario@ejemplo.com';
            
            // Actualizar foto de perfil - usar setTimeout para asegurar que el DOM est√© listo
            const fotoUrl = userData.foto_perfil;
            console.log('üñºÔ∏è updateProfileUI - Preparando para actualizar foto');
            console.log('üñºÔ∏è URL de foto_perfil:', fotoUrl);
            console.log('üñºÔ∏è Tipo de fotoUrl:', typeof fotoUrl);
            
            if (fotoUrl) {
                // Intentar m√∫ltiples veces para asegurar que el DOM est√© listo
                setTimeout(() => {
                    console.log('üñºÔ∏è [Timeout 100ms] Llamando updateProfilePhoto');
                    updateProfilePhoto(fotoUrl);
                }, 100);
                
                setTimeout(() => {
                    console.log('üñºÔ∏è [Timeout 500ms] Llamando updateProfilePhoto (segundo intento)');
                    updateProfilePhoto(fotoUrl);
                }, 500);
            } else {
                console.warn('‚ö†Ô∏è No hay URL de foto para mostrar');
            }
            
            // Actualizar formulario
            document.getElementById('form-nombre').value = userData.nombre || '';
            document.getElementById('form-email').value = userData.email || '';

            // Actualizar campos de vendedor si tiene el rol
            const tieneRolVendedor = userData.roles && userData.roles.includes('vendedor');
            const vendedorFields = document.getElementById('vendedor-perfil-fields');
            
            if (vendedorFields) {
                if (tieneRolVendedor) {
                    vendedorFields.style.display = 'block';
                    
                    // Actualizar campos de vendedor
                    const nombreTiendaInput = document.getElementById('nombre_tienda_perfil');
                    const ubicacionInput = document.getElementById('ubicacion_perfil');
                    
                    if (nombreTiendaInput) {
                        nombreTiendaInput.value = userData.nombre_tienda || '';
                    }
                    
                    if (ubicacionInput) {
                        ubicacionInput.value = userData.ubicacion || userData.ubicacion_formatted || '';
                        
                        // Restaurar coordenadas si existen
                        if (userData.ubicacion_lat && userData.ubicacion_lng) {
                            const latInput = document.getElementById('ubicacion_lat_perfil');
                            const lngInput = document.getElementById('ubicacion_lng_perfil');
                            const formattedInput = document.getElementById('ubicacion_formatted_perfil');
                            
                            if (latInput) latInput.value = userData.ubicacion_lat;
                            if (lngInput) lngInput.value = userData.ubicacion_lng;
                            if (formattedInput) formattedInput.value = userData.ubicacion_formatted || userData.ubicacion || '';
                        }
                    }
                    
                    // Inicializar Google Places cuando se muestren los campos
                    setTimeout(function() {
                        if (typeof window.initGooglePlacesPerfil === 'function') {
                            window.initGooglePlacesPerfil();
                        } else {
                            // Esperar un poco m√°s si la funci√≥n a√∫n no existe
                            setTimeout(function() {
                                if (typeof window.initGooglePlacesPerfil === 'function') {
                                    window.initGooglePlacesPerfil();
                                }
                            }, 500);
                        }
                    }, 300);
                } else {
                    vendedorFields.style.display = 'none';
                }
            }

            // Actualizar navbar principal (no usar await aqu√≠ porque no es async)
            updateNavbarVisibility();
        }

        // Actualizar navbar principal seg√∫n los roles activos
        async function updateNavbarVisibility() {
            // Siempre leer datos frescos desde Firestore para asegurar que est√©n actualizados
            const navPanelComprador = document.getElementById('nav-panel-comprador');
            const navPanelVendedor = document.getElementById('nav-panel-vendedor');
            
            if (!navPanelComprador || !navPanelVendedor) {
                console.error('‚ùå Elementos del navbar no encontrados');
                return;
            }
            
            if (currentUser) {
                try {
                    let userDoc = null;
                    try {
                        userDoc = await db.collection('usuarios').doc(currentUser.uid).get({ source: 'server' });
                    } catch (e) {
                        console.warn('‚ö†Ô∏è No se pudo leer desde servidor, usando cach√©/local:', e.message);
                        userDoc = await db.collection('usuarios').doc(currentUser.uid).get();
                    }
                    if (userDoc.exists) {
                        userData = userDoc.data();
                    }
                } catch (error) {
                    console.error('‚ùå Error leyendo datos del usuario para navbar:', error);
                }
            }
            
            if (!userData) {
                console.log('‚ö†Ô∏è updateNavbarVisibility: No hay datos del usuario disponibles');
                return;
            }
            
            let roles = userData.roles || [];
            console.log('üîÑ updateNavbarVisibility - Roles del usuario (raw):', roles);
            console.log('üîÑ Tipo de roles:', Array.isArray(roles) ? 'array' : typeof roles);
            
            // Normalizar roles: convertir a array y a min√∫sculas
            let rolesArray = [];
            if (Array.isArray(roles)) {
                rolesArray = roles.map(r => String(r).toLowerCase().trim()).filter(r => r);
            } else if (roles && typeof roles === 'string') {
                rolesArray = [roles.toLowerCase().trim()];
            }
            
            console.log('üîÑ Roles normalizados:', rolesArray);
            
            // Verificar roles (normalizados)
            const tieneComprador = rolesArray.includes('comprador');
            const tieneVendedor = rolesArray.includes('vendedor');
            const tieneAdministrador = rolesArray.includes('administrador');
            
            console.log('üîÑ Tiene comprador:', tieneComprador);
            console.log('üîÑ Tiene vendedor:', tieneVendedor);
            console.log('üîÑ Tiene administrador:', tieneAdministrador);
            
            // Panel Comprador: permitir/denegar acceso seg√∫n rol
            if (tieneComprador) {
                navPanelComprador.style.display = 'inline-block';
                navPanelComprador.href = '/comprador/panel';
                navPanelComprador.classList.remove('disabled-link');
                navPanelComprador.removeAttribute('title');
                navPanelComprador.onclick = null;
            } else {
                // Mostrar pero bloquear acceso
                navPanelComprador.style.display = 'inline-block';
                navPanelComprador.href = '#';
                navPanelComprador.classList.add('disabled-link');
                navPanelComprador.title = 'Activa el rol de comprador para acceder';
                navPanelComprador.onclick = (e) => {
                    e.preventDefault();
                    try { showMessage('No tienes el rol de comprador activo', 'warning'); } catch(_) {}
                    return false;
                };
            }
            
            // Panel Vendedor: permitir/denegar acceso seg√∫n rol
            if (tieneVendedor) {
                navPanelVendedor.style.display = 'inline-block';
                navPanelVendedor.href = '/vendedor/panel';
                navPanelVendedor.classList.remove('disabled-link');
                navPanelVendedor.removeAttribute('title');
                navPanelVendedor.onclick = null;
            } else {
                navPanelVendedor.style.display = 'inline-block';
                navPanelVendedor.href = '#';
                navPanelVendedor.classList.add('disabled-link');
                navPanelVendedor.title = 'Activa el rol de vendedor para acceder';
                navPanelVendedor.onclick = (e) => {
                    e.preventDefault();
                    try { showMessage('No tienes el rol de vendedor activo', 'warning'); } catch(_) {}
                    return false;
                };
            }
        }


        // Actualizar indicador de rol
        function updateRoleIndicator(rolActivo) {
            const rolIndicador = document.getElementById('rol-indicador');
            const rolStatus = document.getElementById('rol-status');
            
            if (rolActivo === 'vendedor') {
                rolIndicador.className = 'rol-indicador vendedor';
                rolStatus.textContent = 'Vendedor Activo';
            } else {
                rolIndicador.className = 'rol-indicador comprador';
                rolStatus.textContent = 'Comprador Activo';
            }
        }


        // Actualizar visualizaci√≥n de roles
        function updateRolesDisplay() {
            const roles = userData.roles || ['comprador'];
            const rolActivo = userData.rol_activo || 'comprador';
            
            console.log('Roles del usuario:', roles, 'Rol activo:', rolActivo);
            
            
            // Actualizar informaci√≥n de roles
            updateRolesInfo(roles, rolActivo);
            
        }

        // Actualizar informaci√≥n de roles
        function updateRolesInfo(roles, rolActivo) {
            const rolesInfo = document.getElementById('roles-info');
            const rolesSwitches = document.getElementById('roles-switches');
            const rolesActions = document.getElementById('roles-actions');
            const btnCambiarRol = document.getElementById('btn-cambiar-rol');
            const btnCambiarRolText = document.getElementById('btn-cambiar-rol-text');
            
            // Mostrar informaci√≥n b√°sica
            rolesInfo.innerHTML = `
                <p><strong>Rol activo:</strong> <span class="rol-activo-badge">${rolActivo}</span></p>
                <p>Activa o desactiva los roles que necesites usando los switches.</p>
            `;
            
            // Mostrar switches de roles
            rolesSwitches.style.display = 'block';
            updateRolesSwitches(roles, rolActivo);
            
            // Mostrar bot√≥n de cambiar rol si tiene m√∫ltiples roles
            if (roles.length > 1) {
                rolesActions.style.display = 'block';
                btnCambiarRol.style.display = 'inline-flex';
                
                // Determinar el rol opuesto y actualizar el texto del bot√≥n
                const rolOpuesto = rolActivo === 'vendedor' ? 'comprador' : 'vendedor';
                const nombreRolOpuesto = rolOpuesto === 'vendedor' ? 'Vendedor' : 'Comprador';
                btnCambiarRolText.textContent = `Cambiar a ${nombreRolOpuesto}`;
                
                // Actualizar el onclick del bot√≥n para cambiar al rol opuesto
                btnCambiarRol.onclick = () => cambiarRol(rolOpuesto);
            } else {
                rolesActions.style.display = 'none';
            }
        }

        // Actualizar switches de roles (estilo m√≥vil: siempre mostrar ambos switches)
        function updateRolesSwitches(roles, rolActivo) {
            const rolesList = document.querySelector('#roles-switches .roles-list');
            
            const tieneComprador = roles.includes('comprador');
            const tieneVendedor = roles.includes('vendedor');
            const tieneAdministrador = roles.includes('administrador');
            
            const rolesHTML = `
                <div class="role-switch-item">
                    <div class="role-info">
                        <div class="role-icon vendedor">
                            <i class="fas fa-store"></i>
                        </div>
                        <div class="role-details">
                            <h4>Vendedor</h4>
                            <p>Publicar y vender productos</p>
                        </div>
                    </div>
                    <div class="role-switch">
                        <label class="switch">
                            <input type="checkbox" id="switch-vendedor" ${tieneVendedor ? 'checked' : ''} 
                                   onchange="toggleRole('vendedor', this.checked)">
                            <span class="slider"></span>
                        </label>
                        <span class="switch-label">${tieneVendedor ? 'Activo' : 'Inactivo'}</span>
                    </div>
                </div>
                
                <div class="role-switch-item">
                    <div class="role-info">
                        <div class="role-icon comprador">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                        <div class="role-details">
                            <h4>Comprador</h4>
                            <p>Explorar y comprar productos</p>
                        </div>
                    </div>
                    <div class="role-switch">
                        <label class="switch">
                            <input type="checkbox" id="switch-comprador" ${tieneComprador ? 'checked' : ''} 
                                   onchange="toggleRole('comprador', this.checked)">
                            <span class="slider"></span>
                        </label>
                        <span class="switch-label">${tieneComprador ? 'Activo' : 'Inactivo'}</span>
                    </div>
                </div>
                
                ${tieneAdministrador ? `
                <div class="role-switch-item" style="opacity: 0.7;">
                    <div class="role-info">
                        <div class="role-icon administrador" style="background: #dc3545;">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <div class="role-details">
                            <h4>Administrador</h4>
                            <p>Gestionar usuarios y sistema</p>
                        </div>
                    </div>
                    <div class="role-switch">
                        <span class="switch-label" style="color: #dc3545; font-weight: 600;">Solo Admin</span>
                    </div>
                </div>
                ` : ''}
            `;
            
            rolesList.innerHTML = rolesHTML;
            
            // Actualizar navbar despu√©s de actualizar los switches
            updateNavbarVisibility().catch(err => console.error('Error actualizando navbar:', err));
        }

        // Actualizar tarjetas de roles
        function updateRolesCards(roles, rolActivo) {
            const rolesContainer = document.getElementById('perfil-roles');
            
            const rolesHTML = roles.map(rol => {
                const isActive = rol === rolActivo;
                const icon = rol === 'vendedor' ? 'fas fa-store' : 'fas fa-shopping-cart';
                const description = rol === 'vendedor' 
                    ? 'Gestiona tus productos y ventas' 
                    : 'Explora y compra productos';
                
                return `
                    <div class="rol-item ${isActive ? 'activo' : ''}" data-rol="${rol}">
                        <div class="rol-info">
                            <i class="${icon}"></i>
                            <span class="rol-nombre">${rol.charAt(0).toUpperCase() + rol.slice(1)}</span>
                            <span class="rol-estado ${isActive ? 'activo' : 'inactivo'}">
                                ${isActive ? 'Activo' : 'Disponible'}
                            </span>
                        </div>
                        <div class="rol-actions">
                            <span class="rol-description">${description}</span>
                            ${!isActive && roles.length > 1 ? `
                                <button class="btn-rol-cambiar" onclick="cambiarRol('${rol}')">
                                    <i class="fas fa-exchange-alt"></i> Activar
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            rolesContainer.innerHTML = rolesHTML;

            // Refrescar accesos r√°pidos al cambiar los switches
            try { updateQuickAccess(userData.roles || []); } catch(e) {}
        }

        // Accesos r√°pidos en el sidebar
        function updateQuickAccess(rolesInput) {
            const container = document.getElementById('quick-access');
            const misPedidosSection = document.getElementById('mis-pedidos-section');
            if (!container) return;

            let roles = rolesInput || [];
            if (typeof roles === 'string') roles = [roles];
            roles = roles.map(r => String(r).toLowerCase().trim()).filter(Boolean);

            const tieneComprador = roles.includes('comprador');
            const tieneVendedor = roles.includes('vendedor');
            const tieneAdministrador = roles.includes('administrador');

            container.innerHTML = `
                <div style=\"display:flex; flex-direction:column; gap:8px;\">
                    ${tieneAdministrador ? `
                    <a id=\"qa-admin\" href=\"/admin/panel\" 
                       style=\"display:inline-flex; align-items:center; gap:8px; justify-content:center; padding:10px; border-radius:8px; text-decoration:none; background:#dc3545;color:#fff;\">
                        <i class=\"fas fa-shield-alt\"></i>
                        <span>Ir al Panel Admin</span>
                    </a>
                    ` : ''}
                    <a id=\"qa-vendedor\" href=\"${tieneVendedor ? '/vendedor/panel' : '#'}\" 
                       style=\"display:inline-flex; align-items:center; gap:8px; justify-content:center; padding:10px; border-radius:8px; text-decoration:none; ${tieneVendedor ? 'background:#2ba656;color:#fff;' : 'background:#e9ecef;color:#6c757d; cursor:not-allowed;'}\">
                        <i class=\"fas fa-store\"></i>
                        <span>Ir al Panel Vendedor</span>
                    </a>
                    <a id=\"qa-comprador\" href=\"${tieneComprador ? '/comprador/panel' : '#'}\" 
                       style=\"display:inline-flex; align-items:center; gap:8px; justify-content:center; padding:10px; border-radius:8px; text-decoration:none; ${tieneComprador ? 'background:#2ba656;color:#fff;' : 'background:#e9ecef;color:#6c757d; cursor:not-allowed;'}\">
                        <i class=\"fas fa-shopping-cart\"></i>
                        <span>Ir al Panel Comprador</span>
                    </a>
                </div>`;

            if (!tieneComprador) {
                const btn = document.getElementById('qa-comprador');
                if (btn) btn.addEventListener('click', (e) => { e.preventDefault(); showMessage('Activa el rol de comprador para acceder', 'warning'); });
            }
            if (!tieneVendedor) {
                const btn = document.getElementById('qa-vendedor');
                if (btn) btn.addEventListener('click', (e) => { e.preventDefault(); showMessage('Activa el rol de vendedor para acceder', 'warning'); });
            }

            // Mostrar/ocultar bot√≥n "Mis Pedidos" seg√∫n rol de comprador
            if (misPedidosSection) {
                if (tieneComprador) {
                    misPedidosSection.style.display = 'block';
                } else {
                    misPedidosSection.style.display = 'none';
                }
            }
        }

        async function iniciarStripeConnectOnboarding({ silent = false } = {}) {
            try {
                if (!currentUser) {
                    if (!silent) showMessage('Inicia sesi√≥n para configurar tus cobros.', 'error');
                    return;
                }

                const vendorId = currentUser.uid;
                const correo = currentUser.email || (userData?.email);
                if (!vendorId || !correo) {
                    if (!silent) showMessage('No se pudo identificar tu cuenta de Stripe.', 'error');
                    return;
                }

                if (!silent) {
                    showMessage('Abriendo asistente de Stripe...', 'info');
                }

                const response = await fetch('/vendors/create-account', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        vendorId,
                        email: correo
                    })
                });

                const data = await response.json();
                if (!response.ok || data.success === false) {
                    throw new Error(data.error || 'No se pudo generar el enlace de Stripe.');
                }

                const onboardingUrl = data.onboardingUrl || (data.account && data.account.onboardingUrl);
                if (!onboardingUrl) {
                    throw new Error('Stripe no envi√≥ un enlace de onboarding.');
                }

                if (!window.open(onboardingUrl, '_blank', 'noopener')) {
                    window.location.href = onboardingUrl;
                }

            } catch (error) {
                console.error('Error iniciando onboarding de Stripe:', error);
                if (!silent) {
                    showMessage(error.message || 'No se pudo abrir Stripe Connect. Intenta de nuevo.', 'error');
                }
                throw error;
            }
        }

        window.iniciarStripeConnectOnboarding = iniciarStripeConnectOnboarding;

        // Toggle de rol (activar/desactivar)
        async function toggleRole(rol, activar) {
            try {
                if (!currentUser) {
                    showMessage('No hay usuario autenticado', 'error');
                    return;
                }

                // Normalizar roles: asegurar array de strings en min√∫sculas
                let roles = userData.roles || [];
                if (typeof roles === 'string') {
                    roles = [roles];
                }
                roles = roles.map(r => String(r).toLowerCase().trim()).filter(r => r);
                rol = String(rol).toLowerCase().trim();
                
                if (activar) {
                    // Si es vendedor, validar campos antes de activar
                    if (rol === 'vendedor' && !roles.includes(rol)) {
                        // Verificar si ya tiene una solicitud pendiente
                        const solicitudDoc = await db.collection('solicitudes_vendedores').doc(currentUser.uid).get();
                        if (solicitudDoc.exists) {
                            const solicitudData = solicitudDoc.data();
                            const estado = solicitudData.estado || 'pendiente';
                            
                            if (estado === 'pendiente') {
                                showMessage('Ya tienes una solicitud de vendedor pendiente de aprobaci√≥n', 'info');
                                // Revertir el switch
                                const switchElement = document.getElementById(`switch-${rol}`);
                                if (switchElement) switchElement.checked = false;
                                return;
                            } else if (estado === 'rechazada') {
                                showMessage('Tu solicitud de vendedor fue rechazada. Puedes crear una nueva solicitud.', 'warning');
                                // Mostrar modal para nueva solicitud
                                await mostrarModalSolicitudVendedor();
                                // Revertir el switch
                                const switchElement = document.getElementById(`switch-${rol}`);
                                if (switchElement) switchElement.checked = false;
                                return;
                            }
                        }
                        
                        // Verificar si tiene los campos necesarios
                        const tieneNombreTienda = userData.nombre_tienda && userData.nombre_tienda.trim() !== '';
                        const tieneUbicacion = userData.ubicacion && userData.ubicacion.trim() !== '';
                        const tieneDocumento = userData.documento_verificacion_url || (solicitudDoc.exists && solicitudDoc.data().documento_url);
                        
                        // Si faltan campos, mostrar modal para completarlos
                        if (!tieneNombreTienda || !tieneUbicacion || !tieneDocumento) {
                            await mostrarModalSolicitudVendedor();
                            // Revertir el switch
                            const switchElement = document.getElementById(`switch-${rol}`);
                            if (switchElement) switchElement.checked = false;
                            return;
                        }
                        
                        // Si tiene todos los campos pero no tiene solicitud, crear una
                        if (!solicitudDoc.exists) {
                            await crearSolicitudVendedor(userData);
                            showMessage('Solicitud de vendedor enviada. Un administrador la revisar√°.', 'success');
                            // Revertir el switch
                            const switchElement = document.getElementById(`switch-${rol}`);
                            if (switchElement) switchElement.checked = false;
                            return;
                        }
                    }
                    
                    // Agregar rol si no existe (flujo normal para otros roles o vendedor ya aprobado)
                    if (!roles.includes(rol)) {
                        showMessage(`Activando rol ${rol}...`, 'info');
                        
                        const nuevosRoles = Array.from(new Set([...roles, rol]));
                        const updateData = {
                            roles: nuevosRoles,
                            fecha_actualizacion: firebase.firestore.FieldValue.serverTimestamp()
                        };
                        
                        // Si es el primer rol o no hay rol activo, establecerlo como activo
                        if (!userData.rol_activo || nuevosRoles.length === 1) {
                            updateData.rol_activo = rol;
                        }
                        
                        await db.collection('usuarios').doc(currentUser.uid).update(updateData);
                        
                        userData.roles = nuevosRoles;
                        if (updateData.rol_activo) {
                            userData.rol_activo = rol;
                        }
                        
                        showMessage(`Rol ${rol} activado exitosamente`, 'success');

                        // Sincronizar con la sesi√≥n de Flask para que el backend aplique los cambios de inmediato
                        try {
                            await fetch('/auth/sincronizar-rol', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                credentials: 'same-origin',
                                body: JSON.stringify({
                                    user_id: currentUser.uid,
                                    roles: nuevosRoles,
                                    rol_activo: userData.rol_activo || rol,
                                    nombre: userData.nombre || currentUser.displayName || (currentUser.email || '').split('@')[0],
                                    email: currentUser.email
                                })
                            });
                        } catch (e) { console.warn('sync rol (activar) fallo', e); }
                    }
                } else {
                    // Verificar que no sea el √∫ltimo rol
                    if (roles.length <= 1) {
                        showMessage('No puedes desactivar tu √∫nico rol', 'warning');
                        // Revertir el switch
                        const switchElement = document.getElementById(`switch-${rol}`);
                        if (switchElement) switchElement.checked = true;
                        return;
                    }
                    
                    showMessage(`Desactivando rol ${rol}...`, 'info');
                    
                    // Eliminar rol del array
                    const nuevosRoles = roles.filter(r => r !== rol);
                    
                    // Si el rol desactivado era el activo, cambiar al otro rol disponible
                    let nuevoRolActivo = userData.rol_activo;
                    if (userData.rol_activo === rol) {
                        nuevoRolActivo = nuevosRoles[0]; // Usar el primer rol disponible
                    }
                    
                    await db.collection('usuarios').doc(currentUser.uid).update({
                        roles: nuevosRoles,
                        rol_activo: nuevoRolActivo,
                        fecha_actualizacion: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    userData.roles = nuevosRoles;
                    userData.rol_activo = nuevoRolActivo;
                    
                    showMessage(`Rol ${rol} desactivado exitosamente`, 'success');
                    if (nuevoRolActivo !== rol) {
                        showMessage(`Se ha cambiado el rol activo a ${nuevoRolActivo}`, 'info');
                    }

                    // Sincronizar con la sesi√≥n de Flask (desactivaci√≥n)
                    try {
                        await fetch('/auth/sincronizar-rol', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'same-origin',
                            body: JSON.stringify({
                                user_id: currentUser.uid,
                                roles: nuevosRoles,
                                rol_activo: nuevoRolActivo,
                                nombre: userData.nombre || currentUser.displayName || (currentUser.email || '').split('@')[0],
                                email: currentUser.email
                            })
                        });
                    } catch (e) { console.warn('sync rol (desactivar) fallo', e); }
                }
                
                // Actualizar interfaz
                updateRolesDisplay();
                
                // Actualizar navbar inmediatamente con los datos actualizados
                await updateNavbarVisibility();
                try { updateQuickAccess(userData.roles || []); } catch(e) {}
                
            } catch (error) {
                console.error('‚ùå Error cambiando estado del rol:', error);
                showMessage('Error al cambiar el estado del rol', 'error');
                // Revertir el switch en caso de error
                document.getElementById(`switch-${rol}`).checked = !activar;
            }
        }

        // Mostrar modal para completar datos de vendedor
        async function mostrarModalSolicitudVendedor() {
            return new Promise((resolve) => {
                // Crear modal
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.id = 'modal-solicitud-vendedor';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
                        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; padding: 20px;">
                            <h2 style="margin: 0; color: var(--text-dark); display: flex; align-items: center; gap: 10px;"><i class="fas fa-store"></i> Solicitud de Rol de Vendedor</h2>
                            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <p style="margin-bottom: 1.5rem; color: #666;">
                                Para activar el rol de vendedor, necesitamos algunos datos adicionales. 
                                Un administrador revisar√° tu solicitud y te notificar√° cuando sea aprobada.
                            </p>
                            <form id="form-solicitud-vendedor">
                                <!-- Nombre de la tienda -->
                                <div class="input-group" style="margin-bottom: 1.5rem;">
                                    <label for="modal-nombre_tienda">
                                        <i class="fas fa-store"></i> Nombre de tu tienda o negocio <span style="color: red;">*</span>
                                    </label>
                                    <input type="text" 
                                           id="modal-nombre_tienda" 
                                           name="nombre_tienda" 
                                           placeholder="Ej: La Granja de Juan" 
                                           maxlength="100"
                                           required
                                           value="${userData?.nombre_tienda || ''}">
                                    <small>
                                        Nombre con el que aparecer√°s como vendedor
                                    </small>
                                </div>

                                <!-- Ubicaci√≥n con Google Maps Autocomplete -->
                                <div class="input-group" style="margin-bottom: 1.5rem;">
                                    <label for="modal-ubicacion">
                                        <i class="fas fa-map-marker-alt"></i> Ubicaci√≥n <span style="color: red;">*</span>
                                    </label>
                                    <input type="text" 
                                           id="modal-ubicacion" 
                                           name="ubicacion" 
                                           placeholder="Empieza a escribir tu direcci√≥n..." 
                                           maxlength="200" 
                                           autocomplete="off"
                                           required
                                           value="${userData?.ubicacion || ''}">
                                    <small>
                                        ¬øD√≥nde vendes tus productos? (Autocompletado con Google Maps)
                                    </small>
                                    <input type="hidden" id="modal-ubicacion_lat" name="ubicacion_lat" value="${userData?.ubicacion_lat || ''}">
                                    <input type="hidden" id="modal-ubicacion_lng" name="ubicacion_lng" value="${userData?.ubicacion_lng || ''}">
                                    <input type="hidden" id="modal-ubicacion_formatted" name="ubicacion_formatted" value="${userData?.ubicacion_formatted || ''}">
                                </div>

                                <!-- Documento de verificaci√≥n -->
                                <div class="input-group" style="margin-bottom: 1.5rem;">
                                    <label for="modal-documento_verificacion">
                                        <i class="fas fa-file-upload"></i> Documento de Verificaci√≥n <span style="color: red;">*</span>
                                    </label>
                                    <input type="file" 
                                           id="modal-documento_verificacion" 
                                           name="documento_verificacion" 
                                           accept="image/*,.pdf" 
                                           required>
                                    <small>
                                        <i class="fas fa-info-circle"></i> 
                                        Sube una identificaci√≥n oficial, RFC o comprobante de domicilio (JPG, PNG, PDF - m√°x. 5MB)
                                    </small>
                                    <div id="modal-documento-preview" style="display: none; margin-top: 10px;">
                                        <img id="modal-documento-preview-img" src="" alt="Vista previa" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 2px solid #2ba656;">
                                        <p id="modal-documento-preview-nombre" style="margin-top: 5px; font-size: 0.9rem; color: #2ba656;"></p>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn-secondary" onclick="this.closest('.modal-overlay').remove(); resolve();">
                                Cancelar
                            </button>
                            <button type="button" class="btn-primary" id="btn-enviar-solicitud">
                                <i class="fas fa-paper-plane"></i> Enviar Solicitud
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Inicializar Google Places Autocomplete
                if (typeof google !== 'undefined' && google.maps && google.maps.places) {
                    const ubicacionInput = document.getElementById('modal-ubicacion');
                    if (ubicacionInput) {
                        const autocomplete = new google.maps.places.Autocomplete(ubicacionInput, {
                            componentRestrictions: { country: 'mx' },
                            fields: ['formatted_address', 'geometry', 'name'],
                            types: ['establishment', 'geocode']
                        });

                        autocomplete.addListener('place_changed', function() {
                            const place = autocomplete.getPlace();
                            if (!place.geometry) {
                                console.log('No se encontr√≥ informaci√≥n del lugar');
                                return;
                            }

                            document.getElementById('modal-ubicacion_formatted').value = place.formatted_address || '';
                            document.getElementById('modal-ubicacion_lat').value = place.geometry.location.lat();
                            document.getElementById('modal-ubicacion_lng').value = place.geometry.location.lng();
                        });
                    }
                }
                
                // Preview del documento
                const documentoInput = document.getElementById('modal-documento_verificacion');
                const previewDiv = document.getElementById('modal-documento-preview');
                const previewImg = document.getElementById('modal-documento-preview-img');
                const previewNombre = document.getElementById('modal-documento-preview-nombre');
                
                documentoInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        if (file.size > 5 * 1024 * 1024) {
                            alert('El documento no debe exceder 5MB');
                            e.target.value = '';
                            return;
                        }
                        
                        if (file.type.startsWith('image/')) {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                previewImg.src = e.target.result;
                                previewNombre.textContent = file.name;
                                previewDiv.style.display = 'block';
                            };
                            reader.readAsDataURL(file);
                        } else {
                            previewImg.style.display = 'none';
                            previewNombre.textContent = file.name;
                            previewDiv.style.display = 'block';
                        }
                    } else {
                        previewDiv.style.display = 'none';
                    }
                });
                
                // Enviar solicitud
                const btnEnviar = document.getElementById('btn-enviar-solicitud');
                btnEnviar.addEventListener('click', async () => {
                    const form = document.getElementById('form-solicitud-vendedor');
                    if (!form.checkValidity()) {
                        form.reportValidity();
                        return;
                    }
                    
                    btnEnviar.disabled = true;
                    btnEnviar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
                    
                    try {
                        const nombreTienda = document.getElementById('modal-nombre_tienda').value.trim();
                        const ubicacion = document.getElementById('modal-ubicacion').value.trim();
                        const ubicacionLat = document.getElementById('modal-ubicacion_lat').value;
                        const ubicacionLng = document.getElementById('modal-ubicacion_lng').value;
                        const ubicacionFormatted = document.getElementById('modal-ubicacion_formatted').value;
                        const documentoFile = document.getElementById('modal-documento_verificacion').files[0];
                        
                        if (!documentoFile) {
                            alert('Por favor, sube un documento de verificaci√≥n');
                            btnEnviar.disabled = false;
                            btnEnviar.innerHTML = '<i class="fas fa-paper-plane"></i> Enviar Solicitud';
                            return;
                        }
                        
                        // Subir documento a Firebase Storage
                        const storage = firebase.storage();
                        const documentoRef = storage.ref(`solicitudes_vendedores/${currentUser.uid}/${Date.now()}_${documentoFile.name}`);
                        await documentoRef.put(documentoFile);
                        const documentoUrl = await documentoRef.getDownloadURL();
                        
                        // Crear solicitud
                        await crearSolicitudVendedor({
                            nombre_tienda: nombreTienda,
                            ubicacion: ubicacion,
                            ubicacion_lat: ubicacionLat ? parseFloat(ubicacionLat) : null,
                            ubicacion_lng: ubicacionLng ? parseFloat(ubicacionLng) : null,
                            ubicacion_formatted: ubicacionFormatted || ubicacion,
                            documento_url: documentoUrl
                        });
                        
                        showMessage('‚úÖ Solicitud de vendedor enviada correctamente. Un administrador la revisar√°.', 'success');
                        modal.remove();
                        resolve();
                        
                        // Recargar datos del usuario
                        await loadUserData();
                    } catch (error) {
                        console.error('‚ùå Error enviando solicitud:', error);
                        alert('Error al enviar la solicitud: ' + error.message);
                        btnEnviar.disabled = false;
                        btnEnviar.innerHTML = '<i class="fas fa-paper-plane"></i> Enviar Solicitud';
                    }
                });
                
                // Cerrar al hacer clic fuera del modal
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                        resolve();
                    }
                });
            });
        }

        // Crear solicitud de vendedor en Firestore
        async function crearSolicitudVendedor(datosAdicionales = {}) {
            const solicitudData = {
                user_id: currentUser.uid,
                nombre: userData.nombre || currentUser.displayName || (currentUser.email || '').split('@')[0],
                email: currentUser.email,
                nombre_tienda: datosAdicionales.nombre_tienda || userData.nombre_tienda || '',
                ubicacion: datosAdicionales.ubicacion || userData.ubicacion || '',
                ubicacion_formatted: datosAdicionales.ubicacion_formatted || userData.ubicacion_formatted || datosAdicionales.ubicacion || userData.ubicacion || '',
                ubicacion_lat: datosAdicionales.ubicacion_lat || userData.ubicacion_lat || null,
                ubicacion_lng: datosAdicionales.ubicacion_lng || userData.ubicacion_lng || null,
                documento_url: datosAdicionales.documento_url || userData.documento_verificacion_url || '',
                estado: 'pendiente',
                fecha_solicitud: firebase.firestore.FieldValue.serverTimestamp(),
                revisado_por: null,
                fecha_revision: null,
                motivo_rechazo: null
            };
            
            // Guardar solicitud en Firestore
            await db.collection('solicitudes_vendedores').doc(currentUser.uid).set(solicitudData);
            
            // Actualizar datos del usuario con la informaci√≥n proporcionada (sin activar el rol a√∫n)
            const updateData = {
                nombre_tienda: solicitudData.nombre_tienda,
                ubicacion: solicitudData.ubicacion,
                ubicacion_formatted: solicitudData.ubicacion_formatted,
                ubicacion_lat: solicitudData.ubicacion_lat,
                ubicacion_lng: solicitudData.ubicacion_lng,
                solicitud_vendedor_pendiente: true,
                fecha_actualizacion: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            await db.collection('usuarios').doc(currentUser.uid).update(updateData);
            
            // Actualizar userData local
            Object.assign(userData, updateData);
            
            console.log('‚úÖ Solicitud de vendedor creada:', solicitudData);
            
            // Enviar correo de notificaci√≥n al administrador
            console.log('üìß Iniciando proceso de notificaci√≥n al administrador...');
            try {
                await notificarAdministradorNuevaSolicitud(solicitudData);
                console.log('‚úÖ Proceso de notificaci√≥n completado');
            } catch (emailError) {
                console.error('‚ùå Error enviando notificaci√≥n al administrador:', emailError);
                console.error('‚ùå Detalles del error:', {
                    message: emailError.message,
                    code: emailError.code,
                    stack: emailError.stack
                });
                // No bloquear la creaci√≥n de la solicitud si falla el correo
            }
        }
        
        // Notificar al administrador sobre nueva solicitud de vendedor
        async function notificarAdministradorNuevaSolicitud(solicitudData) {
            console.log('üîç [NOTIFICACI√ìN] Iniciando funci√≥n notificarAdministradorNuevaSolicitud');
            console.log('üîç [NOTIFICACI√ìN] Datos de solicitud:', solicitudData);
            
            try {
                // Obtener fecha de solicitud formateada
                const fechaSolicitud = solicitudData.fecha_solicitud 
                    ? (solicitudData.fecha_solicitud.toDate ? solicitudData.fecha_solicitud.toDate().toLocaleString('es-MX') : new Date().toLocaleString('es-MX'))
                    : new Date().toLocaleString('es-MX');
                
                console.log('üìß [NOTIFICACI√ìN] Preparando datos para enviar:', {
                    solicitudId: currentUser.uid,
                    nombre: solicitudData.nombre,
                    email: solicitudData.email,
                    nombreTienda: solicitudData.nombre_tienda,
                    ubicacion: solicitudData.ubicacion || solicitudData.ubicacion_formatted,
                    fechaSolicitud: fechaSolicitud
                });
                
                // Verificar si la funci√≥n est√° disponible
                if (typeof enviarCorreoNuevaSolicitudAdmin === 'undefined') {
                    console.error('‚ùå [NOTIFICACI√ìN] La funci√≥n enviarCorreoNuevaSolicitudAdmin no est√° disponible');
                    console.log('‚ö†Ô∏è [NOTIFICACI√ìN] Aseg√∫rate de que email-helper.js est√© cargado');
                    return;
                }
                
                // Llamar a la funci√≥n de email-helper.js
                console.log('üìû [NOTIFICACI√ìN] Llamando a enviarCorreoNuevaSolicitudAdmin...');
                const result = await enviarCorreoNuevaSolicitudAdmin(
                    currentUser.uid,
                    solicitudData.nombre,
                    solicitudData.email,
                    solicitudData.nombre_tienda,
                    solicitudData.ubicacion || solicitudData.ubicacion_formatted,
                    fechaSolicitud
                );
                
                console.log('üì• [NOTIFICACI√ìN] Respuesta recibida:', result);
                
                if (result && result.success) {
                    console.log('‚úÖ [NOTIFICACI√ìN] Notificaci√≥n enviada exitosamente a administradores:', {
                        admin_email: result.admin_email,
                        message: result.message
                    });
                } else {
                    console.warn('‚ö†Ô∏è [NOTIFICACI√ìN] Respuesta inesperada:', result);
                }
            } catch (error) {
                console.error('‚ùå [NOTIFICACI√ìN] Error completo:', error);
                console.error('‚ùå [NOTIFICACI√ìN] Tipo de error:', error.constructor.name);
                console.error('‚ùå [NOTIFICACI√ìN] Mensaje:', error.message);
                console.error('‚ùå [NOTIFICACI√ìN] Stack:', error.stack);
                // No lanzar el error, solo loguearlo
            }
        }

        // Cambiar rol activo
        async function cambiarRol(nuevoRol) {
            try {
                console.log('üîÑ Iniciando cambio de rol a:', nuevoRol);
                
                if (!currentUser) {
                    showMessage('No hay usuario autenticado', 'error');
                    return;
                }

                showMessage(`Cambiando a rol ${nuevoRol}...`, 'info');

                // Actualizar rol activo en Firestore
                await db.collection('usuarios').doc(currentUser.uid).update({
                    rol_activo: nuevoRol,
                    fecha_actualizacion: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Actualizar datos locales
                userData.rol_activo = nuevoRol;
                console.log('‚úÖ Datos locales actualizados:', userData);

                // Sincronizar con la sesi√≥n de Flask
                try {
                    const syncResponse = await fetch('/auth/sincronizar-rol', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        credentials: 'same-origin',
                        body: JSON.stringify({
                            user_id: currentUser.uid,
                            roles: userData.roles || [],
                            rol_activo: nuevoRol,
                            nombre: userData.nombre || currentUser.displayName || currentUser.email.split('@')[0],
                            email: currentUser.email
                        })
                    });
                    
                    if (!syncResponse.ok) {
                        console.warn('‚ö†Ô∏è Error sincronizando con Flask, continuando...');
                    } else {
                        const syncData = await syncResponse.json();
                        console.log('‚úÖ Rol sincronizado con Flask:', syncData);
                    }
                } catch (syncError) {
                    console.warn('‚ö†Ô∏è Error sincronizando con Flask:', syncError);
                    // Continuar aunque falle la sincronizaci√≥n
                }

                // Actualizar interfaz
                updateProfileUI();
                updateRolesDisplay();
                await updateNavbarVisibility(); // Actualizar navbar principal
                console.log('‚úÖ Interfaz actualizada');

                showMessage(`Rol cambiado a ${nuevoRol} exitosamente`, 'success');

            } catch (error) {
                console.error('‚ùå Error cambiando rol:', error);
                showMessage('Error al cambiar el rol', 'error');
            }
        }

        // Agregar rol de vendedor
        async function agregarRolVendedor() {
            try {
                if (!currentUser) {
                    showMessage('No hay usuario autenticado', 'error');
                    return;
                }

                const roles = userData.roles || ['comprador'];
                
                if (roles.includes('vendedor')) {
                    showMessage('Ya tienes el rol de vendedor', 'warning');
                    return;
                }

                showMessage('Agregando rol de vendedor...', 'info');

                // Agregar rol de vendedor
                const nuevosRoles = [...roles, 'vendedor'];
                
                // Actualizar en Firestore
                await db.collection('usuarios').doc(currentUser.uid).update({
                    roles: nuevosRoles,
                    fecha_actualizacion: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Actualizar datos locales
                userData.roles = nuevosRoles;

                // Actualizar interfaz
                updateRolesDisplay();
                await updateNavbarVisibility(); // Actualizar navbar principal

                try {
                    await iniciarStripeConnectOnboarding();
                } catch (onboardingError) {
                    console.warn('‚ö†Ô∏è No se pudo iniciar onboarding despu√©s de agregar rol vendedor:', onboardingError);
                }

                showMessage('Rol de vendedor agregado exitosamente', 'success');

            } catch (error) {
                console.error('‚ùå Error agregando rol de vendedor:', error);
                showMessage('Error al agregar el rol de vendedor', 'error');
            }
        }

        // Agregar rol de comprador
        async function agregarRolComprador() {
            try {
                if (!currentUser) {
                    showMessage('No hay usuario autenticado', 'error');
                    return;
                }

                const roles = userData.roles || ['vendedor'];
                
                if (roles.includes('comprador')) {
                    showMessage('Ya tienes el rol de comprador', 'warning');
                    return;
                }

                showMessage('Agregando rol de comprador...', 'info');

                // Agregar rol de comprador
                const nuevosRoles = [...roles, 'comprador'];
                
                // Actualizar en Firestore
                await db.collection('usuarios').doc(currentUser.uid).update({
                    roles: nuevosRoles,
                    fecha_actualizacion: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Actualizar datos locales
                userData.roles = nuevosRoles;

                // Actualizar interfaz
                updateRolesDisplay();
                await updateNavbarVisibility(); // Actualizar navbar principal

                showMessage('Rol de comprador agregado exitosamente', 'success');

            } catch (error) {
                console.error('‚ùå Error agregando rol de comprador:', error);
                showMessage('Error al agregar el rol de comprador', 'error');
            }
        }

        // Eliminar rol
        async function eliminarRol() {
            try {
                if (!currentUser) {
                    showMessage('No hay usuario autenticado', 'error');
                    return;
                }

                const roles = userData.roles || [];
                
                if (roles.length <= 1) {
                    showMessage('No puedes eliminar tu √∫nico rol', 'warning');
                    return;
                }

                // Mostrar modal de confirmaci√≥n
                const rolAEliminar = await mostrarModalEliminarRol(roles);
                
                if (!rolAEliminar) {
                    return; // Usuario cancel√≥
                }

                showMessage(`Eliminando rol ${rolAEliminar}...`, 'info');

                // Eliminar rol
                const nuevosRoles = roles.filter(rol => rol !== rolAEliminar);
                const nuevoRolActivo = nuevosRoles[0]; // Usar el primer rol disponible

                // Actualizar en Firestore
                await db.collection('usuarios').doc(currentUser.uid).update({
                    roles: nuevosRoles,
                    rol_activo: nuevoRolActivo,
                    fecha_actualizacion: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Actualizar datos locales
                userData.roles = nuevosRoles;
                userData.rol_activo = nuevoRolActivo;

                // Actualizar interfaz
                updateProfileUI();
                updateRolesDisplay();
                await updateNavbarVisibility(); // Actualizar navbar principal

                showMessage(`Rol ${rolAEliminar} eliminado exitosamente`, 'success');

            } catch (error) {
                console.error('‚ùå Error eliminando rol:', error);
                showMessage('Error al eliminar el rol', 'error');
            }
        }

        // Mostrar modal para cambiar rol activo
        function mostrarModalCambiarRol() {
            const roles = userData.roles || [];
            const rolActivo = userData.rol_activo || 'comprador';
            
            if (roles.length <= 1) {
                showMessage('Necesitas m√∫ltiples roles para cambiar entre ellos', 'warning');
                return;
            }
            
            // Crear modal
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3><i class="fas fa-exchange-alt"></i> Cambiar Rol Activo</h3>
                    </div>
                    <div class="modal-body">
                        <p>Selecciona el rol que deseas activar:</p>
                        <div class="roles-list">
                            ${roles.map(rol => `
                                <div class="rol-option ${rol === rolActivo ? 'activo' : ''}" data-rol="${rol}">
                                    <i class="fas fa-${rol === 'vendedor' ? 'store' : 'shopping-cart'}"></i>
                                    <span>${rol.charAt(0).toUpperCase() + rol.slice(1)}</span>
                                    ${rol === rolActivo ? '<span class="rol-actual">(Actual)</span>' : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" id="cancelar-cambiar">Cancelar</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Event listeners
            const rolOptions = modal.querySelectorAll('.rol-option');
            const btnCancelar = modal.querySelector('#cancelar-cambiar');

            rolOptions.forEach(option => {
                option.addEventListener('click', () => {
                    const rol = option.dataset.rol;
                    if (rol !== rolActivo) {
                        document.body.removeChild(modal);
                        cambiarRol(rol);
                    }
                });
            });

            btnCancelar.addEventListener('click', () => {
                document.body.removeChild(modal);
            });

            // Cerrar al hacer clic fuera del modal
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
        }

        // Mostrar modal para seleccionar rol a eliminar
        async function mostrarModalEliminarRol(roles) {
            return new Promise((resolve) => {
                // Crear modal
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3><i class="fas fa-exclamation-triangle"></i> Eliminar Rol</h3>
                        </div>
                        <div class="modal-body">
                            <p>Selecciona el rol que deseas eliminar:</p>
                            <div class="roles-list">
                                ${roles.map(rol => `
                                    <div class="rol-option" data-rol="${rol}">
                                        <i class="fas fa-${rol === 'vendedor' ? 'store' : 'shopping-cart'}"></i>
                                        <span>${rol.charAt(0).toUpperCase() + rol.slice(1)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="cancelar-eliminar">Cancelar</button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                // Event listeners
                const rolOptions = modal.querySelectorAll('.rol-option');
                const btnCancelar = modal.querySelector('#cancelar-eliminar');

                rolOptions.forEach(option => {
                    option.addEventListener('click', () => {
                        const rol = option.dataset.rol;
                        document.body.removeChild(modal);
                        resolve(rol);
                    });
                });

                btnCancelar.addEventListener('click', () => {
                    document.body.removeChild(modal);
                    resolve(null);
                });

                // Cerrar al hacer clic fuera del modal
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                        resolve(null);
                    }
                });
            });
        }


        // Actualizar perfil
        async function updateProfile() {
            try {
                const nombre = document.getElementById('form-nombre').value.trim();
                const email = document.getElementById('form-email').value.trim();
                const password = document.getElementById('password').value;
                const passwordConfirm = document.getElementById('password_confirm').value;

                if (!nombre || !email) {
                    showMessage('Nombre y email son obligatorios', 'error');
                    return;
                }

                if (password && password !== passwordConfirm) {
                    showMessage('Las contrase√±as no coinciden', 'error');
                    return;
                }

                showMessage('Actualizando perfil...', 'info');

                // Actualizar perfil en Firebase Auth
                if (nombre !== currentUser.displayName) {
                    await currentUser.updateProfile({ displayName: nombre });
                }

                // Actualizar email si es necesario
                if (email !== currentUser.email) {
                    await currentUser.updateEmail(email);
                }

                // Actualizar contrase√±a si se proporcion√≥
                if (password) {
                    await currentUser.updatePassword(password);
                }

                // Preparar datos de actualizaci√≥n
                const updateData = {
                    nombre: nombre,
                    email: email,
                    fecha_actualizacion: firebase.firestore.FieldValue.serverTimestamp()
                };

                // Agregar datos de vendedor si tiene el rol
                const tieneRolVendedor = userData.roles && userData.roles.includes('vendedor');
                if (tieneRolVendedor) {
                    const nombreTiendaInput = document.getElementById('nombre_tienda_perfil');
                    const ubicacionInput = document.getElementById('ubicacion_perfil');
                    const ubicacionLatInput = document.getElementById('ubicacion_lat_perfil');
                    const ubicacionLngInput = document.getElementById('ubicacion_lng_perfil');
                    const ubicacionFormattedInput = document.getElementById('ubicacion_formatted_perfil');
                    
                    const nombreTienda = nombreTiendaInput?.value?.trim();
                    const ubicacion = ubicacionInput?.value?.trim();
                    const ubicacionLat = ubicacionLatInput?.value;
                    const ubicacionLng = ubicacionLngInput?.value;
                    const ubicacionFormatted = ubicacionFormattedInput?.value;

                    if (nombreTienda) {
                        updateData.nombre_tienda = nombreTienda;
                    }

                    if (ubicacion) {
                        updateData.ubicacion = ubicacion;
                        
                        // Agregar coordenadas si est√°n disponibles
                        if (ubicacionLat && ubicacionLng) {
                            updateData.ubicacion_lat = parseFloat(ubicacionLat);
                            updateData.ubicacion_lng = parseFloat(ubicacionLng);
                            updateData.ubicacion_formatted = ubicacionFormatted || ubicacion;
                        } else if (ubicacion) {
                            updateData.ubicacion_formatted = ubicacion;
                        }
                    }
                }

                // Subir foto de perfil si se seleccion√≥ una nueva
                if (selectedProfilePhoto) {
                    try {
                        showMessage('Subiendo foto de perfil...', 'info');
                        const fotoUrl = await subirFotoPerfil(selectedProfilePhoto);
                        if (fotoUrl) {
                            updateData.foto_perfil = fotoUrl;
                            // Tambi√©n actualizar la foto en Firebase Auth
                            await currentUser.updateProfile({
                                photoURL: fotoUrl
                            });
                        }
                    } catch (error) {
                        console.error('‚ùå Error subiendo foto de perfil:', error);
                        showMessage('Error al subir la foto de perfil', 'error');
                    }
                }

                // Actualizar datos en Firestore
                await db.collection('usuarios').doc(currentUser.uid).update(updateData);

                // Limpiar foto seleccionada
                selectedProfilePhoto = null;

                // Recargar datos
                await loadUserData();
                showMessage('Perfil actualizado correctamente', 'success');

                // Limpiar campos de contrase√±a
                document.getElementById('password').value = '';
                document.getElementById('password_confirm').value = '';

            } catch (error) {
                console.error('‚ùå Error actualizando perfil:', error);
                let errorMessage = 'Error al actualizar el perfil';
                
                switch (error.code) {
                    case 'auth/requires-recent-login':
                        errorMessage = 'Debes volver a iniciar sesi√≥n para cambiar el email';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'La contrase√±a es muy d√©bil';
                        break;
                    case 'auth/email-already-in-use':
                        errorMessage = 'El email ya est√° en uso';
                        break;
                    default:
                        errorMessage = error.message;
                }
                
                showMessage(errorMessage, 'error');
            }
        }

        // Mostrar mensajes (con notificaciones desde la esquina)
        function showMessage(message, type = 'info') {
            // Crear elemento de notificaci√≥n
            const notificacion = document.createElement('div');
            notificacion.className = 'notificacion-mensaje';
            
            // Colores seg√∫n el tipo
            const colors = {
                success: '#4CAF50',
                error: '#f44336',
                warning: '#ff9800',
                info: '#2196F3'
            };
            
            // Iconos seg√∫n el tipo
            const icons = {
                success: 'check-circle',
                error: 'exclamation-circle',
                warning: 'exclamation-triangle',
                info: 'info-circle'
            };
            
            notificacion.innerHTML = `
                <i class="fas fa-${icons[type] || icons.info}"></i>
                ${message}
            `;
            
            // Agregar estilos
            notificacion.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${colors[type] || colors.info};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                font-weight: 500;
                display: flex;
                align-items: center;
                gap: 0.5rem;
                animation: slideIn 0.3s ease;
            `;
            
            // Agregar animaci√≥n CSS si no existe
            if (!document.querySelector('#notificacion-styles')) {
                const style = document.createElement('style');
                style.id = 'notificacion-styles';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(notificacion);
            
            // Remover despu√©s de 3 segundos con animaci√≥n de salida
            setTimeout(() => {
                notificacion.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (notificacion.parentNode) {
                        notificacion.parentNode.removeChild(notificacion);
                    }
                }, 300);
            }, 3000);
        }

        // Mostrar indicador de carga
        function showLoading() {
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading-indicator';
            loadingDiv.className = 'flash info';
            loadingDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cargando perfil...';
            
            const mainContent = document.querySelector('.main-content');
            mainContent.insertBefore(loadingDiv, mainContent.firstChild);
        }

        // Ocultar indicador de carga
        function hideLoading() {
            const loadingDiv = document.getElementById('loading-indicator');
            if (loadingDiv) {
                loadingDiv.remove();
            }
        }

        // Inicializar cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ ===== DOMContentLoaded - Iniciando perfil de usuario =====');
            console.log('üìã Verificando elementos del DOM...');
            const sidebarAvatarImg = document.getElementById('sidebar-avatar-img');
            const sidebarAvatarIcon = document.getElementById('sidebar-avatar-icon');
            console.log('üñºÔ∏è Elementos del avatar encontrados:', {
                sidebarAvatarImg: !!sidebarAvatarImg,
                sidebarAvatarIcon: !!sidebarAvatarIcon
            });
            console.log('üîÑ Inicializando perfil de usuario...');
            showLoading();
            
            try {
                const firebaseReady = await initializeFirebase();
                if (firebaseReady) {
                    // Ocultar enlaces por defecto para evitar parpadeos
                    const navPanelComprador = document.getElementById('nav-panel-comprador');
                    const navPanelVendedor = document.getElementById('nav-panel-vendedor');
                    if (navPanelComprador) navPanelComprador.style.display = 'none';
                    if (navPanelVendedor) navPanelVendedor.style.display = 'none';

                    // Suscribirse en tiempo real a roles del usuario
                    try {
                        const user = auth.currentUser || await new Promise(resolve => auth.onAuthStateChanged(resolve));
                        if (user && db) {
                            if (window.__perfilRolesUnsub) { 
                                try { 
                                    window.__perfilRolesUnsub(); 
                                } catch(e) {
                                    console.warn('Error cancelando suscripci√≥n anterior:', e);
                                } 
                            }
                            window.__perfilRolesUnsub = db.collection('usuarios').doc(user.uid)
                                .onSnapshot(async (doc) => {
                                    if (doc && doc.exists) {
                                        userData = doc.data() || {};
                                        await updateNavbarVisibility();
                                        try { 
                                            updateQuickAccess(userData.roles || []); 
                                        } catch(e) { 
                                            console.warn('Error en updateQuickAccess:', e); 
                                        }
                                    }
                                }, (err) => console.warn('onSnapshot roles error:', err));
                        }
                    } catch (e) { 
                        console.warn('No se pudo suscribir a roles en tiempo real:', e); 
                    }

                    console.log('üì• Llamando a loadUserData...');
                    await loadUserData();
                    console.log('‚úÖ loadUserData completado');
                } else {
                    console.error('‚ùå Firebase no se inicializ√≥ correctamente');
                    showMessage('Error al inicializar Firebase', 'error');
                }
            } catch (error) {
                console.error('‚ùå Error inicializando perfil:', error);
                console.error('Stack:', error.stack);
                showMessage('Error al cargar el perfil', 'error');
            } finally {
                hideLoading();
            }

            // Configurar handlers de foto de perfil
            console.log('‚öôÔ∏è Configurando handlers de foto de perfil...');
            setupProfilePhotoHandlers();
            console.log('‚úÖ Handlers de foto de perfil configurados');

            // Event listeners
            const btnActualizar = document.getElementById('btn-actualizar');
            if (btnActualizar) {
                btnActualizar.addEventListener('click', (e) => {
                e.preventDefault();
                updateProfile();
            });
            } else {
                console.warn('‚ö†Ô∏è Bot√≥n btn-actualizar no encontrado');
            }

            const btnCancelar = document.getElementById('btn-cancelar');
            if (btnCancelar) {
                btnCancelar.addEventListener('click', () => {
                // Recargar datos originales
                loadUserData();
                    const passwordInput = document.getElementById('password');
                    const passwordConfirmInput = document.getElementById('password_confirm');
                    if (passwordInput) passwordInput.value = '';
                    if (passwordConfirmInput) passwordConfirmInput.value = '';
                    // Limpiar foto seleccionada
                    selectedProfilePhoto = null;
                    const profilePhotoInput = document.getElementById('profilePhotoInput');
                    if (profilePhotoInput) profilePhotoInput.value = '';
                });
            }

            // Event listeners para gesti√≥n de roles
            const btnAgregarVendedor = document.getElementById('btn-agregar-vendedor');
            if (btnAgregarVendedor) {
                btnAgregarVendedor.addEventListener('click', () => {
                const roles = userData.roles || [];
                if (roles.includes('comprador')) {
                    agregarRolVendedor();
                } else if (roles.includes('vendedor')) {
                    agregarRolComprador();
                }
            });
            }

            const btnEliminarRol = document.getElementById('btn-eliminar-rol');
            if (btnEliminarRol) {
                btnEliminarRol.addEventListener('click', () => {
                eliminarRol();
            });
            }

            // El bot√≥n de cambiar rol ahora se configura din√°micamente en updateRolesInfo

            // Funci√≥n para simular roles m√∫ltiples (solo para pruebas)
            window.simularRolesMultiples = function() {
                if (userData) {
                    userData.roles = ['comprador', 'vendedor'];
                    userData.rol_activo = 'comprador';
                    updateRolesDisplay();
                    showMessage('Roles m√∫ltiples simulados para pruebas', 'info');
                }
            };

            // Funci√≥n para cambiar rol r√°pidamente (solo para pruebas)
            window.cambiarRolRapido = function(rol) {
                if (userData) {
                    userData.rol_activo = rol;
                    updateRolesDisplay();
                    showMessage(`Rol cambiado a ${rol} (simulaci√≥n)`, 'info');
                }
            };


            // Inicializar Google Places Autocomplete para perfil
            let autocompletePerfil = null;
            
            window.initGooglePlacesPerfil = function() {
                try {
                    if (typeof google === 'undefined' || !google.maps || !google.maps.places) {
                        console.log('‚ö†Ô∏è Google Maps Places API a√∫n no est√° cargado');
                        return;
                    }
                    
                    const ubicacionInput = document.getElementById('ubicacion_perfil');
                    if (!ubicacionInput) {
                        console.log('‚ö†Ô∏è Campo de ubicaci√≥n no encontrado');
                        return;
                    }
                    
                    if (autocompletePerfil) {
                        console.log('‚úÖ Google Places Autocomplete ya est√° inicializado');
                        return;
                    }
                    
                    autocompletePerfil = new google.maps.places.Autocomplete(ubicacionInput, {
                        componentRestrictions: { country: 'mx' }, // Restringir a M√©xico
                        fields: ['formatted_address', 'geometry', 'name'],
                        types: ['establishment', 'geocode']
                    });

                    autocompletePerfil.addListener('place_changed', function() {
                        try {
                            const place = autocompletePerfil.getPlace();
                            if (!place.geometry) {
                                console.log('‚ö†Ô∏è No se encontr√≥ informaci√≥n del lugar');
                                return;
                            }

                            // Guardar datos del lugar
                            const latInput = document.getElementById('ubicacion_lat_perfil');
                            const lngInput = document.getElementById('ubicacion_lng_perfil');
                            const formattedInput = document.getElementById('ubicacion_formatted_perfil');
                            
                            if (formattedInput) formattedInput.value = place.formatted_address || '';
                            if (latInput) latInput.value = place.geometry.location.lat();
                            if (lngInput) lngInput.value = place.geometry.location.lng();
                            
                            console.log('‚úÖ Ubicaci√≥n seleccionada:', place.formatted_address);
                        } catch (error) {
                            console.error('‚ùå Error en place_changed:', error);
                        }
                    });
                    
                    console.log('‚úÖ Google Places Autocomplete inicializado correctamente');
                } catch (error) {
                    console.error('‚ùå Error inicializando Google Places Autocomplete:', error);
                }
            };

            // Esperar a que Google Maps se cargue para perfil
            window.addEventListener('load', function() {
                setTimeout(function() {
                    const vendedorFields = document.getElementById('vendedor-perfil-fields');
                    if (vendedorFields && vendedorFields.style.display !== 'none') {
                        if (typeof window.initGooglePlacesPerfil === 'function') {
                            window.initGooglePlacesPerfil();
                        }
                    }
                }, 1000);
            });
        });
    </script>
</body>
</html>