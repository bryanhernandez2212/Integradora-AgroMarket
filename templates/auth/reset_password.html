<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restablecer Contraseña - AgroMarket</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/auth.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>
    <div class="auth-wrapper">
        <!-- Solo lado del formulario -->
        <div class="form-side" style="flex: 1; width: 100%;">
            <div style="text-align: center; margin-bottom: 30px;">
                <div class="logo-auth" style="font-size: 2rem; color: #2ba656;">
                    <i class="fas fa-leaf" style="color: #7ff29c;"></i>AgroMarket
                </div>
            </div>

            <h1>Restablecer Contraseña</h1>
            <p class="form-subtitle">Ingresa tu nueva contraseña y confírmala para completar el proceso</p>

            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="flash {{ category }}">
                            <i class="fas fa-{% if category == 'success' %}check-circle{% elif category == 'error' %}exclamation-circle{% elif category == 'warning' %}exclamation-triangle{% else %}info-circle{% endif %}"></i>
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            {% if not valid %}
                <div class="flash danger">
                    <i class="fas fa-exclamation-circle"></i>
                    No tienes autorización para restablecer la contraseña. Por favor, verifica el código primero.
                </div>
                <div class="links">
                    <a href="{{ url_for('auth.forgot_password') }}">
                        <i class="fas fa-key"></i> Solicitar Nuevo Código
                    </a>
                </div>
            {% else %}
            <form method="POST" id="resetForm">
                <!-- Nueva Contraseña -->
                <div class="input-group">
                    <label for="password">Nueva Contraseña</label>
                    <input type="password" name="password" id="password" placeholder="Mínimo 6 caracteres" required minlength="6" autocomplete="new-password">
                    <i class="fas fa-eye toggle-password" id="togglePassword1"></i>
                </div>

                <!-- Indicador de fuerza de contraseña -->
                <div class="password-strength" id="passwordStrength" style="display: none;">
                    <div class="strength-bar">
                        <div class="strength-fill" id="strengthFill"></div>
                    </div>
                    <ul id="passwordRequirements">
                        <li id="req-length">Al menos 6 caracteres</li>
                        <li id="req-letter">Contiene letras</li>
                        <li id="req-number">Contiene números</li>
                    </ul>
                </div>

                <!-- Confirmar Contraseña -->
                <div class="input-group">
                    <label for="password_confirm">Confirmar Nueva Contraseña</label>
                    <input type="password" name="password_confirm" id="password_confirm" placeholder="Repite tu contraseña" required minlength="6" autocomplete="new-password">
                    <i class="fas fa-eye toggle-password" id="togglePassword2"></i>
                </div>

                <button type="submit" class="btn-primary">
                    <i class="fas fa-key"></i> Restablecer Contraseña
                </button>
            </form>

            <div class="links">
                <a href="{{ url_for('auth.login') }}">
                    <i class="fas fa-arrow-left"></i> Volver al Inicio de Sesión
                </a>
                <div class="divider">
                    <span>o</span>
                </div>
                <a href="{{ url_for('general.home') }}">
                    <i class="fas fa-home"></i> Volver al Inicio
                </a>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="{{ url_for('static', filename='js/firebase-config.js') }}"></script>
    
    <script>
        // Inicializar Firebase
        let auth = null;
        if (typeof firebase !== 'undefined' && window.firebaseConfig) {
            try {
                if (firebase.apps.length === 0) {
                    firebase.initializeApp(window.firebaseConfig);
                }
                auth = firebase.auth();
            } catch (e) {
                console.error('Error inicializando Firebase:', e);
            }
        }
        
        // Mostrar/ocultar contraseña
        const togglePassword1 = document.getElementById('togglePassword1');
        const togglePassword2 = document.getElementById('togglePassword2');
        const passwordInput1 = document.getElementById('password');
        const passwordInput2 = document.getElementById('password_confirm');
        const passwordStrength = document.getElementById('passwordStrength');
        const strengthFill = document.getElementById('strengthFill');

        togglePassword1.addEventListener('click', function() {
            const type = passwordInput1.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput1.setAttribute('type', type);
            this.classList.toggle('fa-eye');
            this.classList.toggle('fa-eye-slash');
        });

        togglePassword2.addEventListener('click', function() {
            const type = passwordInput2.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput2.setAttribute('type', type);
            this.classList.toggle('fa-eye');
            this.classList.toggle('fa-eye-slash');
        });

        // Validador de fuerza de contraseña
        passwordInput1.addEventListener('input', function() {
            const password = this.value;
            
            if (password.length > 0) {
                passwordStrength.style.display = 'block';
            } else {
                passwordStrength.style.display = 'none';
                return;
            }

            // Verificar requisitos
            const hasLength = password.length >= 6;
            const hasLetter = /[a-zA-Z]/.test(password);
            const hasNumber = /[0-9]/.test(password);

            // Actualizar indicadores visuales
            updateRequirement('req-length', hasLength);
            updateRequirement('req-letter', hasLetter);
            updateRequirement('req-number', hasNumber);

            // Calcular fuerza
            let strength = 0;
            if (hasLength) strength++;
            if (hasLetter) strength++;
            if (hasNumber) strength++;

            // Actualizar barra
            strengthFill.className = 'strength-fill';
            if (strength === 1) {
                strengthFill.classList.add('weak');
            } else if (strength === 2) {
                strengthFill.classList.add('medium');
            } else if (strength === 3) {
                strengthFill.classList.add('strong');
            }

            // Verificar coincidencia de contraseñas
            checkPasswordMatch();
        });

        passwordInput2.addEventListener('input', function() {
            checkPasswordMatch();
        });

        function updateRequirement(id, isValid) {
            const element = document.getElementById(id);
            if (isValid) {
                element.classList.add('valid');
            } else {
                element.classList.remove('valid');
            }
        }

        function checkPasswordMatch() {
            const password = passwordInput1.value;
            const confirmPassword = passwordInput2.value;
            
            if (confirmPassword && password !== confirmPassword) {
                passwordInput2.style.borderColor = '#dc3545';
            } else {
                passwordInput2.style.borderColor = '#d1d5db';
            }
        }

        // Validación y cambio de contraseña usando Firebase Auth
        const resetForm = document.getElementById('resetForm');
        const submitBtn = resetForm ? resetForm.querySelector('.btn-primary') : null;

        if (resetForm && submitBtn) {
            resetForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const password = passwordInput1.value.trim();
                const confirmPassword = passwordInput2.value.trim();
                const email = '{{ email }}' || '';

                let errores = [];

                // Validar contraseña
                if (password.length < 6) {
                    errores.push('La contraseña debe tener al menos 6 caracteres');
                }

                // Validar coincidencia
                if (password !== confirmPassword) {
                    errores.push('Las contraseñas no coinciden');
                }

                if (errores.length > 0) {
                    alert('❌ Errores en el formulario:\n\n' + errores.join('\n'));
                    submitBtn.classList.remove('loading');
                    submitBtn.disabled = false;
                    return;
                }

                submitBtn.classList.add('loading');
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cambiando contraseña...';

                try {
                    // Intentar cambiar contraseña desde el backend primero
                    const response = await fetch('{{ url_for("auth.reset_password") }}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            password: password,
                            password_confirm: confirmPassword
                        })
                    });
                    
                    // Verificar respuesta
                    let data;
                    const contentType = response.headers.get('content-type');
                    
                    if (contentType && contentType.includes('application/json')) {
                        data = await response.json();
                    } else {
                        const text = await response.text();
                        console.error('Respuesta del servidor:', text);
                        // Si el backend falla, intentar con Firebase Auth REST API directamente
                        data = { success: false };
                    }
                    
                    if (data && data.success) {
                        // Contraseña cambiada exitosamente desde el backend
                        alert('✅ Contraseña restablecida exitosamente. Redirigiendo al login...');
                        window.location.href = '{{ url_for("auth.login") }}';
                        return;
                    }
                    
                    // Si el backend falla, intentar con Firebase Auth REST API directamente
                    console.log('⚠️ Backend falló, intentando con Firebase Auth REST API...');
                    
                    // Obtener código de la sesión (si está disponible)
                    const code = '{{ session.get("reset_password_code", "") }}';
                    
                    if (!code) {
                        throw new Error('No se pudo obtener el código de verificación. Por favor, solicita un nuevo código.');
                    }
                    
                    // Usar Firebase Auth REST API para cambiar contraseña
                    const apiKey = 'AIzaSyDZWmY0ggZthOKv17yHH57pkXsie_U2YnI';
                    const projectId = 'agromarket-625b2';
                    
                    // Primero, necesitamos autenticar al usuario con el código
                    // Pero Firebase Auth REST API requiere un código OOB de Firebase, no nuestro código personalizado
                    // Por lo tanto, debemos usar el backend
                    
                    // Si llegamos aquí, el backend falló y no hay alternativa
                    const errorMsg = data?.message || 'No se pudo cambiar la contraseña. El servidor necesita configuración adicional. Por favor, contacta al administrador.';
                    alert('❌ ' + errorMsg);
                    submitBtn.classList.remove('loading');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-key"></i> Restablecer Contraseña';
                    
                } catch (error) {
                    console.error('❌ Error completo:', error);
                    console.error('❌ Stack:', error.stack);
                    
                    let errorMessage = 'Error al procesar la solicitud. Por favor, intenta más tarde.';
                    
                    if (error.message) {
                        if (error.message.includes('Firebase')) {
                            errorMessage = 'Error con Firebase. Por favor, verifica tu conexión e intenta nuevamente.';
                        } else if (error.message.includes('fetch')) {
                            errorMessage = 'Error de conexión. Por favor, verifica tu internet e intenta nuevamente.';
                        } else {
                            errorMessage = 'Error: ' + error.message;
                        }
                    }
                    
                    alert('❌ ' + errorMessage);
                    submitBtn.classList.remove('loading');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-key"></i> Restablecer Contraseña';
                }
            });
        }
    </script>
</body>
</html>