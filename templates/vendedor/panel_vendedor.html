<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Vendedor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-Yd3F2m9Uq+vR0NvKcJsteVEh9UpAJZciV06P88GJEqn3Ejj6+UeJ8V+RaH59RUW2KIiMzZljI0X58F3Rp3crJQ==" crossorigin="anonymous" referrerpolicy="no-referrer">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/navbar.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/estilos_vendedor.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/breadcrumbs.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/navigation-header.css') }}">
    <script src="{{ url_for('static', filename='js/mobile-menu.js') }}" defer></script>

    <!-- PWA: Manifest y theme color -->
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <meta name="theme-color" content="#2e8b57">

    <!-- Iconos -->
  <link rel="icon" type="image/png" sizes="192x192" href="{{ url_for('static', filename='images/icons/icons-192.png') }}">
<link rel="apple-touch-icon" sizes="512x512" href="{{ url_for('static', filename='images/icons/icons-512.png') }}">

</head>
<body data-vendor-id="{{ usuario_id or '' }}" data-vendor-email="{{ correo or '' }}">
    <!-- ===== Overlay para m√≥viles ===== -->
    <div class="sidebar-overlay" id="sidebar-overlay"></div>
    
    <!--Menu-->
    <nav>
        <button class="menu-toggle" id="menu-toggle" aria-label="Abrir men√∫">
            <span></span>
            <span></span>
            <span></span>
        </button>
        <div class="nav-left">
            <div class="logo"><h2>AgroMarket</h2></div>
            <div class="saludo-usuario">Hola, <strong>{{ nombre }}</strong></div>
        </div>
        <div class="menu">
            <a href="/vendedor/panel" id="nav-inicio-vendedor" {% if page == 'inicio' %}class="activo"{% endif %}>
                <i class="fas fa-home"></i>
                <span>Home</span>
            </a>
            <a href="/vendedor/agregar_producto" id="nav-agregar-vendedor" {% if page == 'agregar' %}class="activo"{% endif %}>
                <i class="fas fa-plus-circle"></i>
                <span>Agregar Productos</span>
            </a>
            <a href="/vendedor/mis_productos" id="nav-mis-productos-vendedor" {% if page == 'productos' %}class="activo"{% endif %}>
                <i class="fas fa-box"></i>
                <span>Mis Productos</span>
            </a>
            <a href="/vendedor/ventas" id="nav-ventas-vendedor" {% if page == 'ventas' %}class="activo"{% endif %}>
                <i class="fas fa-chart-line"></i>
                <span>Ventas</span>
            </a>
            <a href="/vendedor/chats" id="nav-chats-vendedor" {% if page == 'chats' %}class="activo"{% endif %}>
                <i class="fas fa-comments"></i>
                <span>Chats</span>
            </a>
            <a href="/auth/perfil" {% if page == 'perfil' %}class="activo"{% endif %}>
                <i class="fas fa-user"></i>
                <span>Mi Perfil</span>
            </a>
            <a href="#" onclick="cerrarSesion()">
                <i class="fas fa-sign-out-alt"></i>
                <span>Cerrar Sesi√≥n</span>
            </a>
        </div>
    </nav>
    
    <!-- ===== Sidebar para m√≥viles ===== -->
    <aside class="sidebar-menu" id="sidebar-menu">
        <!-- Header con foto de perfil y nombre -->
        <div class="sidebar-header-profile">
            <div class="sidebar-profile-avatar" id="sidebar-profile-avatar">
                <img id="sidebar-profile-avatar-img" src="" alt="Foto de perfil" style="display: none;">
                <i class="fas fa-user-circle" id="sidebar-profile-avatar-icon"></i>
            </div>
            <div class="sidebar-profile-info">
                <p class="sidebar-profile-name" id="sidebar-profile-name">{{ nombre }}</p>
                <p class="sidebar-profile-email" id="sidebar-profile-email">{{ correo or '' }}</p>
            </div>
        </div>
        <div class="menu">
            <a href="/vendedor/panel" id="sidebar-inicio-vendedor" {% if page == 'inicio' %}class="activo"{% endif %}>
                <span>Home</span>
            </a>
            <a href="/vendedor/agregar_producto" id="sidebar-agregar-vendedor" {% if page == 'agregar' %}class="activo"{% endif %}>
                <span>Agregar Productos</span>
            </a>
            <a href="/vendedor/mis_productos" id="sidebar-mis-productos-vendedor" {% if page == 'productos' %}class="activo"{% endif %}>
                <span>Mis Productos</span>
            </a>
            <a href="/vendedor/ventas" id="sidebar-ventas-vendedor" {% if page == 'ventas' %}class="activo"{% endif %}>
                <span>Ventas</span>
            </a>
            <a href="/vendedor/chats" id="sidebar-chats-vendedor" {% if page == 'chats' %}class="activo"{% endif %}>
                <span>Chats</span>
            </a>
            <a href="/auth/perfil" {% if page == 'perfil' %}class="activo"{% endif %}>
                <span>Mi Perfil</span>
            </a>
            <a href="#" onclick="cerrarSesion()">
                <span>Cerrar Sesi√≥n</span>
            </a>
        </div>
    </aside>

<main>
    <!-- Navigation Header -->
    <div class="navigation-header">
        <div></div>
        <div class="breadcrumbs">
            <a href="/vendedor/panel">Inicio</a>
        </div>
    </div>
    <!-- Mensajes flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-messages">
          {% for category, message in messages %}
            <div class="alert {{ category }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <section class="stripe-connect-card" id="stripe-connect-card">
        <div class="stripe-card-header">
            <div>
                <h2>Gu√≠a para empezar a utilizar AgroMarket</h2>
                <p class="stripe-card-description">
                    Para empezar a vender en AgroMarket, debes seguir los siguientes pasos:
                </p>
            </div>
        </div>

        <div class="stripe-status-grid" id="stripe-status-grid">
            <div class="stripe-status-item pending" data-status="charges">
                <div class="icon">
                    <img src="/static/images/calendario.png" alt="icono" />
                </div>
                <div class="details">
                    <h3>D√≠as H√°biles</h3>
                    <p>Debes tener en cuenta que por cada pedido tendr√°s 2 d√≠as h√°biles para poder enviar tu producto</p>
                </div>
            </div>
            <div class="stripe-status-item pending" data-status="payouts">
                <div class="icon">
                    <img src="/static/images/transferencia.png" alt="icono" />
                </div>
                <div class="details">
                    <h3>Transferencias</h3>
                    <p>Todos los pagos ser√°n por tarjeta de cr√©dito/d√©bito</p>
                </div>
            </div>
            <div class="stripe-status-item pending" data-status="details">
                <div class="icon">
                    <img src="/static/images/chats.png" alt="icono" />
                </div>
                <div class="details">
                    <h3>Chatea con tus clientes</h3>
                    <p>Utiliza la plataforma para comunicarte directamente con tus compradores</p>
                </div>
            </div>
        </div>
    </section>

</main>

<script>
    (function () {
        const body = document.body;
        if (!body) {
            return;
        }
        const vendorId = body.dataset.vendorId || "";
        const vendorEmail = body.dataset.vendorEmail || "";

        if (vendorId) {
            try {
                localStorage.setItem("firebase_uid", vendorId);
                sessionStorage.setItem("firebase_uid", vendorId);
            } catch (err) {
                console.warn("Stripe Connect: no se pudo guardar firebase_uid en storage.", err);
            }
        }

        if (vendorEmail) {
            try {
                localStorage.setItem("firebase_email", vendorEmail);
                sessionStorage.setItem("firebase_email", vendorEmail);
            } catch (err) {
                console.warn("Stripe Connect: no se pudo guardar firebase_email en storage.", err);
            }
        }
    })();
</script>

<script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("{{ url_for('static', filename='js/service-worker.js') }}")
    .then((reg) => console.log("Service Worker registrado:", reg))
    .catch((err) => console.error("Error al registrar el SW:", err));
  }
</script>

<!--<script src="{{ url_for('static', filename='js/stripe-connect.js') }}"></script>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/12.4.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.4.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore-compat.js"></script>
<!-- Configuraci√≥n de Firebase -->
<script>
    // Configuraci√≥n de Firebase
    window.firebaseConfig = {
        apiKey: "AIzaSyDZWmY0ggZthOKv17yHH57pkXsie_U2YnI",
        authDomain: "agromarket-625b2.firebaseapp.com",
        projectId: "agromarket-625b2",
        storageBucket: "agromarket-625b2.firebasestorage.app",
        messagingSenderId: "18163605615",
        appId: "1:18163605615:web:6910d608e280b028d6ad9a",
        measurementId: "G-CVL9DRNMG1"
    };
</script>
<!-- Protecci√≥n contra acceso despu√©s de logout - DEBE cargarse ANTES de inicializar Firebase -->
<script src="{{ url_for('static', filename='js/auth-protection.js') }}"></script>

<script>
    // Inicializar Firebase
    firebase.initializeApp(window.firebaseConfig);
    const auth = firebase.auth();

    // Verificar autenticaci√≥n
    auth.onAuthStateChanged((user) => {
        if (user) {
            console.log('Usuario autenticado:', user.email);
            // Actualizar el nombre del usuario en la p√°gina
            const saludoElement = document.querySelector('.saludo-usuario strong');
            if (saludoElement) {
                saludoElement.textContent = user.displayName || user.email;
            }
        } else {
            // Si no hay usuario, verificar tambi√©n la sesi√≥n del servidor
            console.log('‚ö†Ô∏è No hay usuario en Firebase, verificando sesi√≥n del servidor...');
            fetch('/auth/verificar-sesion', {
                method: 'GET',
                credentials: 'same-origin'
            }).then(response => {
                if (!response.ok || response.status === 401) {
                    console.log('üîí Sesi√≥n del servidor tambi√©n inv√°lida, redirigiendo...');
                    window.location.replace('/auth/login');
                }
            }).catch(error => {
                console.error('Error verificando sesi√≥n:', error);
                // En caso de error, redirigir por seguridad
                window.location.replace('/auth/login');
            });
        }
    });

    // Funci√≥n para cerrar sesi√≥n
    function cerrarSesion() {
        if (confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n?')) {
            // Usar funci√≥n centralizada si est√° disponible
            if (window.cerrarSesionCompleto) {
                window.cerrarSesionCompleto();
            } else if (window.handleLogout) {
                window.handleLogout();
            } else {
                // Limpiar almacenamiento local
                const keysToRemove = ['firebase_uid', 'firebase_email', 'user_roles', 'user_rol_activo', 'user_nombre', 'carrito', 'totalAmount', 'paymentIntentId', 'paymentDate', 'paymentMethod'];
                keysToRemove.forEach(key => {
                    localStorage.removeItem(key);
                    sessionStorage.removeItem(key);
                });
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith('stripe_') || key.startsWith('STRIPE_')) {
                        localStorage.removeItem(key);
                    }
                });
                Object.keys(sessionStorage).forEach(key => {
                    if (key.startsWith('stripe_') || key.startsWith('STRIPE_')) {
                        sessionStorage.removeItem(key);
                    }
                });
                
                // Usar Firebase si est√° disponible
                if (window.initializeFirebaseInstant) {
                    window.initializeFirebaseInstant().then(({ auth }) => {
                        auth.signOut().then(() => {
                            console.log('‚úÖ Sesi√≥n cerrada correctamente');
                            window.location.href = '/auth/login';
                        }).catch((error) => {
                            console.error('‚ùå Error al cerrar sesi√≥n:', error);
                            window.location.href = '/auth/login';
                        });
                    }).catch(() => {
                        window.location.href = '/auth/login';
                    });
                } else {
                    window.location.href = '/auth/login';
                }
            }
        }
    }

    // Actualizar enlaces de logout
    document.addEventListener('DOMContentLoaded', function() {
        const logoutLinks = document.querySelectorAll('a[href*="logout"]');
        logoutLinks.forEach(link => {
            link.onclick = function(e) {
                e.preventDefault();
                cerrarSesion();
            };
        });
    });
</script>
</body>
</html>
