<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Vendedor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-Yd3F2m9Uq+vR0NvKcJsteVEh9UpAJZciV06P88GJEqn3Ejj6+UeJ8V+RaH59RUW2KIiMzZljI0X58F3Rp3crJQ==" crossorigin="anonymous" referrerpolicy="no-referrer">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/navbar.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/estilos_vendedor.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/breadcrumbs.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/navigation-header.css') }}">
    <script src="{{ url_for('static', filename='js/mobile-menu.js') }}" defer></script>

    <!-- PWA: Manifest y theme color -->
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <meta name="theme-color" content="#2e8b57">

    <!-- Iconos -->
  <link rel="icon" type="image/png" sizes="192x192" href="{{ url_for('static', filename='images/icons/icons-192.png') }}">
<link rel="apple-touch-icon" sizes="512x512" href="{{ url_for('static', filename='images/icons/icons-512.png') }}">

</head>
<body data-vendor-id="{{ usuario_id or '' }}" data-vendor-email="{{ correo or '' }}">
    <!-- ===== Overlay para móviles ===== -->
    <div class="sidebar-overlay" id="sidebar-overlay"></div>
    
    <!--Menu-->
    <nav>
        <button class="menu-toggle" id="menu-toggle" aria-label="Abrir menú">
            <span></span>
            <span></span>
            <span></span>
        </button>
        <div class="nav-left">
            <div class="logo"><h2>AgroMarket</h2></div>
            <div class="saludo-usuario">Hola, <strong>{{ nombre }}</strong></div>
        </div>
        <div class="menu">
            <a href="/vendedor/panel" id="nav-inicio-vendedor" {% if page == 'inicio' %}class="activo"{% endif %}>
                <i class="fas fa-home"></i>
                <span>Home</span>
            </a>
            <a href="/vendedor/agregar_producto" id="nav-agregar-vendedor" {% if page == 'agregar' %}class="activo"{% endif %}>
                <i class="fas fa-plus-circle"></i>
                <span>Agregar Productos</span>
            </a>
            <a href="/vendedor/mis_productos" id="nav-mis-productos-vendedor" {% if page == 'productos' %}class="activo"{% endif %}>
                <i class="fas fa-box"></i>
                <span>Mis Productos</span>
            </a>
            <a href="/vendedor/ventas" id="nav-ventas-vendedor" {% if page == 'ventas' %}class="activo"{% endif %}>
                <i class="fas fa-chart-line"></i>
                <span>Ventas</span>
            </a>
            <a href="/vendedor/chats" id="nav-chats-vendedor" {% if page == 'chats' %}class="activo"{% endif %}>
                <i class="fas fa-comments"></i>
                <span>Chats</span>
            </a>
            <a href="/auth/perfil" {% if page == 'perfil' %}class="activo"{% endif %}>
                <i class="fas fa-user"></i>
                <span>Mi Perfil</span>
            </a>
            <a href="#" onclick="cerrarSesion()">
                <i class="fas fa-sign-out-alt"></i>
                <span>Cerrar Sesión</span>
            </a>
        </div>
    </nav>
    
    <!-- ===== Sidebar para móviles ===== -->
    <aside class="sidebar-menu" id="sidebar-menu">
        <!-- Header con foto de perfil y nombre -->
        <div class="sidebar-header-profile">
            <div class="sidebar-profile-avatar" id="sidebar-profile-avatar">
                <img id="sidebar-profile-avatar-img" src="" alt="Foto de perfil" style="display: none;">
                <i class="fas fa-user-circle" id="sidebar-profile-avatar-icon"></i>
            </div>
            <div class="sidebar-profile-info">
                <p class="sidebar-profile-name" id="sidebar-profile-name">{{ nombre }}</p>
                <p class="sidebar-profile-email" id="sidebar-profile-email">{{ correo or '' }}</p>
            </div>
        </div>
        <div class="menu">
            <a href="/vendedor/panel" id="sidebar-inicio-vendedor" {% if page == 'inicio' %}class="activo"{% endif %}>
                <span>Home</span>
            </a>
            <a href="/vendedor/agregar_producto" id="sidebar-agregar-vendedor" {% if page == 'agregar' %}class="activo"{% endif %}>
                <span>Agregar Productos</span>
            </a>
            <a href="/vendedor/mis_productos" id="sidebar-mis-productos-vendedor" {% if page == 'productos' %}class="activo"{% endif %}>
                <span>Mis Productos</span>
            </a>
            <a href="/vendedor/ventas" id="sidebar-ventas-vendedor" {% if page == 'ventas' %}class="activo"{% endif %}>
                <span>Ventas</span>
            </a>
            <a href="/vendedor/chats" id="sidebar-chats-vendedor" {% if page == 'chats' %}class="activo"{% endif %}>
                <span>Chats</span>
            </a>
            <a href="/auth/perfil" {% if page == 'perfil' %}class="activo"{% endif %}>
                <span>Mi Perfil</span>
            </a>
            <a href="#" onclick="cerrarSesion()">
                <span>Cerrar Sesión</span>
            </a>
        </div>
    </aside>

<main>
    <!-- Navigation Header -->
    <div class="navigation-header">
        <div></div>
        <div class="breadcrumbs">
            <a href="/vendedor/panel">Inicio</a>
        </div>
    </div>
    <!-- Mensajes flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-messages">
          {% for category, message in messages %}
            <div class="alert {{ category }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <section class="stripe-connect-card" id="stripe-connect-card">
        <div class="stripe-card-header">
            <div>
                <h2>Configuración de cobros</h2>
                <p class="stripe-card-description">
                    Conecta tu cuenta de Stripe para recibir pagos y transferencias. Debes completar este paso para publicar tus productos.
                </p>
            </div>
            <span class="stripe-status-pill" id="stripe-status-pill">Pendiente</span>
        </div>

        <div class="stripe-status-grid" id="stripe-status-grid">
            <div class="stripe-status-item pending" data-status="charges">
                <div class="icon">
                    <i class="fas fa-credit-card"></i>
                </div>
                <div class="details">
                    <h3>Cobros habilitados</h3>
                    <p>Permite recibir pagos con tarjeta en tu tienda.</p>
                </div>
            </div>
            <div class="stripe-status-item pending" data-status="payouts">
                <div class="icon">
                    <i class="fas fa-money-bill-wave"></i>
                </div>
                <div class="details">
                    <h3>Transferencias</h3>
                    <p>Activa los depósitos automáticos a tu cuenta bancaria.</p>
                </div>
            </div>
            <div class="stripe-status-item pending" data-status="details">
                <div class="icon">
                    <i class="fas fa-user-check"></i>
                </div>
                <div class="details">
                    <h3>Verificación de datos</h3>
                    <p>Completa la información fiscal y de identidad requerida.</p>
                </div>
            </div>
        </div>

        <div class="stripe-callouts" id="stripe-callouts"></div>

        <div class="stripe-card-actions">
            <button class="btn-stripe-primary" id="stripe-onboarding-btn">
                <i class="fas fa-play-circle"></i>
                Completar configuración de cobros
            </button>
            <button class="btn-stripe-secondary" id="stripe-refresh-btn" type="button">
                <i class="fas fa-rotate"></i>
                Actualizar estado
            </button>
        </div>

        <p class="stripe-last-update" id="stripe-last-update" aria-live="polite"></p>
    </section>
</main>

<script>
    (function () {
        const body = document.body;
        if (!body) {
            return;
        }
        const vendorId = body.dataset.vendorId || "";
        const vendorEmail = body.dataset.vendorEmail || "";

        if (vendorId) {
            try {
                localStorage.setItem("firebase_uid", vendorId);
                sessionStorage.setItem("firebase_uid", vendorId);
            } catch (err) {
                console.warn("Stripe Connect: no se pudo guardar firebase_uid en storage.", err);
            }
        }

        if (vendorEmail) {
            try {
                localStorage.setItem("firebase_email", vendorEmail);
                sessionStorage.setItem("firebase_email", vendorEmail);
            } catch (err) {
                console.warn("Stripe Connect: no se pudo guardar firebase_email en storage.", err);
            }
        }
    })();
</script>

<script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("{{ url_for('static', filename='js/service-worker.js') }}")
    .then((reg) => console.log("Service Worker registrado:", reg))
    .catch((err) => console.error("Error al registrar el SW:", err));
  }
</script>

<script src="{{ url_for('static', filename='js/stripe-connect.js') }}"></script>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/12.4.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.4.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore-compat.js"></script>

<script>
    // Configuración de Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyDZWmY0ggZthOKv17yHH57pkXsie_U2YnI",
        authDomain: "agromarket-625b2.firebaseapp.com",
        projectId: "agromarket-625b2",
        storageBucket: "agromarket-625b2.firebasestorage.app",
        messagingSenderId: "18163605615",
        appId: "1:18163605615:web:6910d608e280b028d6ad9a",
        measurementId: "G-CVL9DRNMG1"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    // Verificar autenticación
    auth.onAuthStateChanged((user) => {
        if (user) {
            console.log('Usuario autenticado:', user.email);
            // Actualizar el nombre del usuario en la página
            const saludoElement = document.querySelector('.saludo-usuario strong');
            if (saludoElement) {
                saludoElement.textContent = user.displayName || user.email;
            }
        }
    });

    // Función para cerrar sesión
    function cerrarSesion() {
        if (confirm('¿Estás seguro de que quieres cerrar sesión?')) {
            // Usar Firebase si está disponible
            if (window.initializeFirebaseInstant) {
                window.initializeFirebaseInstant().then(({ auth }) => {
                    auth.signOut().then(() => {
                        console.log('✅ Sesión cerrada correctamente');
                        window.location.href = '/auth/login';
                    }).catch((error) => {
                        console.error('❌ Error al cerrar sesión:', error);
                        window.location.href = '/auth/login';
                    });
                }).catch(() => {
                    window.location.href = '/auth/login';
                });
            } else {
                window.location.href = '/auth/login';
            }
        }
    }

    // Actualizar enlaces de logout
    document.addEventListener('DOMContentLoaded', function() {
        const logoutLinks = document.querySelectorAll('a[href*="logout"]');
        logoutLinks.forEach(link => {
            link.onclick = function(e) {
                e.preventDefault();
                cerrarSesion();
            };
        });
    });
</script>
</body>
</html>
