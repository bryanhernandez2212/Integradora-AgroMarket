<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalle del Pedido | AgroMarket</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/navbar.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/estilos_comprador.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/breadcrumbs.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/navigation-header.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/detalle_pedido.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <!-- Firebase Config -->
    <script src="{{ url_for('static', filename='js/firebase-config.js') }}"></script>
    
    <!-- jsPDF para generar facturas PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body data-pedido-id="{{ pedido_id }}">
    <!-- ===== Menú superior ===== -->
    <nav>
        <div class="nav-left">
            <div class="logo"><h2>AgroMarket</h2></div>
            <div class="saludo-usuario">Hola, <strong>{{ nombre }}</strong></div>
        </div>
        <div class="menu">
            <a href="/comprador/panel" {% if page=='inicio' %}class="activo"{% endif %}>Inicio</a>
            <a href="/comprador/productos" {% if page=='productos' %}class="activo"{% endif %}>Productos</a>
            <a href="/comprador/carrito" {% if page=='carrito' %}class="activo"{% endif %}>Carrito</a>
            <a href="/comprador/mis_pedidos" {% if page=='mis_pedidos' %}class="activo"{% endif %}>Mis Pedidos</a>
            <a href="/comprador/chats" {% if page=='chats' %}class="activo"{% endif %}>Chats</a>
            <a href="/auth/perfil" {% if page=='perfil' %}class="activo"{% endif %}>Mi Perfil</a>
            <a href="/auth/logout">Cerrar Sesión</a>
        </div>
    </nav>

    <main class="main-content">
        <div class="detalle-pedido-container">
            <!-- Navigation Header -->
            <div class="navigation-header">
                <a href="/comprador/mis_pedidos" class="back-btn">
                    <i class="fas fa-arrow-left"></i>
                    Volver a mis pedidos
                </a>
                <div class="breadcrumbs">
                    <a href="/comprador/panel">Inicio</a>
                    <span>/</span>
                    <a href="/auth/perfil">Mi cuenta</a>
                    <span>/</span>
                    <a href="/comprador/mis_pedidos">Mis pedidos</a>
                    <span>/</span>
                    <span>Detalle del pedido</span>
                </div>
            </div>

            <!-- Título -->
            <div class="detalle-pedido-header">
                <div>
                    <h1>Mis pedidos</h1>
                    <h2>Detalle del pedido</h2>
                </div>
            </div>

            <!-- Loading state -->
            <div id="loading-detalle" class="loading-detalle">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Cargando detalles del pedido...</p>
            </div>

            <!-- Error state -->
            <div id="error-detalle" class="error-detalle" style="display: none;">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>Error al cargar el pedido</h3>
                <p>No se pudo cargar la información del pedido.</p>
                <a href="/comprador/mis_pedidos" class="btn-volver-lista">Volver a mis pedidos</a>
            </div>

            <!-- Contenido del pedido -->
            <div id="contenido-pedido" class="contenido-pedido" style="display: none;">
                <!-- Información del pedido -->
                <div class="card-detalle">
                    <div class="info-pedido-item">
                        <label>Número de pedido:</label>
                        <div class="info-pedido-value">
                            <span id="pedido-numero" class="pedido-numero-text"></span>
                            <button class="btn-copiar" onclick="copiarNumeroPedido()" title="Copiar número de pedido">
                                <i class="fas fa-clipboard"></i>
                            </button>
                        </div>
                    </div>
                    <div class="info-pedido-item">
                        <label>Fecha de compra:</label>
                        <span id="pedido-fecha" class="info-pedido-value-text"></span>
                    </div>
                </div>

                <!-- Detalles de pago -->
                <div class="card-detalle">
                    <h3 class="card-titulo">Detalles de tu pago</h3>
                    <div class="pago-info">
                        <div class="pago-method">
                            <label>Forma de pago</label>
                            <div class="pago-method-value">
                                <i id="pago-icono" class="fas"></i>
                                <span id="pago-metodo"></span>
                            </div>
                        </div>
                        <div class="pago-amount">
                            <span id="pago-total" class="pago-total-text"></span>
                        </div>
                    </div>
                    <a href="#" class="link-ver-detalles" id="link-ver-detalles" onclick="event.preventDefault(); toggleDetallesPago()">
                        Ver detalles de pago
                        <i class="fas fa-chevron-down" id="icon-ver-detalles"></i>
                    </a>
                    <!-- Detalles expandidos de la tarjeta -->
                    <div id="detalles-pago-expandidos" style="display: none; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid #e9ecef;">
                        <div id="detalles-pago-loading" style="text-align: center; padding: 1rem;">
                            <i class="fas fa-spinner fa-spin"></i> Cargando detalles...
                        </div>
                        <div id="detalles-pago-content" style="display: none;">
                            <div class="detalle-tarjeta-info">
                                <div class="detalle-tarjeta-item">
                                    <label>Tarjeta:</label>
                                    <div class="tarjeta-info">
                                        <span class="tarjeta-brand" id="tarjeta-brand"></span>
                                        <span class="tarjeta-number" id="tarjeta-number"></span>
                                    </div>
                                </div>
                                <div class="detalle-tarjeta-item">
                                    <label>Vencimiento:</label>
                                    <span id="tarjeta-exp"></span>
                                </div>
                            </div>
                        </div>
                        <div id="detalles-pago-error" style="display: none; padding: 1rem; background: #fee; color: #c33; border-radius: 8px; margin-top: 1rem;">
                            <i class="fas fa-exclamation-triangle"></i> No se pudieron cargar los detalles del pago.
                        </div>
                    </div>
                    <!-- Botón de devolución -->
                    <div id="devolucion-section" style="display: none; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid #e9ecef;">
                        <button id="btn-solicitar-devolucion-detalle" class="btn-solicitar-devolucion-detalle">
                            <i class="fas fa-undo"></i> Solicitar Devolución
                        </button>
                    </div>
                </div>

                <!-- Estado de entrega -->
                <div class="card-estado-entrega">
                    <div class="estado-header">
                        <div class="estado-mensaje">
                            <i id="estado-icono" class="fas"></i>
                            <span id="estado-mensaje-texto"></span>
                        </div>
                        <button class="btn-generar-factura" id="btn-generar-factura" onclick="generarFacturaPDF()">
                            <i class="fas fa-file-pdf"></i> Generar factura
                        </button>
                    </div>
                    <div class="estado-progreso">
                        <div class="progreso-item" id="progreso-confirmando">
                            <i class="fas fa-check-circle"></i>
                            <span>Confirmando</span>
                        </div>
                        <div class="progreso-linea" id="linea-confirmando-preparando"></div>
                        <div class="progreso-item" id="progreso-preparando">
                            <i class="fas fa-check-circle"></i>
                            <span>Preparando</span>
                        </div>
                        <div class="progreso-linea" id="linea-preparando-enviado"></div>
                        <div class="progreso-item" id="progreso-enviado">
                            <i class="fas fa-check-circle"></i>
                            <span>Enviado</span>
                        </div>
                        <div class="progreso-linea" id="linea-enviado-recibido"></div>
                        <div class="progreso-item" id="progreso-recibido">
                            <i class="fas fa-check-circle"></i>
                            <span>Recibido</span>
                        </div>
                    </div>
                </div>

                <!-- Envío a domicilio -->
                <div class="card-detalle">
                    <h3 class="card-titulo">
                        <i class="fas fa-truck"></i>
                        Envío a domicilio
                    </h3>
                    <div class="envio-info-grid">
                        <div class="envio-info-item">
                            <label>Envió</label>
                            <span id="envio-metodo" class="envio-value">AgroMarket Express</span>
                        </div>
                        <div class="envio-info-item">
                            <label>Recibe</label>
                            <span id="envio-recibe" class="envio-value"></span>
                        </div>
                        <div class="envio-info-item">
                            <label>Ciudad de entrega</label>
                            <span id="envio-ciudad" class="envio-value"></span>
                        </div>
                        <div class="envio-info-item">
                            <label>Teléfono de contacto</label>
                            <span id="envio-telefono" class="envio-value"></span>
                        </div>
                    </div>
                </div>

                <!-- Tus productos -->
                <div class="card-detalle">
                    <h3 class="card-titulo">
                        <i class="fas fa-box"></i>
                        Tus productos
                    </h3>
                    <div id="productos-lista-detalle" class="productos-lista-detalle">
                        <!-- Productos se cargarán dinámicamente -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal para comentar/calificar vendedor -->
    <div id="modal-comentar-vendedor" class="modal-overlay" style="display: none;">
        <div class="modal-comentar-vendedor-content">
            <div class="modal-comentar-vendedor-header">
                <h3><i class="fas fa-star"></i> Calificar Vendedor</h3>
                <button class="btn-cerrar-modal" onclick="cerrarModalComentarVendedor()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-comentar-vendedor-body">
                <div class="vendedor-info-modal">
                    <p><strong>Vendedor:</strong> <span id="vendedor-nombre-modal"></span></p>
                    <p><strong>Producto:</strong> <span id="producto-nombre-modal"></span></p>
                </div>
                <div class="form-group">
                    <label>Calificación</label>
                    <div class="rating-input-vendedor" id="ratingInputVendedor">
                        <i class="fas fa-star" data-rating="1"></i>
                        <i class="fas fa-star" data-rating="2"></i>
                        <i class="fas fa-star" data-rating="3"></i>
                        <i class="fas fa-star" data-rating="4"></i>
                        <i class="fas fa-star" data-rating="5"></i>
                    </div>
                    <span class="rating-text" id="ratingTextVendedor">Selecciona una calificación</span>
                </div>
                <div class="form-group">
                    <label for="comentarioVendedorText">Tu comentario sobre el vendedor</label>
                    <textarea id="comentarioVendedorText" 
                              placeholder="Comparte tu experiencia con este vendedor... (opcional)"
                              rows="4"></textarea>
                </div>
                <div class="alert" id="alertComentarVendedor" style="display: none;"></div>
                <div class="form-actions">
                    <button class="btn-cancelar" onclick="cerrarModalComentarVendedor()">Cancelar</button>
                    <button class="btn-procesar-devolucion" onclick="guardarComentarioVendedor()">
                        <i class="fas fa-paper-plane"></i>
                        Publicar Comentario
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/detalle-pedido.js') }}"></script>
</body>
</html>

