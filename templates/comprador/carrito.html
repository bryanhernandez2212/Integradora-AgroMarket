<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrito - AgroMarket</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/navbar.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/estilos_comprador.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/breadcrumbs.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/navigation-header.css') }}">
    <script src="{{ url_for('static', filename='js/mobile-menu.js') }}" defer></script>
</head>
<body>
    <!-- ===== Overlay para m√≥viles ===== -->
    <div class="sidebar-overlay" id="sidebar-overlay"></div>
    
    <!-- ====== MEN√ö SUPERIOR ====== -->
    <nav>
        <button class="menu-toggle" id="menu-toggle" aria-label="Abrir men√∫">
            <span></span>
            <span></span>
            <span></span>
        </button>
        <div class="nav-left">
            <div class="logo">
                <h2>AgroMarket</h2>
            </div>
            <div class="saludo-usuario">Hola, <strong>{{ nombre }}</strong></div>
        </div>
        <div class="menu">
            <a href="{{ url_for('comprador.panel_comprador') }}" {% if page=='inicio' %}class="activo"{% endif %}>
                <span>Inicio</span>
            </a>
            <a href="{{ url_for('comprador.ver_productos') }}" {% if page=='productos' %}class="activo"{% endif %}>
                <span>Productos</span>
            </a>
            <a href="{{ url_for('comprador.ver_carrito') }}" {% if page=='carrito' %}class="activo"{% endif %}>
                <span>Carrito</span>
            </a>
            <a href="{{ url_for('comprador.mis_pedidos') }}" {% if page=='mis_pedidos' %}class="activo"{% endif %}>
                <span>Mis Pedidos</span>
            </a>
            <a href="{{ url_for('comprador.chats') }}" {% if page=='chats' %}class="activo"{% endif %}>
                <span>Chats</span>
            </a>
            <a href="{{ url_for('auth.perfil') }}" {% if page=='perfil' %}class="activo"{% endif %}>
                <span>Mi Perfil</span>
            </a>
            <a href="{{ url_for('auth.logout') }}">
                <span>Cerrar Sesi√≥n</span>
            </a>
        </div>
    </nav>
    
    <!-- ===== Sidebar para m√≥viles ===== -->
    <aside class="sidebar-menu" id="sidebar-menu">
        <!-- Header con foto de perfil y nombre -->
        <div class="sidebar-header-profile">
            <div class="sidebar-profile-avatar" id="sidebar-profile-avatar">
                <img id="sidebar-profile-avatar-img" src="" alt="Foto de perfil" style="display: none;">
                <i class="fas fa-user-circle" id="sidebar-profile-avatar-icon"></i>
            </div>
            <div class="sidebar-profile-info">
                <p class="sidebar-profile-name" id="sidebar-profile-name">{{ nombre }}</p>
                <p class="sidebar-profile-email" id="sidebar-profile-email">{{ session.get('email', '') }}</p>
            </div>
        </div>
        <div class="menu">
            <a href="{{ url_for('comprador.panel_comprador') }}" {% if page=='inicio' %}class="activo"{% endif %}>
                <span>Inicio</span>
            </a>
            <a href="{{ url_for('comprador.ver_productos') }}" {% if page=='productos' %}class="activo"{% endif %}>
                <span>Productos</span>
            </a>
            <a href="{{ url_for('comprador.ver_carrito') }}" {% if page=='carrito' %}class="activo"{% endif %}>
                <span>Carrito</span>
            </a>
            <a href="{{ url_for('comprador.mis_pedidos') }}" {% if page=='mis_pedidos' %}class="activo"{% endif %}>
                <span>Mis Pedidos</span>
            </a>
            <a href="{{ url_for('comprador.chats') }}" {% if page=='chats' %}class="activo"{% endif %}>
                <span>Chats</span>
            </a>
            <a href="{{ url_for('auth.perfil') }}" {% if page=='perfil' %}class="activo"{% endif %}>
                <span>Mi Perfil</span>
            </a>
            <a href="{{ url_for('auth.logout') }}">
                <span>Cerrar Sesi√≥n</span>
            </a>
        </div>
    </aside>

    <!-- ====== CONTENIDO PRINCIPAL ====== -->
    <main class="carrito-main">
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <div class="flash-messages">
              {% for category, message in messages %}
                <div class="flash-message {{ category }}">
                  {% if category == 'success' %}
                    <i class="fas fa-check-circle"></i>
                  {% elif category == 'danger' %}
                    <i class="fas fa-exclamation-circle"></i>
                  {% elif category == 'warning' %}
                    <i class="fas fa-exclamation-triangle"></i>
                  {% elif category == 'info' %}
                    <i class="fas fa-info-circle"></i>
                  {% endif %}
                  {{ message }}
                </div>
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}

        {% if carrito %}
            <!-- ===== COLUMNA IZQUIERDA: LISTA DE PRODUCTOS ===== -->
            <section class="carrito-productos">
                <header class="carrito-header">
                    <h1>Carrito</h1>
                    <p>Revisa tus art√≠culos antes de pagar</p>
                </header>

                <div class="productos-lista">
                    {% for item in carrito %}
                    <div class="producto-carrito-item">
                        <div class="producto-imagen">
                            <img src="{{ url_for('static', filename='uploads/' + item.imagen) if item.imagen else url_for('static', filename='images/default-product.png') }}" alt="{{ item.nombre }}" loading="lazy">
                        </div>
                        <div class="producto-info">
                            <h3>{{ item.nombre }}</h3>
                            <div class="producto-details">
                                <span class="producto-origin">{{ item.origen if item.origen else 'Local' }} ‚Ä¢ {{ item.unidad if item.unidad else 'kg' }}</span>
                            </div>
                            <div class="producto-cantidad">
                                <div class="cantidad-controls">
                                    <form action="{{ url_for('comprador.disminuir_cantidad', producto_id=item.id) }}" method="POST" style="display: inline;">
                                        <button type="submit" class="btn-cantidad-carrito disminuir" title="Disminuir cantidad">-</button>
                                    </form>
                                    <span class="cantidad-display">{{ item.cantidad }} {{ item.unidad if item.unidad else 'kg' }}</span>
                                    <form action="{{ url_for('comprador.aumentar_cantidad', producto_id=item.id) }}" method="POST" style="display: inline;">
                                        <button type="submit" class="btn-cantidad-carrito aumentar" title="Aumentar cantidad">+</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="producto-precio">
                            <span>${{ "%.2f"|format((item.precio|float * item.cantidad)) }}</span>
                        </div>
                        <div class="producto-acciones">
                                <form action="{{ url_for('comprador.eliminar_del_carrito', producto_id=item.id) }}" method="POST">
                                <button type="submit" class="btn-eliminar" title="Eliminar del carrito">üóëÔ∏è</button>
                                </form>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <div class="carrito-nota">
                    <p>Nota: Las cantidades y precios son referenciales.</p>
                </div>

                <!-- Secci√≥n de direcci√≥n de env√≠o -->
                <div class="direccion-envio-section accordion-section">
                    <div class="accordion-header" onclick="toggleAccordion('direccion-content')">
                        <div class="accordion-title">
                            <h3>Direcci√≥n de env√≠o</h3>
                            <p class="direccion-subtitle">¬øD√≥nde quieres recibir tu pedido?</p>
                        </div>
                        <span class="accordion-icon" id="direccion-icon">‚ñº</span>
                    </div>
                    <div class="accordion-content" id="direccion-content" style="display: none;">
                        <div class="form-group">
                            <label for="ciudad">Ciudad de entrega</label>
                            <select id="ciudad" name="ciudad" required>
                                <option value="">Selecciona una ciudad</option>
                                <option value="Ocosingo">Ocosingo</option>
                                <option value="San Crist√≥bal de las Casas">San Crist√≥bal de las Casas</option>
                                <option value="Comit√°n de Dom√≠nguez">Comit√°n de Dom√≠nguez</option>
                                <option value="Tuxtla Guti√©rrez">Tuxtla Guti√©rrez</option>
                                <option value="Yajal√≥n">Yajal√≥n</option>
                                <option value="Bachaj√≥n">Bachaj√≥n</option>
                                <option value="Palenque">Palenque</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="telefono">N√∫mero de tel√©fono</label>
                            <input type="tel" id="telefono" name="telefono" placeholder="Ej: 9611234567" pattern="[0-9]{10}" maxlength="10" required>
                            <small class="form-text">Ingresa 10 d√≠gitos sin espacios ni guiones. El conductor se comunicar√° contigo para coordinar la entrega.</small>
                        </div>
                    </div>
                </div>

                <!-- Formulario de m√©todo de pago -->
                <div class="metodo-pago-section accordion-section">
                    <div class="accordion-header" onclick="toggleAccordion('pago-content')">
                        <div class="accordion-title">
                            <h3>M√©todo de pago</h3>
                            <p class="metodo-pago-subtitle">Pago con tarjeta de d√©bito / cr√©dito</p>
                        </div>
                        <span class="accordion-icon" id="pago-icon">‚ñº</span>
                    </div>
                    <div class="accordion-content" id="pago-content" style="display: none;">
                        <div class="metodo-pago-options">
                        <div class="metodo-option" data-value="tarjeta">
                            <input type="radio" id="metodo_tarjeta" name="metodo_pago" value="tarjeta" checked>
                            <label for="metodo_tarjeta">
                                <span class="metodo-icon">üí≥</span>
                                <div class="metodo-info">
                                    <span class="metodo-title">Tarjeta de d√©bito / cr√©dito</span>
                                    <span class="metodo-desc">Pago seguro con Stripe</span>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Campos adicionales para tarjeta -->
                    <div id="tarjeta-campos" class="tarjeta-campos">
                        <div class="form-group">
                            <label for="nombre_titular">Nombre del titular</label>
                            <input type="text" id="nombre_titular" name="nombre_titular" placeholder="Nombre completo del titular" maxlength="100" required>
                        </div>

                        <!-- Elemento de Stripe para tarjeta -->
                        <div id="stripe-card-container" style="display: none;">
                            <div class="form-group">
                                <label class="form-label">Informaci√≥n de la tarjeta</label>
                                <div id="card-element" class="stripe-input-container">
                                    <!-- Stripe Elements crear√° los campos aqu√≠ -->
                                </div>
                                <div id="card-errors" class="error-message" role="alert"></div>
                                <!-- Mensaje de error de pago -->
                                <div id="payment-error" class="error-message" style="display: none;"></div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="enviar_comprobante" name="enviar_comprobante" value="1">
                                Enviar comprobante al correo electr√≥nico
                            </label>
                        </div>
                        
                        <!-- Mensaje de error de pago -->
                        <div id="payment-error" class="payment-error" style="display: none;"></div>
                        
                        <!-- Loading spinner -->
                        <div id="payment-loading" class="payment-loading" style="display: none;">
                            <div class="spinner"></div>
                            <p>Procesando pago...</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ===== COLUMNA DERECHA: RESUMEN Y CHECKOUT ===== -->
            <aside class="carrito-checkout">
                <div class="checkout-summary">
                    <h3>Resumen del pedido</h3>
                    <div class="summary-line">
                        <span>Subtotal</span>
                        <span>${{ "%.2f"|format(total) }}</span>
                    </div>
                    <div class="summary-line">
                        <span>Env√≠o estimado</span>
                        <span>$4.50</span>
                    </div>
                    <div class="summary-line">
                        <span>Impuestos</span>
                        <span>${{ "%.2f"|format(total * 0.1) }}</span>
                    </div>
                    <div class="summary-line total">
                        <span>Total</span>
                        <span>${{ "%.2f"|format(total * 1.1 + 4.50) }}</span>
                    </div>
                </div>

                <form action="{{ url_for('comprador.finalizar_compra') }}" method="POST" class="checkout-form">
                    <button type="submit" class="btn-proceder-pago" id="stripe-payment-button">Proceder al pago</button>
                </form>
            </aside>
        {% else %}
            <!-- ===== CARRITO VAC√çO ===== -->
            <div class="carrito-vacio">
                <div class="carrito-vacio-content">
                    <h1>Tu carrito est√° vac√≠o</h1>
                    <p>Agrega algunos productos deliciosos para comenzar tu compra</p>
                    <a href="{{ url_for('comprador.ver_productos') }}" class="btn-comenzar-compras">Comenzar a comprar</a>
                </div>
            </div>
        {% endif %}
    </main>

    <!-- ===== JavaScript ===== -->
    <!-- Firebase SDKs para carrito din√°mico -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>
    <script src="/static/js/firebase-config.js"></script>
    <script src="/static/js/firebase-notifications.js"></script>

    <script>
        // Render din√°mico del carrito desde Firestore
        let db;
        let carritoItems = [];

        async function initFirebaseCarrito() {
            try {
                if (typeof firebase === 'undefined') return false;
                if (firebase.apps.length === 0) {
                    if (window.firebaseConfig) firebase.initializeApp(window.firebaseConfig);
                }
                db = firebase.firestore();
                db.settings({ cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED, ignoreUndefinedProperties: true });
                return true;
            } catch (e) {
                console.error('Error inicializando Firebase (carrito):', e);
                return false;
            }
        }

        // Actualiza el saludo del usuario usando Firebase Auth/Firestore (same logic as perfil.html)
        async function actualizarSaludoUsuario() {
            try {
                const user = firebase.auth().currentUser;
                if (!user) {
                    console.log('Usuario no autenticado, no se puede actualizar el saludo.');
                    return;
                }

                console.log('‚úÖ Usuario autenticado encontrado:', {
                    uid: user.uid,
                    email: user.email,
                    displayName: user.displayName,
                    emailVerified: user.emailVerified
                });
                
                // Obtener datos del usuario desde Firestore (same as perfil.html)
                const userDoc = await db.collection('usuarios').doc(user.uid).get();
                
                let nombre = 'Usuario'; // Default fallback
                
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    nombre = userData.nombre || user.displayName || user.email.split('@')[0];
                    console.log('‚úÖ Nombre obtenido de Firestore:', nombre);
                } else {
                    // Fallback to displayName or email part
                    nombre = user.displayName || user.email.split('@')[0];
                    console.log('‚ö†Ô∏è Usuario sin datos en Firestore, usando fallback:', nombre);
                }

                const el = document.querySelector('.saludo-usuario strong');
                if (el) {
                    el.textContent = nombre;
                    console.log('‚úÖ Saludo actualizado a:', nombre);
                } else {
                    console.log('‚ùå Elemento .saludo-usuario strong no encontrado.');
                }
            } catch (error) {
                console.error('‚ùå Error actualizando saludo:', error);
                // Fallback to email part
                const user = firebase.auth().currentUser;
                if (user) {
                    const nombre = user.email.split('@')[0];
                    const el = document.querySelector('.saludo-usuario strong');
                    if (el) {
                        el.textContent = nombre;
                    }
                }
            }
        }

        function currency(n) {
            return `$${Number(n || 0).toFixed(2)}`;
        }

        function renderCarritoDin() {
            const main = document.querySelector('main.carrito-main');
            const vacio = main.querySelector('.carrito-vacio');
            const serverSection = main.querySelector('.carrito-productos');
            const serverAside = main.querySelector('.carrito-checkout');

            // Si no hay items, mostrar vac√≠o y salir
            if (!carritoItems || carritoItems.length === 0) {
                if (serverSection) serverSection.style.display = '';
                if (serverAside) serverAside.style.display = '';
                if (vacio) vacio.style.display = '';
                return;
            }

            // Ocultar server-render si existe y estado vac√≠o
            if (vacio) vacio.style.display = 'none';
            if (serverSection) serverSection.style.display = 'none';
            if (serverAside) serverAside.style.display = 'none';

            let contenedor = document.getElementById('carrito-dinamico');
            if (!contenedor) {
                contenedor = document.createElement('div');
                contenedor.id = 'carrito-dinamico';
                contenedor.style.display = 'grid';
                contenedor.style.gridTemplateColumns = '1fr 320px';
                contenedor.style.gap = '1.5rem';
                main.appendChild(contenedor);
            }

            const subtotal = carritoItems.reduce((acc, it) => acc + (Number(it.precio) * Number(it.cantidad)), 0);
            const envio = 4.50;
            const impuestos = subtotal * 0.1;
            const total = subtotal + envio + impuestos;

            // Columna izquierda: lista
            const izquierda = document.createElement('section');
            izquierda.className = 'carrito-productos';
            izquierda.innerHTML = `
                <header class="carrito-header">
                    <h1>Carrito</h1>
                    <p>Revisa tus art√≠culos antes de pagar</p>
                </header>
                <div class="productos-lista" id="lista-carrito-din"></div>
                <div class="carrito-nota"><p>Nota: Las cantidades y precios son referenciales.</p></div>
                
                <!-- Secci√≥n de direcci√≥n de env√≠o -->
                <div class="direccion-envio-section accordion-section">
                    <div class="accordion-header" onclick="toggleAccordion('direccion-content-din')">
                        <div class="accordion-title">
                            <h3>Direcci√≥n de env√≠o</h3>
                            <p class="direccion-subtitle">¬øD√≥nde quieres recibir tu pedido?</p>
                        </div>
                        <span class="accordion-icon" id="direccion-icon-din">‚ñº</span>
                    </div>
                    <div class="accordion-content" id="direccion-content-din" style="display: none;">
                        <div class="form-group">
                            <label for="ciudad_din">Ciudad de entrega</label>
                            <select id="ciudad_din" name="ciudad_din" required>
                                <option value="">Selecciona una ciudad</option>
                                <option value="Ocosingo">Ocosingo</option>
                                <option value="San Crist√≥bal de las Casas">San Crist√≥bal de las Casas</option>
                                <option value="Comit√°n de Dom√≠nguez">Comit√°n de Dom√≠nguez</option>
                                <option value="Tuxtla Guti√©rrez">Tuxtla Guti√©rrez</option>
                                <option value="Yajal√≥n">Yajal√≥n</option>
                                <option value="Bachaj√≥n">Bachaj√≥n</option>
                                <option value="Palenque">Palenque</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="telefono_din">N√∫mero de tel√©fono</label>
                            <input type="tel" id="telefono_din" name="telefono_din" placeholder="Ej: 9611234567" pattern="[0-9]{10}" maxlength="10" required>
                            <small class="form-text">Ingresa 10 d√≠gitos sin espacios ni guiones. El conductor se comunicar√° contigo para coordinar la entrega.</small>
                        </div>
                    </div>
                </div>
                
                <!-- M√©todo de pago -->
                <div class="metodo-pago-section accordion-section">
                    <div class="accordion-header" onclick="toggleAccordion('pago-content-din')">
                        <div class="accordion-title">
                            <h3>M√©todo de pago</h3>
                            <p class="metodo-pago-subtitle">Pago con tarjeta de d√©bito / cr√©dito</p>
                        </div>
                        <span class="accordion-icon" id="pago-icon-din">‚ñº</span>
                    </div>
                    <div class="accordion-content" id="pago-content-din" style="display: none;">
                        <div class="metodo-pago-options">
                            <div class="metodo-option" data-value="tarjeta">
                                <input type="radio" id="metodo_tarjeta_din" name="metodo_pago_din" value="tarjeta" checked>
                                <label for="metodo_tarjeta_din">
                                    <span class="metodo-icon">üí≥</span>
                                    <div class="metodo-info">
                                        <span class="metodo-title">Tarjeta de d√©bito / cr√©dito</span>
                                        <span class="metodo-desc">Pago seguro con Stripe</span>
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Campos adicionales para tarjeta -->
                        <div id="tarjeta-campos-din" class="tarjeta-campos">
                            <div class="form-group">
                                <label for="nombre_titular_din">Nombre del titular</label>
                                <input type="text" id="nombre_titular_din" name="nombre_titular_din" placeholder="Nombre completo del titular" maxlength="100" required>
                            </div>
                            
                            <!-- Elementos de Stripe separados para formulario tradicional -->
                            <div id="stripe-card-container-din" style="display: none;">
                                <div class="form-group">
                                    <label for="card-number-element-din" class="form-label">N√∫mero de tarjeta</label>
                                    <div class="card-number-wrapper">
                                        <div id="card-number-element-din" class="stripe-field-input">
                                            <!-- Stripe crear√° el campo aqu√≠ -->
                                        </div>
                                        <div id="card-brand-icon-din" class="card-brand-icon">
                                            <!-- Icono de la marca de tarjeta aparecer√° aqu√≠ -->
                                        </div>
                                    </div>
                                    <div id="card-number-errors-din" class="field-error"></div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group form-group-half">
                                        <label for="card-expiry-element-din" class="form-label">Fecha de vencimiento</label>
                                        <div id="card-expiry-element-din" class="stripe-field-input">
                                            <!-- Stripe crear√° el campo aqu√≠ -->
                                        </div>
                                        <div id="card-expiry-errors-din" class="field-error"></div>
                                    </div>
                                    
                                    <div class="form-group form-group-half">
                                        <label for="card-cvc-element-din" class="form-label">CVC</label>
                                        <div id="card-cvc-element-din" class="stripe-field-input">
                                            <!-- Stripe crear√° el campo aqu√≠ -->
                                        </div>
                                        <div id="card-cvc-errors-din" class="field-error"></div>
                                    </div>
                                </div>
                                
                                <div id="card-errors-din" class="error-message" role="alert"></div>
                            </div>
                            
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="enviar_comprobante_din" name="enviar_comprobante_din" value="1">
                                    Enviar comprobante al correo electr√≥nico
                                </label>
                            </div>
                            
                            <!-- Mensaje de error de pago -->
                            <div id="payment-error-din" class="payment-error" style="display: none;"></div>
                            
                            <!-- Loading spinner -->
                            <div id="payment-loading-din" class="payment-loading" style="display: none;">
                                <div class="spinner"></div>
                                <p>Procesando pago...</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Columna derecha: resumen
            const derecha = document.createElement('aside');
            derecha.className = 'carrito-checkout';
            derecha.innerHTML = `
                <div class="checkout-summary">
                    <h3>Resumen del pedido</h3>
                    <div class="summary-line"><span>Subtotal</span><span id="subtotal-din">${currency(subtotal)}</span></div>
                    <div class="summary-line"><span>Env√≠o estimado</span><span id="envio-din">${currency(envio)}</span></div>
                    <div class="summary-line"><span>Impuestos</span><span id="impuestos-din">${currency(impuestos)}</span></div>
                    <div class="summary-line total"><span>Total</span><span id="total-din">${currency(total)}</span></div>
                </div>
                
                <form class="checkout-form" id="checkout-form-din" onsubmit="event.preventDefault(); procesarPagoDin();">
                    <button type="submit" class="btn-proceder-pago" id="stripe-payment-button-din">Proceder al pago</button>
                </form>
            `;

            contenedor.innerHTML = '';
            contenedor.appendChild(izquierda);
            contenedor.appendChild(derecha);

            // Configurar listeners para m√©todos de pago din√°micos
            setTimeout(() => {
                configurarMetodosPagoDin(total);
                // Formulario de direcci√≥n manual - sin Google Maps
            }, 100);

            // Render de items
            const lista = izquierda.querySelector('#lista-carrito-din');
            lista.innerHTML = carritoItems.map((item, index) => {
                // Asegurar que tenemos los datos correctos
                const nombre = item.nombre || 'Producto sin nombre';
                const imagen = item.imagen && String(item.imagen).trim() !== '' ? item.imagen : '/static/images/product-placeholder.png';
                const precio = Number(item.precio) || 0;
                const cantidad = Number(item.cantidad) || 1;
                const unidad = item.unidad || 'kg';
                const origen = item.origen || 'Local';
                
                console.log(`Item ${index}:`, { nombre, imagen, precio, cantidad, unidad, origen });
                
                return `
                    <div class="producto-carrito-item" data-doc-id="${item._docId}">
                        <div class="producto-imagen">
                            <img src="${imagen}" alt="${nombre}" loading="lazy" onerror="this.src='/static/images/product-placeholder.png'">
                        </div>
                        <div class="producto-info">
                            <h3>${nombre}</h3>
                            <div class="producto-details">
                                <span class="producto-origin">${origen} ‚Ä¢ ${unidad}</span>
                            </div>
                            <div class="producto-cantidad">
                                <div class="cantidad-controls">
                                    <button class="btn-cantidad-carrito disminuir" onclick="actualizarCantidadDin('${item._docId}', -1)">-</button>
                                    <span class="cantidad-display">${cantidad} ${unidad}</span>
                                    <button class="btn-cantidad-carrito aumentar" onclick="actualizarCantidadDin('${item._docId}', 1)">+</button>
                                </div>
                            </div>
                        </div>
                        <div class="producto-precio">
                            <span>${currency(precio * cantidad)}</span>
                        </div>
                        <div class="producto-acciones">
                            <button class="btn-eliminar" onclick="eliminarItemDin('${item._docId}')" title="Eliminar del carrito">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function cargarCarritoDin() {
            try {
                const ok = await initFirebaseCarrito();
                if (!ok) return;
                const user = firebase.auth().currentUser;
                if (!user) return;

                const snap = await db.collection('carrito').where('usuario_id', '==', user.uid).get();
                carritoItems = [];
                snap.forEach(doc => {
                    carritoItems.push({ _docId: doc.id, ...doc.data() });
                });
                renderCarritoDin();
            } catch (e) {
                console.error('Error cargando carrito din√°mico:', e);
            }
        }

        async function actualizarCantidadDin(docId, delta) {
            try {
                const idx = carritoItems.findIndex(i => i._docId === docId);
                if (idx === -1) return;
                const item = carritoItems[idx];
                const nuevo = Math.max(1, Number(item.cantidad) + Number(delta));
                // Opcional: si conoces el stock, podr√≠as limitar aqu√≠
                await db.collection('carrito').doc(docId).update({ cantidad: nuevo, fecha_agregado: new Date().toISOString() });
                carritoItems[idx].cantidad = nuevo;
                renderCarritoDin();
            } catch (e) {
                console.error('Error actualizando cantidad:', e);
            }
        }

        async function eliminarItemDin(docId) {
            try {
                await db.collection('carrito').doc(docId).delete();
                carritoItems = carritoItems.filter(i => i._docId !== docId);
                renderCarritoDin();
            } catch (e) {
                console.error('Error eliminando item:', e);
            }
        }

        // Variable global para almacenar el total actual
        let totalCarritoDin = 0;
        let cardElementDin = null;

        // Configurar m√©todos de pago din√°micos
        function configurarMetodosPagoDin(total) {
            totalCarritoDin = total;
            console.log('üí∞ Total del carrito:', total);
            
            const tarjetaCampos = document.getElementById('tarjeta-campos-din');
            const stripeCardContainer = document.getElementById('stripe-card-container-din');
            const nombreTitular = document.getElementById('nombre_titular_din');

            // Mostrar campos de tarjeta autom√°ticamente (es el √∫nico m√©todo disponible)
            if (tarjetaCampos) tarjetaCampos.style.display = 'block';
            if (stripeCardContainer) stripeCardContainer.style.display = 'block';
            if (nombreTitular) nombreTitular.required = true;

            // Inicializar Stripe card element autom√°ticamente
            setTimeout(() => {
                inicializarStripeDin();
            }, 300);
        }

        // Inicializar Stripe para carrito din√°mico con campos separados
        function inicializarStripeDin() {
            if (typeof Stripe === 'undefined') {
                console.error('Stripe no est√° cargado');
                return;
            }

            const cardNumberContainer = document.getElementById('card-number-element-din');
            const cardExpiryContainer = document.getElementById('card-expiry-element-din');
            const cardCvcContainer = document.getElementById('card-cvc-element-din');
            
            if (!cardNumberContainer || !cardExpiryContainer || !cardCvcContainer) {
                console.error('Contenedores de Stripe no encontrados');
                return;
            }

            // Limpiar contenedores
            cardNumberContainer.innerHTML = '';
            cardExpiryContainer.innerHTML = '';
            cardCvcContainer.innerHTML = '';

            try {
                // Inicializar Stripe si no existe con dise√±o personalizado para formulario tradicional
                if (!window.stripeDin) {
                    window.stripeDin = Stripe('pk_test_51S4nWTKFtQrWkPCD3FRrULpKifZ43LK9m3RcNn9TFpbzYqNU36uInxGyKRuuV78HtuC5drNe0qeZWei34yKGiYeF00M9L6swJq');
                    window.elementsDin = window.stripeDin.elements({
                        appearance: {
                            theme: 'none',
                            variables: {
                                colorPrimary: '#2ba656',
                                colorBackground: '#ffffff',
                                colorText: '#2c3e50',
                                colorDanger: '#e74c3c',
                                colorTextSecondary: '#6c757d',
                                fontFamily: 'system-ui, -apple-system, "Segoe UI", sans-serif',
                                fontSizeBase: '16px',
                                spacingUnit: '4px'
                            },
                            rules: {
                                '.Input': {
                                    backgroundColor: '#ffffff',
                                    border: '2px solid #e9ecef',
                                    borderRadius: '8px',
                                    padding: '12px 14px',
                                    fontSize: '16px',
                                    transition: 'all 0.2s ease',
                                    boxShadow: 'none'
                                },
                                '.Input:focus': {
                                    borderColor: '#2ba656',
                                    boxShadow: '0 0 0 3px rgba(43, 166, 86, 0.1)',
                                    outline: 'none'
                                },
                                '.Input--invalid': {
                                    borderColor: '#e74c3c',
                                    color: '#e74c3c'
                                },
                                '.Input--empty': {
                                    borderColor: '#e9ecef'
                                }
                            }
                        }
                    });
                }

                // Crear elementos separados para formulario tradicional
                const cardNumberElement = window.elementsDin.create('cardNumber', {
                    placeholder: '1234 5678 9012 3456'
                });
                
                const cardExpiryElement = window.elementsDin.create('cardExpiry', {
                    placeholder: 'MM/AA'
                });
                
                const cardCvcElement = window.elementsDin.create('cardCvc', {
                    placeholder: '123'
                });

                // Montar elementos
                cardNumberElement.mount('#card-number-element-din');
                cardExpiryElement.mount('#card-expiry-element-din');
                cardCvcElement.mount('#card-cvc-element-din');

                // Guardar elementos globalmente
                window.cardNumberElementDin = cardNumberElement;
                window.cardExpiryElementDin = cardExpiryElement;
                window.cardCvcElementDin = cardCvcElement;

                // Manejar errores y detecci√≥n de marca de tarjeta
                cardNumberElement.on('change', function(event) {
                    const errorElement = document.getElementById('card-number-errors-din');
                    const brandIcon = document.getElementById('card-brand-icon-din');
                    
                    // Manejar errores
                    if (errorElement) {
                        if (event.error && event.error.type === 'validation_error') {
                            errorElement.textContent = event.error.message;
                            errorElement.style.display = 'block';
                        } else {
                            errorElement.textContent = '';
                            errorElement.style.display = 'none';
                        }
                    }
                    
                    // Mostrar icono de marca de tarjeta
                    if (brandIcon && event.brand) {
                        const brand = event.brand.toLowerCase();
                        let brandName = '';
                        let iconClass = '';
                        
                        switch(brand) {
                            case 'visa':
                                brandName = 'Visa';
                                iconClass = 'fab fa-cc-visa';
                                break;
                            case 'mastercard':
                                brandName = 'Mastercard';
                                iconClass = 'fab fa-cc-mastercard';
                                break;
                            case 'amex':
                            case 'american_express':
                                brandName = 'American Express';
                                iconClass = 'fab fa-cc-amex';
                                break;
                            case 'discover':
                                brandName = 'Discover';
                                iconClass = 'fab fa-cc-discover';
                                break;
                            case 'diners':
                                brandName = 'Diners Club';
                                iconClass = 'fab fa-cc-diners-club';
                                break;
                            case 'jcb':
                                brandName = 'JCB';
                                iconClass = 'fab fa-cc-jcb';
                                break;
                            default:
                                brandName = brand.charAt(0).toUpperCase() + brand.slice(1);
                                iconClass = 'far fa-credit-card';
                        }
                        
                        if (event.complete && event.brand !== 'unknown') {
                            brandIcon.innerHTML = `<i class="${iconClass}" title="${brandName}"></i>`;
                            brandIcon.style.display = 'flex';
                        } else if (!event.empty) {
                            brandIcon.innerHTML = `<i class="${iconClass}" title="${brandName}"></i>`;
                            brandIcon.style.display = 'flex';
                        } else {
                            brandIcon.innerHTML = '';
                            brandIcon.style.display = 'none';
                        }
                    }
                });

                cardExpiryElement.on('change', function(event) {
                    const errorElement = document.getElementById('card-expiry-errors-din');
                    if (errorElement) {
                        if (event.error && event.error.type === 'validation_error') {
                            errorElement.textContent = event.error.message;
                            errorElement.style.display = 'block';
                        } else {
                            errorElement.textContent = '';
                            errorElement.style.display = 'none';
                        }
                    }
                });

                cardCvcElement.on('change', function(event) {
                    const errorElement = document.getElementById('card-cvc-errors-din');
                    if (errorElement) {
                        if (event.error && event.error.type === 'validation_error') {
                            errorElement.textContent = event.error.message;
                            errorElement.style.display = 'block';
                        } else {
                            errorElement.textContent = '';
                            errorElement.style.display = 'none';
                        }
                    }
                });

                console.log('‚úÖ Stripe Card Elements montados (formulario tradicional)');

            } catch (error) {
                console.error('‚ùå Error creando Stripe card elements:', error);
            }
        }

        // Validar direcci√≥n de entrega
        function validarDireccionEntrega() {
            const ciudad = document.getElementById('ciudad_din');
            const telefono = document.getElementById('telefono_din');

            if (!ciudad || !ciudad.value) {
                alert('Por favor selecciona una ciudad de entrega');
                return false;
            }

            if (!telefono || !telefono.value.trim()) {
                alert('Por favor ingresa tu n√∫mero de tel√©fono');
                return false;
            }

            // Validar que el tel√©fono tenga 10 d√≠gitos
            const telefonoValue = telefono.value.replace(/\D/g, '');
            if (telefonoValue.length !== 10) {
                alert('Por favor ingresa un n√∫mero de tel√©fono v√°lido de 10 d√≠gitos');
                return false;
            }

            return true;
        }

        function obtenerDireccionCompleta() {
            const ciudad = document.getElementById('ciudad_din')?.value || '';
            const telefono = document.getElementById('telefono_din')?.value.trim() || '';

            return {
                ciudad,
                telefono,
                formatted: `${ciudad} (Tel: ${telefono})`
            };
        }

        // Procesar pago del carrito din√°mico
        async function procesarPagoDin() {
            // Validar direcci√≥n de entrega primero
            if (!validarDireccionEntrega()) {
                // Abrir el acorde√≥n de direcci√≥n si est√° cerrado
                const direccionContent = document.getElementById('direccion-content-din');
                if (direccionContent && direccionContent.style.display === 'none') {
                    toggleAccordion('direccion-content-din');
                }
                return;
            }

            // Solo procesar con tarjeta (√∫nico m√©todo disponible)
            await procesarPagoStripeDin();
        }

        // Procesar pago con Stripe (carrito din√°mico)
        async function procesarPagoStripeDin() {
            console.log('üí≥ Procesando pago con Stripe - Total:', totalCarritoDin);
            
            // Verificar que los elementos de Stripe est√©n disponibles
            if (!window.cardNumberElementDin || !window.cardExpiryElementDin || !window.cardCvcElementDin) {
                alert('‚ùå Error: Campos de tarjeta no est√°n disponibles. Por favor selecciona m√©todo de pago con tarjeta.');
                return;
            }

            const submitButton = document.getElementById('stripe-payment-button-din');
            const loadingSpinner = document.getElementById('payment-loading-din');
            const errorContainer = document.getElementById('payment-error-din');

            try {
                // Mostrar loading
                if (submitButton) {
                    submitButton.disabled = true;
                    submitButton.textContent = 'Procesando...';
                }
                if (loadingSpinner) {
                    loadingSpinner.style.display = 'block';
                }
                if (errorContainer) {
                    errorContainer.style.display = 'none';
                }

                // Crear Payment Intent con el total correcto
                const response = await fetch('/comprador/create-payment-intent', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin', // Incluir cookies de sesi√≥n
                    body: JSON.stringify({
                        amount: Math.round(totalCarritoDin * 100) // Convertir a centavos
                    })
                });

                // Verificar que la respuesta sea JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('‚ùå Error: El servidor devolvi√≥ HTML en lugar de JSON:', text.substring(0, 200));
                    throw new Error('Error en el servidor. Por favor, verifica que est√©s autenticado e intenta nuevamente.');
                }

                // Verificar status HTTP
                if (!response.ok) {
                    const errorData = await response.json().catch(() => {
                        throw new Error(`Error del servidor (${response.status}): ${response.statusText}`);
                    });
                    throw new Error(errorData.error || `Error del servidor (${response.status})`);
                }

                const data = await response.json();
                console.log('‚úÖ Respuesta del servidor:', data);

                if (data.error) {
                    throw new Error(data.error);
                }

                if (!data.client_secret) {
                    throw new Error('No se recibi√≥ el client_secret del servidor');
                }

                // Confirmar pago
                const nombreTitular = document.getElementById('nombre_titular_din')?.value || 'Cliente AgroMarket';
                // Crear el payment method usando los elementos separados
                const { error: createError, paymentMethod } = await window.stripeDin.createPaymentMethod({
                    type: 'card',
                    card: window.cardNumberElementDin,
                    billing_details: {
                        name: nombreTitular,
                    },
                });

                if (createError) {
                    throw new Error(createError.message);
                }

                // Confirmar el pago con el payment method
                const { error: stripeError, paymentIntent } = await window.stripeDin.confirmCardPayment(
                    data.client_secret,
                    {
                        payment_method: paymentMethod.id
                    }
                );

                if (stripeError) {
                    throw new Error(stripeError.message);
                }

                // Pago exitoso
                if (paymentIntent.status === 'succeeded') {
                    console.log('üéâ Pago exitoso:', paymentIntent.id);
                    
                    // Obtener datos de direcci√≥n completa
                    const direccionData = obtenerDireccionCompleta();
                    
                    // Guardar compra en Firestore
                    const compraId = await guardarCompraEnFirestore('tarjeta', paymentIntent.id, direccionData);
                    
                    // Limpiar carrito de Firestore PRIMERO (antes de redirigir)
                    const user = firebase.auth().currentUser;
                    if (user && db) {
                        try {
                            const carritoSnapshot = await db.collection('carrito')
                                .where('usuario_id', '==', user.uid)
                                .get();
                            
                            const deletePromises = carritoSnapshot.docs.map(doc => doc.ref.delete());
                            await Promise.all(deletePromises);
                            console.log('‚úÖ Carrito limpiado de Firestore');
                        } catch (error) {
                            console.error('‚ùå Error limpiando carrito:', error);
                            // Continuar aunque falle la limpieza
                        }
                    }
                    
                    // Guardar informaci√≥n del pago
                    localStorage.setItem('totalAmount', totalCarritoDin.toFixed(2));
                    localStorage.setItem('paymentIntentId', paymentIntent.id);
                    localStorage.setItem('paymentDate', new Date().toISOString());
                    
                    // Enviar correo en background (no bloquear la redirecci√≥n)
                    if (compraId && user) {
                        console.log('üìß Preparando env√≠o de comprobante de compra...', { compraId, email: user.email });
                        const userDoc = await db.collection('usuarios').doc(user.uid).get();
                        const userData = userDoc.exists ? userDoc.data() : {};
                        // Enviar correo sin esperar (fire and forget) pero con mejor manejo de errores
                        enviarCorreoEnBackground(compraId, user.email, userData, carritoItems, totalCarritoDin, 'tarjeta', direccionData)
                            .then(() => {
                                console.log('‚úÖ Comprobante de compra enviado exitosamente');
                            })
                            .catch(err => {
                                console.error('‚ùå Error enviando correo (no cr√≠tico):', err);
                            });
                    } else {
                        console.warn('‚ö†Ô∏è No se puede enviar correo: compraId o user no disponible', { compraId, user: !!user });
                    }
                    
                    // Redirigir inmediatamente a p√°gina de √©xito
                    window.location.href = '/comprador/stripe-success';
                }

            } catch (error) {
                console.error('‚ùå Error en el pago:', error);
                
                let errorMsg = 'Error al procesar el pago. Intenta nuevamente.';
                
                if (error.message) {
                    errorMsg = error.message;
                } else if (typeof error === 'string') {
                    errorMsg = error;
                }
                
                // Mensajes m√°s amigables para errores comunes
                if (errorMsg.includes('HTML') || errorMsg.includes('autenticado')) {
                    errorMsg = '‚ö†Ô∏è Parece que no est√°s autenticado. Por favor, recarga la p√°gina y vuelve a intentar.';
                } else if (errorMsg.includes('client_secret')) {
                    errorMsg = '‚ö†Ô∏è Error al crear el intento de pago. Verifica tu conexi√≥n e intenta nuevamente.';
                }
                
                if (errorContainer) {
                    errorContainer.textContent = errorMsg;
                    errorContainer.style.display = 'block';
                } else {
                    alert('Error en el pago: ' + errorMsg);
                }
            } finally {
                // Ocultar loading
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.textContent = 'Proceder al pago';
                }
                if (loadingSpinner) {
                    loadingSpinner.style.display = 'none';
                }
            }
        }

        // Funci√≥n legacy para m√©todos de pago no tarjeta (ya no se usa, solo tarjeta disponible)
        async function procesarCompraSinStripe(metodoPago) {
            try {
                // Obtener datos de direcci√≥n completa
                const direccionData = obtenerDireccionCompleta();

                // Guardar compra en Firestore
                const compraId = await guardarCompraEnFirestore(metodoPago, null, direccionData);

                // Limpiar carrito de Firestore PRIMERO (antes de redirigir)
                const user = firebase.auth().currentUser;
                if (user && db) {
                    try {
                        const carritoSnapshot = await db.collection('carrito')
                            .where('usuario_id', '==', user.uid)
                            .get();
                        
                        const deletePromises = carritoSnapshot.docs.map(doc => doc.ref.delete());
                        await Promise.all(deletePromises);
                        console.log('‚úÖ Carrito limpiado de Firestore');
                    } catch (error) {
                        console.error('‚ùå Error limpiando carrito:', error);
                        // Continuar aunque falle la limpieza
                    }
                }

                // Guardar informaci√≥n del pago
                localStorage.setItem('totalAmount', totalCarritoDin.toFixed(2));
                localStorage.setItem('paymentMethod', metodoPago);
                localStorage.setItem('paymentDate', new Date().toISOString());

                // Enviar correo en background (no bloquear la redirecci√≥n)
                if (compraId && user) {
                    console.log('üìß Preparando env√≠o de comprobante de compra...', { compraId, email: user.email, metodoPago });
                    const userDoc = await db.collection('usuarios').doc(user.uid).get();
                    const userData = userDoc.exists ? userDoc.data() : {};
                    // Enviar correo sin esperar (fire and forget) pero con mejor manejo de errores
                    enviarCorreoEnBackground(compraId, user.email, userData, carritoItems, totalCarritoDin, metodoPago, direccionData)
                        .then(() => {
                            console.log('‚úÖ Comprobante de compra enviado exitosamente');
                        })
                        .catch(err => {
                            console.error('‚ùå Error enviando correo (no cr√≠tico):', err);
                        });
                } else {
                    console.warn('‚ö†Ô∏è No se puede enviar correo: compraId o user no disponible', { compraId, user: !!user });
                }
                
                // Redirigir inmediatamente a p√°gina de √©xito
                window.location.href = '/comprador/pago_exitoso';
            } catch (error) {
                console.error('‚ùå Error procesando compra:', error);
                alert('Error al procesar la compra. Por favor, intenta nuevamente.');
            }
        }

        // Guardar compra en Firestore
        async function guardarCompraEnFirestore(metodoPago, paymentIntentId, direccionData) {
            try {
                const user = firebase.auth().currentUser;
                if (!user || !db) {
                    throw new Error('Usuario no autenticado o Firestore no disponible');
                }

                // Obtener informaci√≥n del usuario
                const userDoc = await db.collection('usuarios').doc(user.uid).get();
                const userData = userDoc.exists ? userDoc.data() : {};

                // Preparar productos con vendedor_id corregido
                const productosConVendedor = await Promise.all(carritoItems.map(async (item) => {
                    let vendedorId = item.vendedor_id || item.vendedorId || '';
                    
                    // Si no hay vendedor_id en el carrito, buscarlo en el producto de Firestore
                    if (!vendedorId && (item.producto_id || item._docId)) {
                        try {
                            const productoId = item.producto_id || item._docId;
                            const productoDoc = await db.collection('productos').doc(productoId).get();
                            if (productoDoc.exists) {
                                const productoData = productoDoc.data();
                                vendedorId = productoData.vendedor_id || productoData.vendedorId || '';
                                console.log('‚úÖ vendedor_id obtenido del producto:', {
                                    producto_id: productoId,
                                    vendedor_id: vendedorId,
                                    producto_nombre: productoData.nombre
                                });
                            }
                        } catch (error) {
                            console.error('‚ùå Error obteniendo vendedor_id del producto:', error);
                        }
                    }
                    
                    console.log('üõí Item del carrito procesado:', {
                        nombre: item.nombre,
                        producto_id: item.producto_id || item._docId,
                        vendedor_id: vendedorId,
                        item_completo: item
                    });
                    
                    return {
                        producto_id: item.producto_id || item._docId,
                        nombre: item.nombre,
                        cantidad: Number(item.cantidad),
                        unidad: item.unidad || 'kg',
                        precio_unitario: Number(item.precio),
                        precio_total: Number(item.precio) * Number(item.cantidad),
                        imagen: item.imagen || '',
                        vendedor_id: vendedorId
                    };
                }));

                // Obtener lista √∫nica de vendedores para las reglas de Firestore
                const vendedoresIds = [...new Set(productosConVendedor
                    .map(p => p.vendedor_id)
                    .filter(id => id && id.trim() !== ''))];
                
                console.log('üë• Vendedores √∫nicos en la compra:', vendedoresIds);
                
                // Preparar datos de la compra
                const compraData = {
                    usuario_id: user.uid,
                    usuario_nombre: userData.nombre || user.displayName || user.email.split('@')[0],
                    usuario_email: user.email,
                    productos: productosConVendedor.map(p => ({
                        ...p,
                        estado_pedido: 'preparando' // Estado por defecto
                    })),
                    vendedores_ids: vendedoresIds, // Array de IDs de vendedores para las reglas de Firestore
                    subtotal: carritoItems.reduce((acc, it) => acc + (Number(it.precio) * Number(it.cantidad)), 0),
                    envio: 4.50,
                    impuestos: carritoItems.reduce((acc, it) => acc + (Number(it.precio) * Number(it.cantidad)), 0) * 0.1,
                    total: totalCarritoDin,
                    metodo_pago: metodoPago || 'tarjeta',
                    payment_intent_id: paymentIntentId || null,
                    estado: 'pagado', // Solo se acepta pago con tarjeta
                    estado_pedido: 'preparando', // Estado por defecto del pedido
                    direccion_entrega: {
                        ciudad: direccionData.ciudad,
                        telefono: direccionData.telefono,
                        formatted: direccionData.formatted
                    },
                    fecha_compra: firebase.firestore.FieldValue.serverTimestamp(),
                    fecha_creacion: new Date().toISOString()
                };

                // Guardar en Firestore
                const compraRef = await db.collection('compras').add(compraData);
                console.log('‚úÖ Compra guardada en Firestore:', compraRef.id);
                
                // Actualizar stock de cada producto comprado
                console.log('üì¶ Actualizando stock de productos...');
                const stockUpdatePromises = productosConVendedor.map(async (producto) => {
                    try {
                        const productoRef = db.collection('productos').doc(producto.producto_id);
                        const productoDoc = await productoRef.get();
                        
                        if (productoDoc.exists) {
                            const productoData = productoDoc.data();
                            const stockActual = productoData.stock || 0;
                            const cantidadComprada = producto.cantidad || 0;
                            const nuevoStock = Math.max(0, stockActual - cantidadComprada); // No permitir stock negativo
                            
                            await productoRef.update({
                                stock: nuevoStock
                            });
                            
                            console.log(`‚úÖ Stock actualizado para ${producto.nombre}: ${stockActual} ‚Üí ${nuevoStock} (comprados: ${cantidadComprada})`);
                        } else {
                            console.warn(`‚ö†Ô∏è Producto ${producto.producto_id} no encontrado para actualizar stock`);
                        }
                    } catch (error) {
                        console.error(`‚ùå Error actualizando stock de ${producto.nombre}:`, error);
                        // No fallar la compra si hay error actualizando stock
                    }
                });
                
                await Promise.all(stockUpdatePromises);
                console.log('‚úÖ Todos los stocks actualizados');
                
                // Crear chats autom√°ticamente por cada vendedor √∫nico
                try {
                    console.log('üí¨ Creando chats por vendedor...');
                    
                    // Obtener vendedores √∫nicos de los productos
                    const vendedoresUnicos = new Map();
                    productosConVendedor.forEach(producto => {
                        const vendedorId = producto.vendedor_id;
                        if (vendedorId && !vendedoresUnicos.has(vendedorId)) {
                            vendedoresUnicos.set(vendedorId, {
                                id: vendedorId,
                                productos: []
                            });
                        }
                        if (vendedorId) {
                            vendedoresUnicos.get(vendedorId).productos.push(producto);
                        }
                    });
                    
                    console.log(`üìä Vendedores √∫nicos encontrados: ${vendedoresUnicos.size}`);
                    
                    // Obtener informaci√≥n de cada vendedor y crear chat
                    const chatPromises = Array.from(vendedoresUnicos.values()).map(async (vendedorInfo) => {
                        try {
                            // Obtener informaci√≥n del vendedor
                            const vendedorDoc = await db.collection('usuarios').doc(vendedorInfo.id).get();
                            const vendedorData = vendedorDoc.exists ? vendedorDoc.data() : {};
                            const vendedorNombre = vendedorData.nombre_tienda || vendedorData.nombre || 'Vendedor';
                            
                            // Informaci√≥n del comprador
                            const compradorId = user.uid;
                            const compradorNombre = userData.nombre || user.displayName || user.email.split('@')[0];
                            
                            // Crear ID √∫nico para el chat (compra_id + vendedor_id)
                            const chatId = `${compraRef.id}_${compradorId}_${vendedorInfo.id}`.replace(/[^\w\-]+/g, '-');
                            const chatRef = db.collection('chats').doc(chatId);
                            
                            // Verificar si el chat ya existe
                            const chatDoc = await chatRef.get();
                            
                            if (!chatDoc.exists) {
                                // Crear folio del pedido
                                const pedidoFolio = `PED-${compraRef.id.substring(0, 8).toUpperCase()}`;
                                
                                // Crear el chat
                                const chatData = {
                                    pedido_id: compraRef.id,
                                    pedido_folio: pedidoFolio,
                                    metadata: {
                                        orderId: compraRef.id,
                                        vendorId: vendedorInfo.id
                                    },
                                    compra_id: compraRef.id,
                                    comprador_id: compradorId,
                                    comprador_nombre: compradorNombre,
                                    vendedor_id: vendedorInfo.id,
                                    vendedor_nombre: vendedorNombre,
                                    participants: [compradorId, vendedorInfo.id],
                                    participantsData: {
                                        [compradorId]: {
                                            id: compradorId,
                                            nombre: compradorNombre,
                                            rol_activo: 'comprador'
                                        },
                                        [vendedorInfo.id]: {
                                            id: vendedorInfo.id,
                                            nombre: vendedorNombre,
                                            rol_activo: 'vendedor'
                                        }
                                    },
                                    unreadCounts: {
                                        [compradorId]: 0,
                                        [vendedorInfo.id]: 0
                                    },
                                    productos: vendedorInfo.productos,
                                    created_at: firebase.firestore.FieldValue.serverTimestamp(),
                                    updated_at: firebase.firestore.FieldValue.serverTimestamp(),
                                    last_message: '',
                                    last_message_at: firebase.firestore.FieldValue.serverTimestamp()
                                };
                                
                                await chatRef.set(chatData, { merge: true });
                                console.log(`‚úÖ Chat creado para vendedor ${vendedorNombre} (${vendedorInfo.id})`);
                            } else {
                                console.log(`‚ÑπÔ∏è Chat ya existe para vendedor ${vendedorInfo.id}`);
                            }
                        } catch (error) {
                            console.error(`‚ùå Error creando chat para vendedor ${vendedorInfo.id}:`, error);
                            // No fallar la compra si hay error creando un chat
                        }
                    });
                    
                    await Promise.all(chatPromises);
                    console.log(`‚úÖ ${vendedoresUnicos.size} chat(s) creado(s) exitosamente`);
                } catch (chatError) {
                    console.error('‚ùå Error creando chats autom√°ticamente:', chatError);
                    // No bloquear la compra si falla la creaci√≥n de chats
                }
                
                // El correo se enviar√° en background despu√©s de la redirecci√≥n
                // No bloquear aqu√≠ para que la redirecci√≥n sea inmediata
                
                // Enviar notificaci√≥n push (si est√° disponible) - tambi√©n en background
                try {
                    if (window.enviarNotificacionCompra) {
                        await window.enviarNotificacionCompra(
                            compraRef.id,
                            compraData.total,
                            productosConVendedor
                        );
                        
                        // Tambi√©n mostrar notificaci√≥n local inmediata
                        if ('Notification' in window && Notification.permission === 'granted') {
                            const totalTexto = productosConVendedor.length === 1
                                ? `${productosConVendedor[0].nombre} - $${compraData.total.toFixed(2)}`
                                : `${productosConVendedor.length} productos - $${compraData.total.toFixed(2)}`;
                            
                            new Notification('üéâ ¬°Compra Exitosa!', {
                                body: `Tu pedido por ${totalTexto} ha sido confirmado. Revisa tu correo para m√°s detalles.`,
                                icon: '/static/images/icon-192.png',
                                badge: '/static/images/icon-48.png',
                                tag: 'compra-exitosa',
                                requireInteraction: false
                            });
                        }
                    }
                } catch (notificationError) {
                    console.error('‚ùå Error enviando notificaci√≥n push:', notificationError);
                    // No bloquear la compra si falla la notificaci√≥n
                }
                
                return compraRef.id;
            } catch (error) {
                console.error('‚ùå Error guardando compra en Firestore:', error);
                throw error;
            }
        }

        // Funci√≥n para enviar correo en background (no bloquea)
        async function enviarCorreoEnBackground(compraId, emailCliente, userData, productos, total, metodoPago, direccionData) {
            try {
                console.log('üìß Iniciando env√≠o de comprobante de compra...', { 
                    compraId, 
                    emailCliente,
                    cantidadProductos: productos.length,
                    total: total,
                    metodoPago: metodoPago
                });
                
                if (!compraId) {
                    console.error('‚ùå No se proporcion√≥ compraId');
                    return;
                }
                
                if (!emailCliente) {
                    console.error('‚ùå No se proporcion√≥ email del cliente');
                    return;
                }
                
                const fechaCompra = new Date().toLocaleString('es-MX', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // Preparar productos para el correo
                const productosParaCorreo = productos.map(p => ({
                    nombre: p.nombre || p.producto_nombre || 'Producto',
                    cantidad: p.cantidad || 0,
                    unidad: p.unidad || 'kg',
                    precio_unitario: p.precio || p.precio_unitario || 0,
                    precio_total: (p.precio || p.precio_unitario || 0) * (p.cantidad || 1)
                }));
                
                const subtotal = productos.reduce((acc, p) => acc + ((p.precio || p.precio_unitario || 0) * (p.cantidad || 1)), 0);
                const impuestos = subtotal * 0.1;
                const envio = 4.50;
                
                const ticketData = {
                    compra_id: compraId,
                    email_cliente: emailCliente,
                    nombre_cliente: userData.nombre || userData.displayName || 'Cliente',
                    fecha_compra: fechaCompra,
                    productos: productosParaCorreo,
                    subtotal: subtotal,
                    envio: envio,
                    impuestos: impuestos,
                    total: total,
                    metodo_pago: metodoPago,
                    direccion_entrega: direccionData || {}
                };
                
                console.log('üìß Datos del ticket a enviar:', {
                    compra_id: ticketData.compra_id,
                    email: ticketData.email_cliente,
                    nombre: ticketData.nombre_cliente,
                    productos: ticketData.productos.length,
                    total: ticketData.total
                });
                
                const response = await fetch('/comprador/enviar-ticket-compra', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(ticketData),
                    credentials: 'same-origin'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Ticket de compra enviado por correo exitosamente:', result);
                    return result;
                } else {
                    const errorText = await response.text();
                    console.error('‚ö†Ô∏è Error enviando ticket por correo:', response.status, errorText);
                    throw new Error(`Error ${response.status}: ${errorText}`);
                }
            } catch (emailError) {
                console.error('‚ùå Error enviando ticket por correo:', emailError);
                throw emailError;
            }
        }

        // Funciones de Google Maps removidas - ahora se usa formulario manual

        document.addEventListener('DOMContentLoaded', async function() {
            const ok = await initFirebaseCarrito();
            if (!ok) return;
            
            // Formulario de direcci√≥n manual - sin Google Maps
            
            firebase.auth().onAuthStateChanged(function(user){
                if (user) {
                    cargarCarritoDin();
                }
            });
            // Intento inicial
            if (firebase.auth().currentUser) cargarCarritoDin();
        });
    </script>
    <script>
        // Funci√≥n para toggle del acorde√≥n
        function toggleAccordion(contentId) {
            const content = document.getElementById(contentId);
            const icon = document.getElementById(contentId.replace('-content', '-icon'));
            
            if (content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block';
                icon.textContent = '‚ñ≤';
                icon.style.transform = 'rotate(180deg)';
            } else {
                content.style.display = 'none';
                icon.textContent = '‚ñº';
                icon.style.transform = 'rotate(0deg)';
            }
        }

        // Manejo de formulario de pago
        document.addEventListener('DOMContentLoaded', function() {
            const tarjetaCampos = document.getElementById('tarjeta-campos');
            const stripeCardContainer = document.getElementById('stripe-card-container');
            const nombreTitular = document.getElementById('nombre_titular');

            // Mostrar campos de tarjeta autom√°ticamente (es el √∫nico m√©todo disponible)
            if (tarjetaCampos) tarjetaCampos.style.display = 'block';
            if (stripeCardContainer) stripeCardContainer.style.display = 'block';
            if (nombreTitular) nombreTitular.required = true;

            // Formatear n√∫mero de tarjeta
            const numeroTarjeta = document.getElementById('numero_tarjeta');
            if (numeroTarjeta) {
                numeroTarjeta.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\s/g, '').replace(/[^0-9]/gi, '');
                    let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
                    e.target.value = formattedValue;
                });
            }

            // Formatear fecha de vencimiento
            const fechaVencimiento = document.getElementById('fecha_vencimiento');
            if (fechaVencimiento) {
                fechaVencimiento.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length >= 2) {
                        value = value.substring(0, 2) + '/' + value.substring(2, 4);
                    }
                    e.target.value = value;
                });
            }

            // Solo n√∫meros para CVV
            const cvv = document.getElementById('cvv');
            if (cvv) {
                cvv.addEventListener('input', function(e) {
                    e.target.value = e.target.value.replace(/[^0-9]/g, '');
                });
            }
        });

        // Auto-dismiss flash messages
        const flashMessages = document.querySelectorAll('.flash-message');
        flashMessages.forEach(function(message) {
            setTimeout(function() {
                message.classList.add('slide-out');
                
                // Remove element after animation completes
                setTimeout(function() {
                    message.remove();
                }, 300); // Match animation duration
            }, 4000);
            
            // Optional: Add click to dismiss
            message.addEventListener('click', function() {
                message.classList.add('slide-out');
                setTimeout(function() {
                    message.remove();
                }, 300);
            });
            
            // Add cursor pointer to indicate clickable
            message.style.cursor = 'pointer';
        });

        // Mostrar campos de Stripe autom√°ticamente (solo hay m√©todo de tarjeta)
        const stripeCardContainer = document.getElementById('stripe-card-container');
        if (stripeCardContainer) {
            stripeCardContainer.style.display = 'block';
        }
    </script>

    <!-- Scripts de Stripe -->
    <script src="https://js.stripe.com/v3/"></script>
    <script src="{{ url_for('static', filename='js/stripe-professional.js') }}"></script>

</body>
</html>


