rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Función helper para verificar si el usuario es administrador
    function esAdministrador() {
      return request.auth != null &&
             exists(/databases/$(database)/documents/usuarios/$(request.auth.uid)) &&
             (
               get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.get('rol_activo', '') == 'administrador' ||
               get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.get('rol_activo', '') == 'Administrador' ||
               get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.get('rol_activo', '') == 'ADMINISTRADOR'
             );
    }
    
    // Reglas para la colección de usuarios
    match /usuarios/{userId} {
      // Los usuarios pueden leer su propio documento
      // También pueden leer documentos de otros usuarios (necesario para mostrar info de vendedores en productos)
      allow read: if request.auth != null;
      // Los usuarios pueden actualizar su propio documento
      // Los administradores pueden actualizar cualquier documento de usuario
      allow update: if request.auth != null && (
                       request.auth.uid == userId ||
                       esAdministrador()
                     );
      // Los usuarios pueden crear su propio documento
      // Los administradores pueden crear documentos de usuario (para aprobar solicitudes)
      allow create: if request.auth != null && (
                       request.auth.uid == userId ||
                       esAdministrador()
                     );
      // Los administradores pueden eliminar usuarios
      // En producción, preferir marcar como inactivo en lugar de eliminar
      allow delete: if request.auth != null && esAdministrador();
      // Permitir consultas (list) para buscar vendedores
      allow list: if request.auth != null;
    }
    
    // Reglas para la colección de productos
    match /productos/{productoId} {
      // Todos los usuarios autenticados pueden leer productos
      allow read: if request.auth != null;
      // Los vendedores pueden crear productos
      allow create: if request.auth != null;
      // Los vendedores pueden actualizar solo sus propios productos
      allow update: if request.auth != null && (
                       resource.data.vendedor_id == request.auth.uid ||
                       resource.data.vendedorId == request.auth.uid ||
                       resource.data.uid == request.auth.uid
                     );
      // Los vendedores pueden eliminar solo sus propios productos
      allow delete: if request.auth != null && (
                       resource.data.vendedor_id == request.auth.uid ||
                       resource.data.vendedorId == request.auth.uid ||
                       resource.data.uid == request.auth.uid
                     );
    }
    
    // Reglas para la colección de carrito
    match /carrito/{carritoId} {
      // Los usuarios pueden leer solo sus propios items del carrito
      allow read: if request.auth != null && 
                     resource.data.usuario_id == request.auth.uid;
      
      // Los usuarios pueden crear items en su carrito
      allow create: if request.auth != null && 
                       request.resource.data.usuario_id == request.auth.uid;
      
      // Los usuarios pueden actualizar solo sus propios items del carrito
      allow update: if request.auth != null && 
                       resource.data.usuario_id == request.auth.uid &&
                       request.resource.data.usuario_id == request.auth.uid;
      
      // Los usuarios pueden eliminar solo sus propios items del carrito
      allow delete: if request.auth != null && 
                       resource.data.usuario_id == request.auth.uid;
      
      // Permitir consultas (list) - las consultas con where se validan contra cada documento
      // Esto permite hacer consultas como: where('usuario_id', '==', uid)
      allow list: if request.auth != null;
    }
    
    // Reglas para la colección de ventas
    match /ventas/{ventaId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null;
    }
    
    // Reglas para la colección de comentarios
    match /comentarios/{comentarioId} {
      // Todos pueden leer comentarios activos
      allow read: if request.auth != null;
      // Los usuarios pueden crear comentarios
      allow create: if request.auth != null && 
                       request.resource.data.usuario_id == request.auth.uid;
      // Los usuarios pueden actualizar sus propios comentarios
      allow update: if request.auth != null && 
                       resource.data.usuario_id == request.auth.uid;
    }
    
    // Reglas para la colección de chats
    match /chats/{chatId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
      
      // Reglas para los mensajes dentro de cada chat
      match /messages/{messageId} {
        allow read: if request.auth != null;
        allow create: if request.auth != null;
        allow update: if request.auth != null;
        allow delete: if request.auth != null;
      }
    }
    
    // Reglas para la colección de mensajes (legacy, si existe)
    match /mensajes/{mensajeId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
    }
    
    // Reglas para solicitudes de vendedores
    match /solicitudes_vendedores/{solicitudId} {
      // Los usuarios pueden leer sus propias solicitudes
      // Los administradores pueden leer todas las solicitudes
      allow read: if request.auth != null;
      
      // Los usuarios pueden crear su propia solicitud
      // Verificar que el user_id o usuario_id coincida con el usuario autenticado
      // También verificar que el ID del documento coincida con el UID del usuario
      allow create: if request.auth != null && 
                       request.auth.uid == solicitudId &&
                       (request.resource.data.user_id == request.auth.uid ||
                        request.resource.data.usuario_id == request.auth.uid ||
                        !('user_id' in request.resource.data) && !('usuario_id' in request.resource.data));
      
      // Los usuarios pueden actualizar solo su propia solicitud
      // Los administradores pueden actualizar cualquier solicitud
      allow update: if request.auth != null && (
                       // El usuario es el dueño de la solicitud
                       (resource.data.user_id == request.auth.uid ||
                        resource.data.usuario_id == request.auth.uid ||
                        solicitudId == request.auth.uid) ||
                       // O el usuario es administrador
                       esAdministrador()
                     );
      
      // Permitir consultas (list) para administradores y usuarios buscando sus propias solicitudes
      allow list: if request.auth != null;
    }
    
    // Reglas para categorías
    match /categorias/{categoriaId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    // Reglas para códigos de recuperación de contraseña
    match /password_reset_codes/{codeId} {
      // Solo el sistema puede crear códigos (desde el backend)
      // Los usuarios pueden leer solo su propio código (por email)
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow delete: if request.auth != null;
      // No permitir actualización de códigos
      allow update: if false;
    }
    
    // Reglas para la colección de compras
    match /compras/{compraId} {
      // Los usuarios pueden leer sus propias compras
      // Los vendedores pueden leer compras que contengan sus productos
      allow read: if request.auth != null && (
                     resource.data.usuario_id == request.auth.uid ||
                     // Verificar si está en vendedores_ids
                     (resource.data.vendedores_ids != null && 
                      resource.data.vendedores_ids.hasAny([request.auth.uid]))
                   );
      
      // Los usuarios pueden crear sus propias compras
      allow create: if request.auth != null && 
                       request.resource.data.usuario_id == request.auth.uid;
      
      // Los usuarios pueden actualizar sus propias compras
      // Los vendedores pueden actualizar compras que contengan sus productos (para cambiar estado)
      // Permitir actualización si:
      // 1. Es el dueño de la compra, O
      // 2. Está en vendedores_ids (actual o en la actualización)
      allow update: if request.auth != null && (
                       resource.data.usuario_id == request.auth.uid ||
                       // Verificar si está en vendedores_ids actual
                       (resource.data.vendedores_ids != null && 
                        resource.data.vendedores_ids.hasAny([request.auth.uid])) ||
                       // Permitir si está agregando su ID a vendedores_ids en esta actualización
                       (request.resource.data.vendedores_ids != null &&
                        request.resource.data.vendedores_ids.hasAny([request.auth.uid]))
                     );
      
      // Los usuarios pueden eliminar solo sus propias compras (si está permitido)
      allow delete: if request.auth != null && 
                       resource.data.usuario_id == request.auth.uid;
      
      // Permitir consultas (list) - las consultas con where se validan contra cada documento
      allow list: if request.auth != null;
    }
    
    // Reglas para mensajes de soporte
    match /mensajes_soporte/{mensajeId} {
      // Cualquier usuario autenticado puede crear mensajes de soporte
      allow create: if request.auth != null;
      // Solo los administradores pueden leer y actualizar mensajes
      allow read, update: if request.auth != null && esAdministrador();
      // Permitir consultas (list) para administradores
      allow list: if request.auth != null && esAdministrador();
    }
    
    // Por defecto, denegar todo lo demás
    match /{document=**} {
      allow read, write: if false;
    }
  }
}